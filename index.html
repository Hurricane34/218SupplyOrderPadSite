<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>218 Supply – Order Pad</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --header-start: #7a1b1b;
      --header-end:   #1f4d32;
      --accent-main:  #9e2a2b;
      --accent-alt:   #335c67;
      --bg-app:       #0f172a;
      --card-bg:      #ffffff;
    }

    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: var(--bg-app);
      color: #111827;
    }

    /* HEADER – app-style bar */
    header {
      background: linear-gradient(90deg, var(--header-start), var(--header-end));
      color: white;
      padding: 0.9rem 1.2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      position: sticky;
      top: 0;
      z-index: 20;
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .header-left img {
      height: 44px;
      width: auto;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.35);
      background: white;
    }
    header h1 {
      margin: 0;
      font-size: 1.2rem;
      line-height: 1.2;
    }
    header h1 span {
      display: block;
      font-size: 0.75rem;
      opacity: 0.9;
      font-weight: 500;
    }

    .login-box {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: nowrap;
      font-size: 0.8rem;
    }
    .header-settings-btn {
      margin-left: 6px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.95);
      background: rgba(0,0,0,0.18);
      color: #fff;
      width: 32px;
      height: 32px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .header-signin-btn {
      padding: 6px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.95);
      background: rgba(0,0,0,0.18);
      color: #fff;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      letter-spacing: 0.02em;
    }
    .signed-in-label {
      font-size: 0.8rem;
      color: rgba(229, 231, 235, 0.96);
      font-weight: 500;
      max-width: 140px;
      text-align: right;
      line-height: 1.2;
      cursor: pointer;
    }

    /* APP CONTAINER – phone-style column */
    main {
      max-width: 520px;
      margin: 0 auto;
      padding: 14px 14px 24px;
      min-height: calc(100vh - 64px);
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .card {
      background: var(--card-bg);
      border-radius: 14px;
      box-shadow: 0 4px 10px rgba(15,23,42,0.45);
      padding: 14px 16px;
    }
    .card h2 {
      margin-top: 0;
      font-size: 1rem;
    }

    .start-card {
      padding: 0;
    }
    .start-card-button {
      display: block;
      width: 100%;
      border: none;
      background: var(--accent-main);
      color: #fff;
      border-radius: 14px;
      padding: 1.6rem 1.2rem;
      font-size: 1.15rem;
      font-weight: 600;
    }
    .start-card h2 {
      font-size: 1.25rem;
      margin-bottom: 0.6rem;
    }
    .start-card p {
      margin: 0 0 1.4rem;
      color: #4b5563;
      font-size: 0.9rem;
    }

    label {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 4px;
      font-weight: 600;
    }
    select,
    input[type="number"],
    input[type="text"],
    input[type="password"],
    input[type="email"],
    textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 0.9rem;
      background: #f9fafb;
    }

    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .row > div {
      flex: 1 1 160px;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 10px 16px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: transform 0.08s ease-out, box-shadow 0.08s ease-out, background-color 0.08s ease-out;
      font-weight: 600;
    }
    button:disabled {
      opacity: 0.55;
      cursor: not-allowed;
    }

    button:active {
      transform: translateY(1px);
      box-shadow: inset 0 2px 3px rgba(0,0,0,0.35);
      filter: brightness(0.94);
    }
    .btn-primary {
      background: var(--accent-main);
      color: white;
      width: 100%;
    }
    .btn-secondary {
      background: var(--accent-alt);
      color: white;
      width: 100%;
    }
    .btn-link {
      background: transparent;
      color: var(--accent-alt);
      padding: 4px 0;
      border-radius: 0;
      font-weight: 500;
    }
    .btn-ghost {
      background: #e5e7eb;
      color: #111827;
    }
    .btn-sm {
      padding: 6px 12px;
      font-size: 0.8rem;
      border-radius: 999px;
    }

    .muted {
      color: #6b7280;
      font-size: 0.8rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 0.85rem;
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #e5e7eb;
    }
    th {
      text-align: left;
      background: #f9fafb;
    }
    .text-right { text-align: right; }

    .hidden { display: none; }

    .page-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
    }

    /* CATEGORY GRID – tappable pills */
    .category-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px;
      margin-bottom: 12px;
    }
    .category-btn {
      border-radius: 999px;
      border: 1px solid #d1d5db;
      padding: 10px 14px;
      font-size: 0.85rem;
      background: #f9fafb;
      cursor: pointer;
      text-align: center;
      line-height: 1.3;
      word-break: break-word;
    }
    .category-btn.active {
      background: var(--accent-alt);
      border-color: var(--accent-alt);
      color: #fff;
    }

    .product-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      padding: 8px 0;
      border-bottom: 1px solid #e5e7eb;
    }
    .product-main { flex: 1 1 auto; }
    .product-name {
      font-size: 0.9rem;
      font-weight: 500;
    }
    .product-meta {
      font-size: 0.8rem;
      color: #6b7280;
      margin-top: 2px;
    }
    .product-controls {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
      min-width: 90px;
    }
    .product-controls input[type="number"] {
      width: 70px;
      padding: 4px 6px;
      font-size: 0.8rem;
    }

    /* CUSTOMER LIST PAGE */
    .customer-list {
      margin-top: 10px;
      max-height: 65vh;
      overflow-y: auto;
    }
    .customer-row {
      padding: 10px 12px;
      border-radius: 10px;
      background: #f9fafb;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      border: 1px solid #e5e7eb;
    }
    .customer-row:hover {
      background: #eef2ff;
      border-color: var(--accent-alt);
    }
    .customer-row-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .customer-row-name {
      font-size: 0.95rem;
      font-weight: 600;
    }
    .customer-row-id {
      font-size: 0.75rem;
      color: #6b7280;
    }
    .customer-row-city {
      font-size: 0.8rem;
      color: #4b5563;
      margin-left: 8px;
      white-space: nowrap;
    }

    /* MODALS – full-screen dim like an app sheet */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.75);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .modal-backdrop.hidden {
      display: none;
    }
    .modal {
      background: white;
      border-radius: 16px;
      padding: 18px 16px 14px;
      width: 94%;
      max-width: 480px;
      box-shadow: 0 20px 40px rgba(15,23,42,0.5);
      max-height: 92vh;
      overflow-y: auto;
    }
    .modal h2 {
      margin-top: 0;
      font-size: 1rem;
      margin-bottom: 6px;
    }
    .modal p {
      margin-top: 0;
      font-size: 0.82rem;
      color: #6b7280;
    }
    .modal textarea {
      width: 100%;
      min-height: 220px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.8rem;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      resize: vertical;
      box-sizing: border-box;
    }
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 10px;
    }

    .clear-order-link {
      background: none;
      border: none;
      color: #b91c1c;
      font-size: 0.8rem;
      padding: 4px 6px;
      text-decoration: underline;
      cursor: pointer;
    }

    /* MOBILE TWEAKS */
    @media (max-width: 600px) {
      header h1 {
        font-size: 1rem;
      }
      main {
        padding: 12px 10px 20px;
      }
      .card {
        padding: 14px 14px;
      }
      .btn-sm {
        padding: 6px 10px;
      }
      .page-header-row {
        flex-direction: column;
        align-items: flex-start;
      }
      .page-header-row > *:last-child {
        align-self: stretch;
        display: flex;
        justify-content: flex-end;
        gap: 6px;
      }
    }

    /* DESKTOP – relax the full-width buttons a bit */
    @media (min-width: 721px) {
      .start-card .btn-primary {
        width: 100%;
      }
      .card button.btn-primary,
      .card button.btn-secondary {
        width: auto;
      }
    }

    /* Remove card background for Start New Order */
    #startCard {
      background: none !important;
      box-shadow: none !important;
      padding: 0 !important;
      margin-top: 2rem;
      text-align: center;
    }

    #startCard .start-card-button {
      display: block;
      margin: 0 auto;
    }

    /* Make the button the actual card */
    .start-card-button {
      width: 90%;
      max-width: 420px;
      background: var(--accent-main);
      color: #fff;
      padding: 1.8rem 1rem;
      font-size: 1.4rem;
      font-weight: 700;
      border-radius: 16px;
      border: none;
    }

    /* Desktop adjustments */
    @media (min-width: 768px) {
      #startCard {
        margin-top: 3rem;
      }
      .start-card-button {
        width: 420px;
        padding: 2rem 1rem;
        font-size: 1.5rem;
      }
    }

    .order-main {
      position: relative;
    }
    .order-header-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 8px;
    }
    .order-header-label {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #6b7280;
      margin-bottom: 2px;
    }
    .order-header-customer {
      font-size: 1.1rem;
      font-weight: 600;
    }
    .order-note-row {
      margin-top: 8px;
    }
    .order-note-row label {
      display: block;
      margin-bottom: 4px;
    }
    .order-main {
      position: relative;
      padding-bottom: 90px;
    }

    .cart-box {
      background: #ffffff;
      border-radius: 14px;
      padding: 12px 12px 8px;
      margin-top: 12px;
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.35);
    }
    .cart-box-header {
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 6px;
    }
    .cart-box-body {
      border-radius: 10px;
      border: 1px dashed #d1d5db;
      min-height: 72px;
      padding: 8px;
      background: #f9fafb;
      overflow-x: auto;
      overflow-y: auto;
      max-height: 360px;
    }
    .cart-empty {
      font-size: 0.85rem;
      color: #6b7280;
    }
    .cart-box-body table {
      background: #ffffff;
    }
    .cart-box-body table th,
    .cart-box-body table td {
      font-size: 0.8rem;
    }

    .generate-section {
      margin-top: 18px;
    }

    .generate-btn {
      width: 100%;
    }

    #clearOrderBtn {
      flex: 0 0 auto;
    }

    .order-actions-row {
      margin-top: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .order-actions-row .clear-order-link {
      white-space: nowrap;
    }

    .order-add-fab {
      background: var(--accent-main);
      color: #ffffff;
      border-radius: 14px;
      padding: 1.05rem 1rem;
      font-size: 1.1rem;
      font-weight: 700;
      box-shadow: 0 12px 26px rgba(0, 0, 0, 0.45);
      border: none;
      cursor: pointer;
      display: inline-block;
      flex: 1;
    }
  </style>

  <!-- PWA manifest and meta -->
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#7a1b1b" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
</head>

<body>
  <header>
    <div class="header-left">
      <img src="Logo.PNG" alt="218 Supply logo" />
      <h1>
        218 Supply
        <span>Order Pad</span>
      </h1>
    </div>
    <div class="login-box">
      <button id="signInBtn" class="header-signin-btn">Sign In</button>
      <span id="signedInLabel" class="signed-in-label" style="display:none;"></span>
    </div>
    <button id="settingsBtn" class="header-settings-btn" aria-label="Settings">⚙</button>
  </header>

  <main>
    <div class="card start-card" id="startCard">
      <button class="btn-primary start-card-button" id="startOrderBtn">
        Start a New Order
      </button>
    </div>

    <!-- Customer selection page -->
    <div id="customerSelectPage" class="hidden card">
      <div class="page-header-row">
        <h2>Select Customer</h2>
        <button class="btn-sm btn-ghost" id="addCustomerFromListBtn">Add New Customer</button>
      </div>
      <input
        type="text"
        id="customerSearchInput"
        placeholder="Search customers..."
        aria-label="Search customers"
      />
      <div id="customerList" class="customer-list"></div>
    </div>

    <div id="orderMain" class="hidden card order-main">
      <div class="order-header-row">
        <div>
          <div class="order-header-label">Customer</div>
          <div class="order-header-customer" id="orderCustomerDisplay">
            No customer selected
          </div>
        </div>
        <button class="btn-sm btn-ghost" id="changeCustomerBtn">Change Customer</button>
        <button class="btn-sm btn-ghost" id="customerProfileBtn">Profile</button>
        <button class="btn-sm btn-ghost" id="editCustomerBtn">Edit Customer</button>
      </div>

      <div class="order-note-row">
        <label for="orderNote">Order notes</label>
        <input type="text" id="orderNote" placeholder="e.g. Leave at back door" />
      </div>

      <!-- Hidden select kept for internal logic -->
      <div style="display:none;">
        <label for="customerSelect">Customer</label>
        <select id="customerSelect">
          <option value="">-- Select customer --</option>
        </select>
      </div>

      <div class="cart-box">
        <div class="cart-box-header">Cart</div>
        <div class="cart-box-body">
          <div id="cartEmptyMsg" class="cart-empty">
            Cart is empty.
          </div>
          <div id="cartContainer" style="display:none; margin-top:0;">
            <table id="cartTable">
              <thead>
                <tr>
                  <th>Product</th>
                  <th class="text-right">Qty</th>
                  <th class="text-right">Price</th>
                  <th class="text-right">Line Total</th>
                  <th></th>
                </tr>
              </thead>
              <tbody></tbody>
              <tfoot>
                <tr>
                  <th colspan="3" class="text-right">Total</th>
                  <th class="text-right" id="orderTotalCell">$0.00</th>
                  <th></th>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>

      <div id="generateSection" class="generate-section hidden">
        <button class="btn-secondary generate-btn" id="generateSummaryBtn">
          Generate Purchase Order PDF
        </button>
      </div>

      <div class="order-actions-row">
        <button class="clear-order-link" id="clearOrderBtn">Clear Order</button>
        <button class="order-add-fab" id="goToAddItemBtn">Add New Item</button>
      </div>
    </div>

    <div id="addItemPage" class="hidden card">
      <div class="page-header-row">
        <h2>Add Item</h2>
        <div style="display:flex; gap:6px;">
          <button class="btn-sm btn-ghost" id="addProductBtn">Add New Product</button>
          <button class="btn-sm btn-ghost" id="backToOrderBtn">&larr; Back to Order</button>
        </div>
      </div>
      <p class="muted">Pick a category, then choose a product and quantity.</p>
      <div id="categoryGrid" class="category-grid"></div>
      <div id="productList"></div>
    </div>
  </main>

  <!-- Sign-in modal -->
  <div id="loginModalBackdrop" class="modal-backdrop hidden">
    <div class="modal">
      <h2>Sign In</h2>
      <p>Sign in once on this device and it will remember you.</p>
      <label for="loginUsername">Username</label>
      <input type="text" id="loginUsername" />
      <label for="loginPassword">Password</label>
      <input type="password" id="loginPassword" />
      <div class="modal-actions">
        <button class="btn-ghost btn-sm" id="cancelLoginBtn">Cancel</button>
        <button class="btn-primary btn-sm" id="confirmLoginBtn">Sign In</button>
      </div>
    </div>
  </div>

  <!-- Settings modal -->
  <div id="settingsModalBackdrop" class="modal-backdrop hidden">
    <div class="modal">
      <h2>Settings</h2>
      <p>Update your email for purchase orders or change your password on this device.</p>
      <label for="settingsUsername">Username</label>
      <input type="text" id="settingsUsername" disabled />
      <label for="settingsEmail">Email for purchase orders</label>
      <input type="email" id="settingsEmail" placeholder="you@example.com" />
      <hr style="margin:12px 0;border:none;border-top:1px solid #e5e7eb;" />
      <h3 style="margin:0 0 6px;font-size:0.9rem;">Change password</h3>
      <p class="muted" style="margin-top:0;margin-bottom:6px;">Leave blank to keep your current password.</p>
      <label for="settingsCurrentPassword">Current password</label>
      <input type="password" id="settingsCurrentPassword" />
      <label for="settingsNewPassword">New password</label>
      <input type="password" id="settingsNewPassword" />
      <label for="settingsConfirmPassword">Confirm new password</label>
      <input type="password" id="settingsConfirmPassword" />
      <div class="modal-actions">
        <button class="btn-link btn-sm" id="signOutBtn" style="margin-right:auto;color:#b91c1c;">Sign out</button>
        <button class="btn-ghost btn-sm" id="cancelSettingsBtn">Cancel</button>
        <button class="btn-primary btn-sm" id="saveSettingsBtn">Save</button>
      </div>
    </div>
  </div>

  <!-- Purchase order preview -->
  <div id="poModalBackdrop" class="modal-backdrop hidden">
    <div class="modal">
      <h2>Purchase Order</h2>
      <p>Review this purchase order, then download a PDF or send it to <strong>sales@218supply.com</strong>.</p>
      <div id="poPreviewContainer" style="width:100%;height:260px;border:1px solid #d1d5db;border-radius:8px;overflow:hidden;background:#f9fafb;">
        <iframe id="poPreviewFrame" style="width:100%;height:100%;border:0;"></iframe>
      </div>
      <div class="modal-actions">
        <button class="btn-ghost btn-sm" id="closePoModalBtn">Close</button>
        <button class="btn-secondary btn-sm" id="downloadPoBtn">Download</button>
        <button class="btn-primary btn-sm" id="emailPoBtn">Send</button>
      </div>
    </div>
  </div>

  <!-- Add customer modal -->
  <div id="customerModalBackdrop" class="modal-backdrop hidden">
    <div class="modal">
      <h2>Add New Customer</h2>
      <p>New customers are saved on this device. Also add them later to your master CSV to keep them permanently.</p>
      <label for="newCustomerName">Customer Name</label>
      <input type="text" id="newCustomerName" />
      <label for="newCustomerId">Customer ID (optional)</label>
      <input type="text" id="newCustomerId" placeholder="e.g. CUST-0100" />
      <div class="modal-actions">
        <button class="btn-ghost btn-sm" id="cancelCustomerBtn">Cancel</button>
        <button class="btn-primary btn-sm" id="saveCustomerBtn">Save Customer</button>
      </div>
    </div>
  </div>

  <!-- Edit customer modal -->
  <div id="customerEditModalBackdrop" class="modal-backdrop hidden">
    <div class="modal">
      <h2>Edit Customer</h2>
      <p>Update this customer's details on this device.</p>
      <label for="editCustomerName">Customer Name</label>
      <input type="text" id="editCustomerName" />
      <label for="editCustomerId">Customer ID</label>
      <input type="text" id="editCustomerId" />
      <label for="editCustomerCity">City</label>
      <input type="text" id="editCustomerCity" />
      <label for="editCustomerState">State</label>
      <input type="text" id="editCustomerState" />
      <div class="modal-actions">
        <button class="btn-ghost btn-sm" id="cancelEditCustomerBtn">Cancel</button>
        <button class="btn-primary btn-sm" id="saveEditCustomerBtn">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- Customer profile modal -->
  <div id="customerProfileModalBackdrop" class="modal-backdrop hidden">
    <div class="modal">
      <h2>Customer Profile</h2>
      <p>View and update this customer's profile and see their order history on this device.</p>

      <div id="customerProfileSummary" class="muted" style="margin-bottom:8px;"></div>

      <h3 style="margin:8px 0 4px;font-size:0.9rem;">Contact & Details</h3>
      <label for="profileContactName">Contact Name</label>
      <input type="text" id="profileContactName" />

      <label for="profilePhone">Phone</label>
      <input type="text" id="profilePhone" />

      <label for="profileEmail">Email</label>
      <input type="email" id="profileEmail" />

      <label for="profileNotes">Notes</label>
      <textarea id="profileNotes" style="min-height:80px;"></textarea>

      <div class="row" style="margin-top:8px;">
        <div>
          <label for="profilePriceLevel">Price Level</label>
          <input type="text" id="profilePriceLevel" placeholder="e.g. Standard, Bar, VIP" />
        </div>
        <div style="display:flex;align-items:center;gap:6px;margin-top:22px;">
          <input type="checkbox" id="profileTaxExempt" style="width:auto;" />
          <label for="profileTaxExempt" style="margin:0;font-weight:500;">Tax Exempt</label>
        </div>
      </div>

      <h3 style="margin:10px 0 4px;font-size:0.9rem;">Address</h3>
      <label for="billingStreet">Street</label>
      <input type="text" id="billingStreet" />
      <div class="row">
        <div>
          <label for="billingCity">City</label>
          <input type="text" id="billingCity" />
        </div>
        <div>
          <label for="billingState">State</label>
          <input type="text" id="billingState" />
        </div>
        <div>
          <label for="billingZip">ZIP</label>
          <input type="text" id="billingZip" />
        </div>
      </div>

      <label for="profileLabels" style="margin-top:8px;">Labels (comma-separated)</label>
      <input type="text" id="profileLabels" placeholder="e.g. bar, downtown, late-night" />

      <h3 style="margin:10px 0 4px;font-size:0.9rem;">Order History</h3>
      <div id="customerProfileOrders" style="max-height:180px;overflow-y:auto;border:1px solid #e5e7eb;border-radius:8px;padding:6px 8px;background:#f9fafb;font-size:0.8rem;">
        <!-- filled by script -->
      </div>

      <div class="modal-actions">
        <button class="btn-ghost btn-sm" id="closeCustomerProfileBtn">Close</button>
        <button class="btn-primary btn-sm" id="saveCustomerProfileBtn">Save Profile</button>
      </div>
    </div>
  </div>

  <!-- Add product modal -->
  <div id="productModalBackdrop" class="modal-backdrop hidden">
    <div class="modal">
      <h2>Add New Product</h2>
      <p>New products are saved on this device. Also add them later to your products CSV.</p>
      <label for="newProdName">Product Name</label>
      <input type="text" id="newProdName" />
      <label for="newProdSku">SKU</label>
      <input type="text" id="newProdSku" />
      <label for="newProdCategory">Category (e.g. PAPER, BAG, CUP)</label>
      <input type="text" id="newProdCategory" />
      <label for="newProdPack">Pack Size (e.g. 96/CS)</label>
      <input type="text" id="newProdPack" />
      <label for="newProdPrice">Price (per case)</label>
      <input type="number" step="0.01" id="newProdPrice" />
      <div class="modal-actions">
        <button class="btn-ghost btn-sm" id="cancelProductBtn">Cancel</button>
        <button class="btn-primary btn-sm" id="saveProductBtn">Save Product</button>
      </div>
    </div>
  </div>

  <!-- libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="data.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const startCard              = document.getElementById("startCard");
      const startOrderBtn          = document.getElementById("startOrderBtn");
      const orderMain              = document.getElementById("orderMain");
      const addItemPage            = document.getElementById("addItemPage");
      const customerSelectPage     = document.getElementById("customerSelectPage");
      const customerList           = document.getElementById("customerList");
      const customerSearchInput    = document.getElementById("customerSearchInput");
      const addCustomerFromListBtn = document.getElementById("addCustomerFromListBtn");

      const customerSelect         = document.getElementById("customerSelect");
      const orderNoteInput         = document.getElementById("orderNote");
      const signInBtn              = document.getElementById("signInBtn");
      const signedInLabel          = document.getElementById("signedInLabel");
      const orderCustomerDisplay   = document.getElementById("orderCustomerDisplay");
      const changeCustomerBtn      = document.getElementById("changeCustomerBtn");
      const editCustomerBtn        = document.getElementById("editCustomerBtn");
      const customerProfileBtn     = document.getElementById("customerProfileBtn");
      const addItemBtn             = document.getElementById("goToAddItemBtn");
      const backToOrderBtn         = document.getElementById("backToOrderBtn");
      const categoryGrid           = document.getElementById("categoryGrid");
      const productList            = document.getElementById("productList");
      const cartEmptyMsg           = document.getElementById("cartEmptyMsg");
      const cartContainer          = document.getElementById("cartContainer");
      const cartTableBody          = document.querySelector("#cartTable tbody");
      const orderTotalCell         = document.getElementById("orderTotalCell");
      const generateSection        = document.getElementById("generateSection");
      const generateSummaryBtn     = document.getElementById("generateSummaryBtn");
      const clearOrderBtn          = document.getElementById("clearOrderBtn");

      const loginModalBackdrop    = document.getElementById("loginModalBackdrop");
      const loginUsernameInput    = document.getElementById("loginUsername");
      const loginPasswordInput    = document.getElementById("loginPassword");
      const cancelLoginBtn        = document.getElementById("cancelLoginBtn");
      const confirmLoginBtn       = document.getElementById("confirmLoginBtn");

      const settingsBtn              = document.getElementById("settingsBtn");
      const settingsModalBackdrop    = document.getElementById("settingsModalBackdrop");
      const settingsUsernameInput    = document.getElementById("settingsUsername");
      const settingsEmailInput       = document.getElementById("settingsEmail");
      const settingsCurrentPassword  = document.getElementById("settingsCurrentPassword");
      const settingsNewPassword      = document.getElementById("settingsNewPassword");
      const settingsConfirmPassword  = document.getElementById("settingsConfirmPassword");
      const cancelSettingsBtn        = document.getElementById("cancelSettingsBtn");
      const saveSettingsBtn          = document.getElementById("saveSettingsBtn");
      const signOutBtn               = document.getElementById("signOutBtn");

      const poModalBackdrop   = document.getElementById("poModalBackdrop");
      const poPreviewFrame    = document.getElementById("poPreviewFrame");
      const closePoModalBtn   = document.getElementById("closePoModalBtn");
      const downloadPoBtn     = document.getElementById("downloadPoBtn");
      const emailPoBtn        = document.getElementById("emailPoBtn");

      const customerModalBackdrop   = document.getElementById("customerModalBackdrop");
      const newCustomerNameInput    = document.getElementById("newCustomerName");
      const newCustomerIdInput      = document.getElementById("newCustomerId");
      const cancelCustomerBtn       = document.getElementById("cancelCustomerBtn");
      const saveCustomerBtn         = document.getElementById("saveCustomerBtn");

      const customerEditModalBackdrop = document.getElementById("customerEditModalBackdrop");
      const editCustomerNameInput     = document.getElementById("editCustomerName");
      const editCustomerIdInput       = document.getElementById("editCustomerId");
      const editCustomerCityInput     = document.getElementById("editCustomerCity");
      const editCustomerStateInput    = document.getElementById("editCustomerState");
      const cancelEditCustomerBtn     = document.getElementById("cancelEditCustomerBtn");
      const saveEditCustomerBtn       = document.getElementById("saveEditCustomerBtn");

      const customerProfileModalBackdrop = document.getElementById("customerProfileModalBackdrop");
      const customerProfileSummary       = document.getElementById("customerProfileSummary");
      const profileContactNameInput      = document.getElementById("profileContactName");
      const profilePhoneInput            = document.getElementById("profilePhone");
      const profileEmailInput            = document.getElementById("profileEmail");
      const profileNotesInput            = document.getElementById("profileNotes");
      const profilePriceLevelInput       = document.getElementById("profilePriceLevel");
      const profileTaxExemptInput        = document.getElementById("profileTaxExempt");
      const billingStreetInput           = document.getElementById("billingStreet");
      const billingCityInput             = document.getElementById("billingCity");
      const billingStateInput            = document.getElementById("billingState");
      const billingZipInput              = document.getElementById("billingZip");
      const profileLabelsInput           = document.getElementById("profileLabels");
      const customerProfileOrdersEl      = document.getElementById("customerProfileOrders");
      const closeCustomerProfileBtn      = document.getElementById("closeCustomerProfileBtn");
      const saveCustomerProfileBtn       = document.getElementById("saveCustomerProfileBtn");

      const productModalBackdrop  = document.getElementById("productModalBackdrop");
      const newProdNameInput      = document.getElementById("newProdName");
      const newProdSkuInput       = document.getElementById("newProdSku");
      const newProdCategoryInput  = document.getElementById("newProdCategory");
      const newProdPackInput      = document.getElementById("newProdPack");
      const newProdPriceInput     = document.getElementById("newProdPrice");
      const cancelProductBtn      = document.getElementById("cancelProductBtn");
      const saveProductBtn        = document.getElementById("saveProductBtn");

      const addCustomerBtn = document.getElementById("addCustomerBtn"); // optional header button

      let currentUser = null;
      let currentUserProfile = null;
      let userProfiles = {};
      let cartItems = [];
      let customerProfiles = {};
      let editingCustomerObj = null;
      let currentProfileCustomerId = null;

      // ---- helpers ----
      function formatMoney(n) {
        return "$" + n.toFixed(2);
      }

      function loadUserProfiles() {
        try {
          const raw = localStorage.getItem("orderpadUserProfiles");
          if (raw) {
            const parsed = JSON.parse(raw);
            if (parsed && typeof parsed === "object") {
              userProfiles = parsed;
            }
          }
        } catch (e) {
          console.warn("Could not load user profiles", e);
          userProfiles = {};
        }
      }

      function saveUserProfiles() {
        try {
          localStorage.setItem("orderpadUserProfiles", JSON.stringify(userProfiles));
        } catch (e) {
          console.warn("Could not save user profiles", e);
        }
      }

      function loadCustomerProfiles() {
        try {
          const raw = localStorage.getItem("orderpadCustomerProfiles");
          if (raw) {
            const parsed = JSON.parse(raw);
            if (parsed && typeof parsed === "object") {
              customerProfiles = parsed;
            }
          }
        } catch (e) {
          console.warn("Could not load customer profiles", e);
          customerProfiles = {};
        }
      }

      function saveCustomerProfiles() {
        try {
          localStorage.setItem("orderpadCustomerProfiles", JSON.stringify(customerProfiles));
        } catch (e) {
          console.warn("Could not save customer profiles", e);
        }
      }

      function showSignedInState() {
        if (currentUser && currentUserProfile) {
          signInBtn.style.display = "none";
          signedInLabel.style.display = "inline";
          signedInLabel.textContent = `Signed in as ${currentUserProfile.username}`;
        } else {
          signInBtn.style.display = "inline-block";
          signedInLabel.style.display = "none";
          signedInLabel.textContent = "";
        }
      }

      function loadLocalData() {
        try {
          loadUserProfiles();
          loadCustomerProfiles();
          const storedUser = localStorage.getItem("orderpadUser") || localStorage.getItem("orderpadCurrentUser");
          if (storedUser) {
            currentUser = storedUser;
            currentUserProfile = userProfiles[storedUser] || { username: storedUser, email: "", password: "" };
            userProfiles[storedUser] = currentUserProfile;
          }
        } catch (e) {
          console.warn("LocalStorage not available", e);
          userProfiles = {};
        }

        showSignedInState();

        // load extra customers/products saved on this device
        try {
          const extraCust = localStorage.getItem("orderpadExtraCustomers");
          if (extraCust) {
            const parsed = JSON.parse(extraCust);
            if (Array.isArray(parsed)) window.customers.push(...parsed);
          }
        } catch {}

        try {
          const extraProd = localStorage.getItem("orderpadExtraProducts");
          if (extraProd) {
            const parsed = JSON.parse(extraProd);
            if (Array.isArray(parsed)) window.products.push(...parsed);
          }
        } catch {}

        // Seed CHIPS products (bag prices + one mixed case)
        window.products = window.products || [];
        const chipSeedProducts = [
          { sku: "CHP-FL-ORIG",  name: "Frito Original",                  category: "CHIPS", subcategory: "FRITO LAY", packSize: "64/cs • 2 oz",    price: 1.00 },
          { sku: "CHP-FL-CHILI", name: "Frito Chili Cheese",             category: "CHIPS", subcategory: "FRITO LAY", packSize: "64/cs • 2 oz",    price: 1.00 },
          { sku: "CHP-FL-HBBQ",  name: "Frito HBBQ Twist",               category: "CHIPS", subcategory: "FRITO LAY", packSize: "64/cs • 2 oz",    price: 1.00 },
          { sku: "CHP-FL-FUNY",  name: "Funyuns",                        category: "CHIPS", subcategory: "FRITO LAY", packSize: "64/cs • 1.75 oz", price: 1.00 },
          { sku: "CHP-FL-NDOR",  name: "Nacho Doritos",                  category: "CHIPS", subcategory: "FRITO LAY", packSize: "64/cs • 1.75 oz", price: 1.00 },
          { sku: "CHP-FL-CDOR",  name: "Cool Ranch Doritos",            category: "CHIPS", subcategory: "FRITO LAY", packSize: "64/cs • 1.75 oz", price: 1.00 },
          { sku: "CHP-FL-CHET",  name: "Cheetos",                        category: "CHIPS", subcategory: "FRITO LAY", packSize: "64/cs • 1.75 oz", price: 1.00 },
          { sku: "CHP-FL-PRET",  name: "Rold Gold Pretzels Tiny Twists", category: "CHIPS", subcategory: "FRITO LAY", packSize: "64/cs • 1.75 oz", price: 1.00 },
          { sku: "CHP-FL-RUFF",  name: "Ruffles Cheddar & Sour Cream",   category: "CHIPS", subcategory: "FRITO LAY", packSize: "64/cs • 1.75 oz", price: 1.00 },

          { sku: "CHP-OD-ORIG",  name: "Old Dutch Original Potato Chips", category: "CHIPS", subcategory: "OLD DUTCH", packSize: "25/cs • 2 oz",   price: 1.00 },
          { sku: "CHP-OD-SCNO",  name: "Old Dutch Sour Cream & Onion",    category: "CHIPS", subcategory: "OLD DUTCH", packSize: "25/cs • 2 oz",   price: 1.00 },
          { sku: "CHP-OD-BBQ",   name: "Old Dutch Barbeque",              category: "CHIPS", subcategory: "OLD DUTCH", packSize: "25/cs • 2 oz",   price: 1.00 },
          { sku: "CHP-OD-OAG",   name: "Old Dutch Onion & Garlic",        category: "CHIPS", subcategory: "OLD DUTCH", packSize: "25/cs • 2 oz",   price: 1.00 },
          { sku: "CHP-OD-DILL",  name: "Old Dutch Dill Pickle",           category: "CHIPS", subcategory: "OLD DUTCH", packSize: "25/cs • 2 oz",   price: 1.00 },

          { sku: "CHP-TGIF-BAC", name: "TGIF Cheddar Bacon Skins",        category: "CHIPS", subcategory: "INVENTURE", packSize: "55/cs",          price: 1.00 },
          { sku: "CHP-TGIF-SCCH",name: "TGIF Sour Cream & Cheddar Skins", category: "CHIPS", subcategory: "INVENTURE", packSize: "55/cs",          price: 1.00 },

          { sku: "CHP-CHEEZ-ORIG", name: "Cheez-It Original",             category: "CHIPS", subcategory: "GENERAL MILLS/KEEBLER", packSize: "60/cs • 1.75 oz", price: 1.00 },
          { sku: "CHP-CHEEZ-JACK", name: "Cheez-It Cheddar Jack",         category: "CHIPS", subcategory: "GENERAL MILLS/KEEBLER", packSize: "60/cs • 1.75 oz", price: 1.00 },

          { sku: "CHP-SAL-ROUND", name: "Salista's Tortilla Rounds",      category: "CHIPS", subcategory: "SALISTA'S", packSize: "50/cs • 1 oz",   price: 1.00 },
          { sku: "CHP-SAL-SPICY", name: "Spicy Salista's Tortilla Rounds",category: "CHIPS", subcategory: "SALISTA'S", packSize: "50/cs • 1 oz",   price: 1.00 },

          { sku: "CHP-EAR-125-CHED",  name: "Earl's Cheddar Cheese Popcorn ($1.25 SRP)", category: "CHIPS", subcategory: "EARL'S $1.25", packSize: "36/cs • ~1.75 oz", price: 0.83 },
          { sku: "CHP-EAR-125-CARM",  name: "Earl's Caramel Popcorn ($1.25 SRP)",        category: "CHIPS", subcategory: "EARL'S $1.25", packSize: "36/cs • ~1.75 oz", price: 0.83 },
          { sku: "CHP-EAR-125-PUFF",  name: "Earl's Cheese Puffs ($1.25 SRP)",           category: "CHIPS", subcategory: "EARL'S $1.25", packSize: "36/cs • ~1.75 oz", price: 0.83 },

          { sku: "CHP-EAR-159-CHED",  name: "Earl's Cheese Popcorn ($1.59 SRP)",         category: "CHIPS", subcategory: "EARL'S $1.59", packSize: "12/cs • 5.5 oz",  price: 1.06 },
          { sku: "CHP-EAR-159-CARM",  name: "Earl's Caramel Corn ($1.59 SRP)",           category: "CHIPS", subcategory: "EARL'S $1.59", packSize: "18/cs • 6 oz",    price: 1.06 },
          { sku: "CHP-EAR-159-TRIP",  name: "Earl's Triple Treat Popcorn ($1.59 SRP)",   category: "CHIPS", subcategory: "EARL'S $1.59", packSize: "24/cs",           price: 1.06 },

          { sku: "CHP-OD-219-BSPIN",  name: "Old Dutch Butter Spindle Pretzels ($2.19 SRP)", category: "CHIPS", subcategory: "OLD DUTCH $2.19", packSize: "25/cs • 4 oz", price: 1.55 },

          // Mixed case – sold as a 30-bag case for $30
          { sku: "CHP-MIX-30CASE", name: "Mixed Chips Case – 30 bags", category: "CHIPS", subcategory: "MIXED", packSize: "30 bags/case", price: 30.00 }
        ];

        chipSeedProducts.forEach(seed => {
          const exists = (window.products || []).some(p => p.sku === seed.sku);
          if (!exists) window.products.push(seed);
        });

        try {
          loadCustomerEditsAndApply();
        } catch (e) {
          console.warn("Unable to apply customer edits", e);
        }
      }

      function saveExtraCustomers(customers) {
        try {
          localStorage.setItem("orderpadExtraCustomers", JSON.stringify(customers));
        } catch {}
      }

      function saveExtraProducts(products) {
        try {
          localStorage.setItem("orderpadExtraProducts", JSON.stringify(products));
        } catch {}
      }

      const CUSTOMER_EDITS_KEY = "orderpadCustomerEdits";

      let customerEdits = {};

      function loadCustomerEditsAndApply() {
        customerEdits = {};
        try {
          const stored = localStorage.getItem(CUSTOMER_EDITS_KEY);
          if (stored) {
            const parsed = JSON.parse(stored);
            if (parsed && typeof parsed === "object") {
              customerEdits = parsed;
            }
          }
        } catch (e) {
          console.warn("Unable to load customer edits", e);
          customerEdits = {};
        }

        if (Array.isArray(window.customers)) {
          window.customers.forEach((c) => {
            const edit = customerEdits[c.id];
            if (edit) {
              if (edit.name)  c.name  = edit.name;
              if (edit.city)  c.city  = edit.city;
              if (edit.state) c.state = edit.state;
            }
          });
        }
      }

      function saveCustomerEditFor(id, data) {
        if (!id) return;
        if (!customerEdits || typeof customerEdits !== "object") {
          customerEdits = {};
        }
        const existing = customerEdits[id] || {};
        customerEdits[id] = Object.assign({}, existing, data || {});
        try {
          localStorage.setItem(CUSTOMER_EDITS_KEY, JSON.stringify(customerEdits));
        } catch (e) {
          console.warn("Unable to save customer edits", e);
        }
      }

      function getSortedCustomers() {
        return (window.customers || []).slice().sort((a, b) =>
          (a.name || "").localeCompare(b.name || "")
        );
      }

      function populateCustomers() {
        const sorted = getSortedCustomers();
        customerSelect.innerHTML = '<option value="">-- Select customer --</option>';
        for (const c of sorted) {
          const opt = document.createElement("option");
          opt.value = c.id;
          opt.textContent = c.name;
          customerSelect.appendChild(opt);
        }
      }

      function renderCustomerList() {
        const listEl = document.getElementById("customerList");
        if (!listEl) return;

        const search = (customerSearchInput.value || "").toLowerCase();
        const all = window.customers || [];
        listEl.innerHTML = "";

        const filtered = all.filter((c) => {
          const name = (c.name || "").toLowerCase();
          const id = (c.id || "").toLowerCase();
          const city = (c.city || "").toLowerCase();
          const state = (c.state || "").toLowerCase();
          return (
            !search ||
            name.includes(search) ||
            id.includes(search) ||
            city.includes(search) ||
            state.includes(search)
          );
        });

        if (!filtered.length) {
          const empty = document.createElement("div");
          empty.textContent = "No customers found.";
          empty.className = "muted";
          listEl.appendChild(empty);
          return;
        }

        filtered.forEach((c) => {
          const row = document.createElement("div");
          row.className = "customer-row";
          row.dataset.customerId = c.id;

          const main = document.createElement("div");
          main.className = "customer-row-main";

          const nameEl = document.createElement("div");
          nameEl.className = "customer-row-name";
          nameEl.textContent = c.name || c.id;

          main.appendChild(nameEl);
          row.appendChild(main);

          const cityLabel =
            (c && c.city ? c.city : "") +
            (c && c.state ? (c.city ? ", " : "") + c.state : "");

          if (cityLabel) {
            const cityEl = document.createElement("div");
            cityEl.className = "customer-row-city";
            cityEl.textContent = cityLabel;
            row.appendChild(cityEl);
          }

          row.addEventListener("click", () => {
            selectCustomerAndGoToOrder(c.id);
          });

          listEl.appendChild(row);
        });
      }

      function selectCustomerAndGoToOrder(customerId) {
        customerSelect.value = customerId || "";
        const hasCustomer = !!customerSelect.value;
        addItemBtn.disabled = !hasCustomer;
        generateSummaryBtn.disabled = !hasCustomer;

        // Update visible customer name
        if (orderCustomerDisplay && window.customers) {
          const found = (window.customers || []).find(c => c.id === customerId);
          orderCustomerDisplay.textContent = found && found.name ? found.name : "Customer selected";
        }

        customerSelectPage.classList.add("hidden");
        orderMain.classList.remove("hidden");
        orderNoteInput.focus();
      }


      const CATEGORY_ORDER = [
        "BAG",
        "CAN LINER",
        "BAR",
        "FILM & FOIL",
        "CUP",
        "CONTAINER",
        "CUTLERY",
        "FOOD TRAY",
        "GLOVE",
        "CLEAN",
        "PAPER",
        "PLATE",
        "CHIPS",
        "MEAT SNACKS",
        "BEVERAGE",
        "CANDY"
      ];

      function normalizeCategory(raw) {
        if (!raw) return "OTHER";
        const c = String(raw).trim().toUpperCase();

        if (["BAG", "BAGS", "VAC PAC BAGS", "VAC PAC"].includes(c)) return "BAG";

        if (["CAN LINER", "CANLINER", "CAN LINERS", "CANLINERS", "CAN LINER ", "CANLINER "].includes(c))
          return "CAN LINER";

        if (["BAR", "BAR SUPPLIES", "BAR STUFF"].includes(c))
          return "BAR";

        if (["MEAT SNACKS", "MEAT SNACK", "MEAT STICKS", "MEAT STICK", "JERKY", "BEEF JERKY"].includes(c))
          return "MEAT SNACKS";

        if (["FILM", "FOIL", "FREEZER", "FREEZER PAPER", "WRAP", "WRAPS", "FOOD WRAP"].includes(c))
          return "FILM & FOIL";

        if (["CUP", "CUPS", "BOWL", "BOWLS", "DART FOAM", "SOUFFLE", "SOUFFLÉ"].includes(c))
          return "CUP";

        if (["CONTAINER", "CONTAINERS"].includes(c))
          return "CONTAINER";

        if (["CUTLERY", "UTENSIL", "UTENSILS"].includes(c))
          return "CUTLERY";

        if (["FOOD TRAY", "TRAY", "MEAT TRAY", "MEAT TRAYS"].includes(c))
          return "FOOD TRAY";

        if (["GLOVE", "GLOVES"].includes(c))
          return "GLOVE";

        if (["CLEAN", "CLEANING", "CHEMICAL", "CHEMICALS"].includes(c))
          return "CLEAN";

        if (["PAPER", "NAPKIN", "NAPKINS", "TOILET TISSUE", "TISSUE", "TOWEL", "TOWELS"].includes(c))
          return "PAPER";

        if (["PLATE", "PLATES"].includes(c))
          return "PLATE";

        if (["STRAW", "STRAWS", "STIRRER", "STIRRERS"].includes(c))
          return "BAR";

        if (["CHIP", "CHIPS"].includes(c))
          return "CHIPS";

        if (["BEVERAGE", "BEVERAGES", "DRINK", "DRINKS", "SODA", "POP"].includes(c))
          return "BEVERAGE";

        if (["CANDY", "SWEETS"].includes(c))
          return "CANDY";

        return c; // default to normalized uppercase
      }

      function buildCategories() {
        categoryGrid.innerHTML = "";
        const catsSet = new Set();
        (window.products || []).forEach(p => {
          const norm = normalizeCategory(p.category || "OTHER");
          catsSet.add(norm);
        });
        const cats = CATEGORY_ORDER.filter(c => catsSet.has(c));
        cats.forEach(cat => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "category-btn";
          btn.textContent = cat;
          btn.addEventListener("click", () => {
            document
              .querySelectorAll(".category-btn")
              .forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
            showProductsForCategory(cat);
          });
          categoryGrid.appendChild(btn);
        });
      }

      function showProductsForCategory(category) {
        productList.innerHTML = "";
        const filtered = (window.products || [])
          .filter(p => normalizeCategory(p.category || "OTHER") === category)
          .sort((a, b) => a.name.localeCompare(b.name));

        if (!filtered.length) {
          const p = document.createElement("p");
          p.className = "muted";
          p.textContent = "No products in this category yet.";
          productList.appendChild(p);
          return;
        }

        filtered.forEach(prod => {
          const row = document.createElement("div");
          row.className = "product-row";

          const main = document.createElement("div");
          main.className = "product-main";

          const nameEl = document.createElement("div");
          nameEl.className = "product-name";
          let displayName = prod.name || "";
          if (category === "MEAT SNACKS") {
            const price = Number(prod.price || 0);
            const brand = Math.abs(price - 18) < 0.01 ? "Old World Meats" : "Kickass";
            displayName = brand + " - " + displayName;
          }
          nameEl.textContent = displayName;

          const metaEl = document.createElement("div");
          metaEl.className = "product-meta";
          metaEl.textContent = `SKU ${prod.sku} • ${prod.packSize || ""} • ${formatMoney(prod.price || 0)}`;

          main.appendChild(nameEl);
          main.appendChild(metaEl);

          const controls = document.createElement("div");
          controls.className = "product-controls";

          const qtyInput = document.createElement("input");
          qtyInput.type = "number";
          qtyInput.min = "1";
          qtyInput.step = "1";
          qtyInput.value = "1";

          const addBtn = document.createElement("button");
          addBtn.type = "button";
          addBtn.className = "btn-primary btn-sm";
          addBtn.textContent = "Add";

          addBtn.addEventListener("click", () => {
            const qty = parseInt(qtyInput.value, 10) || 0;
            if (qty <= 0) {
              alert("Quantity must be at least 1.");
              return;
            }
            addItemToCart(prod, qty);
            qtyInput.value = "1";
          });

          controls.appendChild(qtyInput);
          controls.appendChild(addBtn);

          row.appendChild(main);
          row.appendChild(controls);
          productList.appendChild(row);
        });
      }

      function addItemToCart(prod, qty) {
        const existing = cartItems.find(item => item.sku === prod.sku);
        if (existing) {
          existing.qty += qty;
        } else {
          cartItems.push({
            sku: prod.sku,
            name: prod.name,
            packSize: prod.packSize || "",
            price: prod.price || 0,
            qty
          });
        }
        renderCart();
      }

      function renderCart() {
        const cartTableBody = document.querySelector("#cartTable tbody");
        const cartContainer = document.getElementById("cartContainer");
        const cartEmptyMsg = document.getElementById("cartEmptyMsg");
        const orderTotalCell = document.getElementById("orderTotalCell");
        const generateSection = document.getElementById("generateSection");

        cartTableBody.innerHTML = "";

        if (cartItems.length === 0) {
          cartContainer.style.display = "none";
          cartEmptyMsg.style.display = "block";
          orderTotalCell.textContent = "$0.00";
          generateSection.classList.add("hidden");
          return;
        }

        cartContainer.style.display = "block";
        cartEmptyMsg.style.display = "none";

        cartItems.forEach((item, index) => {
          const tr = document.createElement("tr");
          const tdProd = document.createElement("td");
          const tdQty = document.createElement("td");
          const tdPrice = document.createElement("td");
          const tdLine = document.createElement("td");
          const tdRemove = document.createElement("td");

          tdProd.textContent = `${item.sku} – ${item.name}`;
          tdQty.textContent = item.qty;
          tdQty.className = "text-right";
          tdPrice.textContent = formatMoney(item.price);
          tdPrice.className = "text-right";

          const priceCents = Math.round((item.price || 0) * 100);
          const lineTotalCents = priceCents * item.qty;
          const lineTotal = lineTotalCents / 100;
          tdLine.textContent = formatMoney(lineTotal);
          tdLine.className = "text-right";

          const removeBtn = document.createElement("button");
          removeBtn.textContent = "×";
          removeBtn.className = "btn-sm btn-ghost";
          removeBtn.addEventListener("click", () => {
            cartItems.splice(index, 1);
            renderCart();
          });
          tdRemove.appendChild(removeBtn);
          tdRemove.className = "text-right";

          tr.appendChild(tdProd);
          tr.appendChild(tdQty);
          tr.appendChild(tdPrice);
          tr.appendChild(tdLine);
          tr.appendChild(tdRemove);

          cartTableBody.appendChild(tr);
        });

        const totals = computeTotals();
        orderTotalCell.textContent = formatMoney(totals.subtotal);
        generateSection.classList.remove("hidden");
      }

      function clearOrder() {
        if (!cartItems.length && !customerSelect.value && !orderNoteInput.value) return;
        if (!confirm("Clear this order?")) return;
        cartItems = [];
        renderCart();
        customerSelect.value = "";
        orderCustomerDisplay.textContent = "No customer selected";
        orderNoteInput.value = "";
        addItemBtn.disabled = true;
        generateSummaryBtn.disabled = true;
      }

      function computeTotals() {
        let subtotalCents = 0;

        cartItems.forEach((item) => {
          const priceCents = Math.round((item.price || 0) * 100);
          const lineTotalCents = priceCents * item.qty;
          subtotalCents += lineTotalCents;
        });

        const taxRate = 0.07375;
        const taxCents = Math.round(subtotalCents * taxRate);
        const grandCents = subtotalCents + taxCents;

        return {
          subtotal: subtotalCents / 100,
          taxAmount: taxCents / 100,
          grandTotal: grandCents / 100
        };
      }

      function buildPoText() {
        const customerId = customerSelect.value || "";
        const customerName =
          (window.customers || []).find(c => c.id === customerId)?.name || "";
        const note = orderNoteInput.value || "";
        const now = new Date();
        const dateStr = now.toISOString().slice(0, 10);

        const headerLines = [
          "218 SUPPLY – PURCHASE ORDER",
          "----------------------------------------",
          "Date: " + dateStr,
          "Salesperson: " + (currentUser || "Not signed in"),
          "Salesperson Email: " + ((currentUserProfile && currentUserProfile.email) || "Not set"),
          "Customer: " + (customerName || "N/A") + (customerId ? " (" + customerId + ")" : ""),
          note ? "Notes: " + note : "",
          ""
        ].filter(Boolean);

        const itemLines = cartItems.map((item, idx) => {
          return (
            (idx + 1) + ". " +
            item.name +
            " | SKU " + item.sku +
            " | " + item.packSize +
            " | Qty " + item.qty +
            " @ " + formatMoney(item.price) +
            " = " + formatMoney(item.price * item.qty)
          );
        });

        const totals = computeTotals();
        const subtotal = totals.subtotal;
        const taxAmount = totals.taxAmount;
        const grandTotal = totals.grandTotal;

        const footer = [
          "",
          "SUBTOTAL: " + formatMoney(subtotal),
          "SALES TAX (7.375%): " + formatMoney(taxAmount),
          "TOTAL (with tax): " + formatMoney(grandTotal),
          "",
          "Thanks for your business!",
          "218 Supply"
        ];

        return headerLines.concat(itemLines).concat(footer).join("\n");
      }

      function createPdfDoc() {
        if (!window.jspdf || !window.jspdf.jsPDF) return;
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: "pt", format: "letter" });

        const pageWidth  = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const margin     = 36;
        const headerH    = 72;

        // Top header bar: smooth red → green gradient to match app header
        const steps = 40;
        for (let i = 0; i < steps; i++) {
          const t = i / (steps - 1);
          const r = Math.round(122 + (31 - 122) * t); // #7a1b1b -> #1f4d32
          const g = Math.round(27  + (77 - 27)  * t);
          const b = Math.round(27  + (50 - 27)  * t);
          const x = (pageWidth / steps) * i;
          doc.setFillColor(r, g, b);
          doc.rect(x, 0, pageWidth / steps + 1, headerH, "F");
        }

        // Header text
        doc.setTextColor(255, 255, 255);
        doc.setFont("helvetica", "bold");
        doc.setFontSize(18);
        doc.text("218 SUPPLY", margin, 28);
        doc.setFont("helvetica", "normal");
        doc.setFontSize(11);
        doc.text("Purchase Order", margin, 46);

        // Order info
        doc.setTextColor(0, 0, 0);
        doc.setFont("helvetica", "normal");
        doc.setFontSize(11);

        let y = headerH + 28;

        const customerId = customerSelect.value || "";
        const customerObj = (window.customers || []).find(c => c.id === customerId);
        const customerName = customerObj?.name || "";
        const note = orderNoteInput.value || "";
        const now = new Date();
        const dateStr = now.toISOString().slice(0, 10);
        const salesperson = currentUser || "Not signed in";
        const salespersonEmail = currentUserProfile && currentUserProfile.email ? currentUserProfile.email : "";

        const infoLines = [
          `Date: ${dateStr}`,
          `Customer: ${customerName || "N/A"}${customerId ? " (" + customerId + ")" : ""}`,
          `Salesperson: ${salesperson}`,
        ];
        if (salespersonEmail) {
          infoLines.push(`Salesperson Email: ${salespersonEmail}`);
        }
        if (note) {
          infoLines.push("Notes: " + note);
        }

        infoLines.forEach(line => {
          doc.text(line, margin, y);
          y += 16;
        });

        y += 4;

        // Table headers
        const colWidths = {
          sku:   80,
          name:  pageWidth - margin * 2 - 80 - 50 - 70 - 70 - 10,
          qty:   50,
          price: 70,
          total: 70
        };

        doc.setFont("helvetica", "bold");
        doc.text("SKU",   margin, y);
        doc.text("Product", margin + colWidths.sku, y);
        doc.text("Qty",   margin + colWidths.sku + colWidths.name + 4, y);
        doc.text("Price", margin + colWidths.sku + colWidths.name + colWidths.qty + 4, y);
        doc.text("Line Total", margin + colWidths.sku + colWidths.name + colWidths.qty + colWidths.price + 4, y);

        y += 8;
        doc.setDrawColor(200);
        doc.line(margin, y, pageWidth - margin, y);
        y += 14;
        doc.setFont("helvetica", "normal");

        let subtotal = 0;
        const lineHeightBase = 14;

        cartItems.forEach(item => {
          if (y > pageHeight - 72) {
            doc.addPage();
            y = margin;
          }

          const lineTotal = item.price * item.qty;
          subtotal += lineTotal;

          const nameText = item.name + (item.packSize ? " (" + item.packSize + ")" : "");
          const wrappedName = doc.splitTextToSize(nameText, colWidths.name);

          const rowHeight = lineHeightBase * wrappedName.length;

          let x = margin;

          doc.text(String(item.sku), x, y);
          x += colWidths.sku;

          doc.text(wrappedName, x, y);

          x = margin + colWidths.sku + colWidths.name + 4;
          doc.text(String(item.qty), x, y);

          x += colWidths.qty;
          doc.text(formatMoney(item.price), x, y);

          x += colWidths.price;
          doc.text(formatMoney(lineTotal), x, y);

          y += rowHeight;
        });

        // Totals
        const taxRate = 0.07375;
        const taxAmount = subtotal * taxRate;
        const grandTotal = subtotal + taxAmount;

        y += 10;
        if (y > pageHeight - 72) {
          doc.addPage();
          y = margin;
        }

        const labelX = pageWidth - margin - 140;
        const amountX = pageWidth - margin;

        doc.setFont("helvetica", "bold");
        doc.text("Subtotal:", labelX, y, { align: "right" });
        doc.text(formatMoney(subtotal), amountX, y, { align: "right" });
        y += 16;

        doc.text("Sales Tax (7.375%):", labelX, y, { align: "right" });
        doc.text(formatMoney(taxAmount), amountX, y, { align: "right" });
        y += 16;

        doc.text("Total:", labelX, y, { align: "right" });
        doc.text(formatMoney(grandTotal), amountX, y, { align: "right" });

        y += 28;
        doc.setFont("helvetica", "normal");
        doc.setFontSize(9);
        doc.text("Thank you for your business – 218 Supply", margin, y);

        const filename = `PO-${customerId || "NO-CUSTOMER"}-${dateStr}.pdf`;
        return { doc, filename };
      }

      function getOrCreateCustomerProfile(customerId) {
        if (!customerId) return null;
        if (!customerProfiles || typeof customerProfiles !== "object") {
          customerProfiles = {};
        }
        if (!customerProfiles[customerId]) {
          const baseCust = (window.customers || []).find(c => c.id === customerId) || {};
          customerProfiles[customerId] = {
            id: customerId,
            customerName: baseCust.name || "",
            contactName: "",
            phone: "",
            email: "",
            notes: "",
            taxExempt: false,
            priceLevel: "",
            billingStreet: "",
            billingCity: "",
            billingState: "",
            billingZip: "",
            labels: "",
            orders: []
          };
        }
        return customerProfiles[customerId];
      }

      function computeProfileStats(profile) {
        if (!profile || !Array.isArray(profile.orders)) {
          return {
            lastOrderDate: null,
            totalThisYear: 0
          };
        }
        let lastOrderDate = null;
        let totalThisYear = 0;
        const currentYear = String(new Date().getFullYear());

        profile.orders.forEach(o => {
          if (o.date && (!lastOrderDate || o.date > lastOrderDate)) {
            lastOrderDate = o.date;
          }
          if (o.date && o.date.startsWith(currentYear) && typeof o.total === "number") {
            totalThisYear += o.total;
          }
        });

        return { lastOrderDate, totalThisYear };
      }

      function renderCustomerProfileOrders(profile) {
        customerProfileOrdersEl.innerHTML = "";
        if (!profile || !Array.isArray(profile.orders) || !profile.orders.length) {
          const empty = document.createElement("div");
          empty.className = "muted";
          empty.textContent = "No orders saved for this customer on this device yet.";
          customerProfileOrdersEl.appendChild(empty);
          return;
        }

        const list = document.createElement("div");

        profile.orders
          .slice()
          .sort((a, b) => (a.date || "").localeCompare(b.date || ""))
          .forEach((order) => {
            const row = document.createElement("div");
            row.style.padding = "4px 0";
            row.style.borderBottom = "1px solid #e5e7eb";

            const line1 = document.createElement("div");
            line1.style.fontWeight = "600";
            const dateLabel = order.date || "Unknown date";
            const itemsCount = Array.isArray(order.items) ? order.items.length : 0;
            const totalStr = typeof order.total === "number" ? formatMoney(order.total) : "$0.00";
            line1.textContent = `${dateLabel} – ${itemsCount} items – ${totalStr}`;

            const line2 = document.createElement("div");
            line2.className = "muted";
            const note = order.note ? `Notes: ${order.note}` : "";
            line2.textContent = note;

            row.appendChild(line1);
            if (note) {
              row.appendChild(line2);
            }
            list.appendChild(row);
          });

        customerProfileOrdersEl.appendChild(list);
      }

      function fillCustomerProfileModal(customerId) {
        const customer = (window.customers || []).find(c => c.id === customerId);
        const profile = getOrCreateCustomerProfile(customerId);
        currentProfileCustomerId = customerId;

        profile.customerName = (customer && customer.name) || profile.customerName || "";

        // Autofill city/state from customer if empty in profile
        if (customer) {
          if (!profile.billingCity && customer.city) {
            profile.billingCity = customer.city;
          }
          if (!profile.billingState && customer.state) {
            profile.billingState = customer.state;
          }
        }

        const stats = computeProfileStats(profile);
        const summaryParts = [];
        summaryParts.push(`Customer ID: ${customerId}`);
        if (customer && (customer.city || customer.state)) {
          const loc = (customer.city || "") + (customer.state ? (customer.city ? ", " : "") + customer.state : "");
          if (loc) summaryParts.push(`Location: ${loc}`);
        }
        if (stats.lastOrderDate) {
          summaryParts.push(`Last order: ${stats.lastOrderDate}`);
        } else {
          summaryParts.push("Last order: none yet");
        }
        summaryParts.push(`Total this year: ${formatMoney(stats.totalThisYear)}`);
        customerProfileSummary.textContent = summaryParts.join(" • ");

        profileContactNameInput.value = profile.contactName || "";
        profilePhoneInput.value       = profile.phone || "";
        profileEmailInput.value       = profile.email || "";
        profileNotesInput.value       = profile.notes || "";
        profilePriceLevelInput.value  = profile.priceLevel || "";
        profileTaxExemptInput.checked = !!profile.taxExempt;

        billingStreetInput.value = profile.billingStreet || "";
        billingCityInput.value   = profile.billingCity || "";
        billingStateInput.value  = profile.billingState || "";
        billingZipInput.value    = profile.billingZip || "";

        profileLabelsInput.value = profile.labels || "";

        renderCustomerProfileOrders(profile);

        customerProfileModalBackdrop.classList.remove("hidden");
      }

      function saveCustomerProfileFromModal() {
        if (!currentProfileCustomerId) return;
        const profile = getOrCreateCustomerProfile(currentProfileCustomerId);
        if (!profile) return;

        profile.contactName   = profileContactNameInput.value.trim();
        profile.phone         = profilePhoneInput.value.trim();
        profile.email         = profileEmailInput.value.trim();
        profile.notes         = profileNotesInput.value.trim();
        profile.priceLevel    = profilePriceLevelInput.value.trim();
        profile.taxExempt     = !!profileTaxExemptInput.checked;

        profile.billingStreet = billingStreetInput.value.trim();
        profile.billingCity   = billingCityInput.value.trim();
        profile.billingState  = billingStateInput.value.trim();
        profile.billingZip    = billingZipInput.value.trim();

        profile.labels        = profileLabelsInput.value.trim();

        saveCustomerProfiles();

        const customer = (window.customers || []).find(c => c.id === currentProfileCustomerId);
        const stats = computeProfileStats(profile);
        const summaryParts = [];
        summaryParts.push(`Customer ID: ${currentProfileCustomerId}`);
        if (customer && (customer.city || customer.state)) {
          const loc = (customer.city || "") + (customer.state ? (customer.city ? ", " : "") + customer.state : "");
          if (loc) summaryParts.push(`Location: ${loc}`);
        }
        if (stats.lastOrderDate) {
          summaryParts.push(`Last order: ${stats.lastOrderDate}`);
        } else {
          summaryParts.push("Last order: none yet");
        }
        summaryParts.push(`Total this year: ${formatMoney(stats.totalThisYear)}`);
        customerProfileSummary.textContent = summaryParts.join(" • ");
      }

      function closeCustomerProfileModal() {
        currentProfileCustomerId = null;
        customerProfileModalBackdrop.classList.add("hidden");
      }

      function saveOrderToCustomerProfile() {
        const customerId = customerSelect.value || "";
        if (!customerId) return;
        const profile = getOrCreateCustomerProfile(customerId);
        if (!profile) return;

        const now = new Date();
        const dateStr = now.toISOString().slice(0, 10);
        const totals = computeTotals();
        const orderNote = orderNoteInput.value || "";

        const itemsSnapshot = cartItems.map(item => ({
          sku: item.sku,
          name: item.name,
          packSize: item.packSize,
          price: item.price,
          qty: item.qty
        }));

        const customerObj = (window.customers || []).find(c => c.id === customerId);
        if (customerObj && customerObj.name) {
          profile.customerName = customerObj.name;
        }

        if (!Array.isArray(profile.orders)) profile.orders = [];
        profile.orders.push({
          date: dateStr,
          note: orderNote,
          items: itemsSnapshot,
          subtotal: totals.subtotal,
          taxAmount: totals.taxAmount,
          total: totals.grandTotal
        });

        saveCustomerProfiles();
      }

      let lastPoText = "";
      function showPoModal(poText) {
        lastPoText = poText || buildPoText();
        const result = createPdfDoc();
        if (!result) return;
        const { doc } = result;
        const dataUrl = doc.output("dataurlstring");
        if (poPreviewFrame) {
          poPreviewFrame.src = dataUrl;
        }
        poModalBackdrop.classList.remove("hidden");
      }

      function hidePoModal() {
        poModalBackdrop.classList.add("hidden");
      }

      function openCustomerModal() {
        customerModalBackdrop.classList.remove("hidden");
        newCustomerNameInput.focus();
      }

      // ---- event wiring ----

      loadLocalData();
      populateCustomers();
      buildCategories();
      renderCart();
      renderCustomerList();

      addItemBtn.disabled = true;
      generateSummaryBtn.disabled = true;

      customerSelect.addEventListener("change", () => {
        const hasCustomer = !!customerSelect.value;
        addItemBtn.disabled = !hasCustomer;
        generateSummaryBtn.disabled = !hasCustomer;
      });

      // sign in
      signInBtn.addEventListener("click", () => {
        loginModalBackdrop.classList.remove("hidden");
        loginUsernameInput.focus();
      });
      cancelLoginBtn.addEventListener("click", () => {
        loginModalBackdrop.classList.add("hidden");
        loginUsernameInput.value = "";
        loginPasswordInput.value = "";
      });
      confirmLoginBtn.addEventListener("click", () => {
        const username = loginUsernameInput.value.trim();
        const password = loginPasswordInput.value;
        if (!username) {
          alert("Enter a username.");
          return;
        }

        if (!userProfiles) {
          userProfiles = {};
        }
        let profile = userProfiles[username];

        if (profile && profile.password) {
          if (profile.password !== password) {
            alert("Incorrect password for this user.");
            return;
          }
        } else {
          profile = profile || { username, email: "", password: "" };
          profile.password = password || "";
          userProfiles[username] = profile;
          saveUserProfiles();
        }

        currentUser = username;
        currentUserProfile = profile;
        try {
          localStorage.setItem("orderpadUser", username);
          localStorage.setItem("orderpadCurrentUser", username);
        } catch {}

        loginModalBackdrop.classList.add("hidden");
        loginUsernameInput.value = "";
        loginPasswordInput.value = "";
        showSignedInState();
      });

      // settings
      settingsBtn.addEventListener("click", () => {
        if (!currentUser) {
          alert("Sign in first to open settings.");
          return;
        }
        if (!currentUserProfile) {
          currentUserProfile = { username: currentUser, email: "", password: "" };
          userProfiles[currentUser] = currentUserProfile;
        }
        settingsUsernameInput.value = currentUserProfile.username || currentUser;
        settingsEmailInput.value = currentUserProfile.email || "";
        settingsCurrentPassword.value = "";
        settingsNewPassword.value = "";
        settingsConfirmPassword.value = "";
        settingsModalBackdrop.classList.remove("hidden");
      });

      function closeSettingsModal() {
        settingsModalBackdrop.classList.add("hidden");
      }

      cancelSettingsBtn.addEventListener("click", closeSettingsModal);

      saveSettingsBtn.addEventListener("click", () => {
        if (!currentUser) {
          alert("Sign in first.");
          return;
        }
        const profile = currentUserProfile || { username: currentUser, email: "", password: "" };

        const newEmail = settingsEmailInput.value.trim();
        profile.email = newEmail;

        const curPass = settingsCurrentPassword.value;
        const newPass = settingsNewPassword.value;
        const confPass = settingsConfirmPassword.value;

        if (curPass || newPass || confPass) {
          if (profile.password && curPass !== profile.password) {
            alert("Current password is incorrect.");
            return;
          }
          if (newPass !== confPass) {
            alert("New passwords do not match.");
            return;
          }
          profile.password = newPass;
        }

        userProfiles[currentUser] = profile;
        currentUserProfile = profile;
        saveUserProfiles();
        closeSettingsModal();
        showSignedInState();
        alert("Settings saved on this device.");
      });

      signOutBtn.addEventListener("click", () => {
        if (!currentUser) {
          closeSettingsModal();
          return;
        }
        if (!confirm("Sign out on this device?")) return;
        currentUser = null;
        currentUserProfile = null;
        try {
          localStorage.removeItem("orderpadUser");
          localStorage.removeItem("orderpadCurrentUser");
        } catch {}
        settingsEmailInput.value = "";
        closeSettingsModal();
        showSignedInState();
      });

      // start new order
      startOrderBtn.addEventListener("click", () => {
        if (!currentUser) {
          loginModalBackdrop.classList.remove("hidden");
          loginUsernameInput.focus();
          return;
        }
        startCard.classList.add("hidden");
        orderMain.classList.add("hidden");
        customerSelectPage.classList.remove("hidden");
        customerSearchInput.value = "";
        renderCustomerList();
        customerSearchInput.focus();
      });

      // change customer
      if (changeCustomerBtn) {
        changeCustomerBtn.addEventListener("click", () => {
          if (!currentUser) {
            loginModalBackdrop.classList.remove("hidden");
            loginUsernameInput.focus();
            return;
          }
          orderMain.classList.add("hidden");
          addItemPage.classList.add("hidden");
          customerSelectPage.classList.remove("hidden");
          customerSearchInput.value = "";
          renderCustomerList();
          customerSearchInput.focus();
        });
      }

      customerSearchInput.addEventListener("input", () => {
        renderCustomerList();
      });

      // add item page
      addItemBtn.addEventListener("click", () => {
        if (!customerSelect.value) {
          alert("Select a customer first.");
          return;
        }
        orderMain.classList.add("hidden");
        addItemPage.classList.remove("hidden");
        const firstCatBtn = categoryGrid.querySelector(".category-btn");
        if (firstCatBtn && !firstCatBtn.classList.contains("active")) {
          firstCatBtn.click();
        }
      });

      backToOrderBtn.addEventListener("click", () => {
        addItemPage.classList.add("hidden");
        orderMain.classList.remove("hidden");
      });

      clearOrderBtn.addEventListener("click", clearOrder);

      generateSummaryBtn.addEventListener("click", () => {
        if (!customerSelect.value) {
          alert("Select a customer first.");
          return;
        }
        if (!cartItems.length) {
          alert("Add at least one item to the order.");
          return;
        }
        saveOrderToCustomerProfile();
        const poText = buildPoText();
        showPoModal(poText);
      });

      closePoModalBtn.addEventListener("click", hidePoModal);

      downloadPoBtn.addEventListener("click", () => {
        const result = createPdfDoc();
        if (!result) return;
        const { doc, filename } = result;
        doc.save(filename);
      });

      emailPoBtn.addEventListener("click", () => {
        const subject = encodeURIComponent("New Purchase Order from 218 Supply Order Pad");
        const body = encodeURIComponent(lastPoText || buildPoText());
        window.location.href = "mailto:sales@218supply.com?subject=" + subject + "&body=" + body;
      });

      // Add new customer
      addCustomerFromListBtn.addEventListener("click", openCustomerModal);
      if (addCustomerBtn) {
        addCustomerBtn.addEventListener("click", openCustomerModal);
      }

      cancelCustomerBtn.addEventListener("click", () => {
        customerModalBackdrop.classList.add("hidden");
        newCustomerNameInput.value = "";
        newCustomerIdInput.value = "";
      });

      saveCustomerBtn.addEventListener("click", () => {
        const name = newCustomerNameInput.value.trim();
        const id   = newCustomerIdInput.value.trim() || "CUST-" + String((window.customers || []).length + 1000);
        if (!name) {
          alert("Customer name is required.");
          return;
        }
        const newCust = { id, name };
        window.customers.push(newCust);

        const base = [];
        try {
          const existing = localStorage.getItem("orderpadExtraCustomers");
          if (existing) {
            const parsed = JSON.parse(existing);
            if (Array.isArray(parsed)) base.push(...parsed);
          }
        } catch {}
        base.push(newCust);
        saveExtraCustomers(base);

        populateCustomers();
        renderCustomerList();

        customerSelect.value = id;
        customerModalBackdrop.classList.add("hidden");
        newCustomerNameInput.value = "";
        newCustomerIdInput.value = "";

        selectCustomerAndGoToOrder(id);
      });

      // Edit customer
      function openEditCustomerModal(customer) {
        if (!customer) return;
        editingCustomerObj = customer;
        editCustomerNameInput.value = customer.name || "";
        editCustomerIdInput.value = customer.id || "";
        editCustomerCityInput.value = customer.city || "";
        editCustomerStateInput.value = customer.state || "";
        customerEditModalBackdrop.classList.remove("hidden");
        editCustomerNameInput.focus();
      }

      function closeEditCustomerModal() {
        editingCustomerObj = null;
        customerEditModalBackdrop.classList.add("hidden");
      }

      if (editCustomerBtn) {
        editCustomerBtn.addEventListener("click", () => {
          const id = customerSelect.value;
          if (!id) return;
          const customer = (window.customers || []).find((c) => c.id === id);
          if (customer) {
            openEditCustomerModal(customer);
          }
        });
      }

      cancelEditCustomerBtn.addEventListener("click", (evt) => {
        evt.preventDefault();
        closeEditCustomerModal();
      });

      saveEditCustomerBtn.addEventListener("click", (evt) => {
        evt.preventDefault();
        if (!editingCustomerObj) {
          closeEditCustomerModal();
          return;
        }
        const newName  = editCustomerNameInput.value.trim();
        const newId    = editCustomerIdInput.value.trim();
        const newCity  = editCustomerCityInput.value.trim();
        const newState = editCustomerStateInput.value.trim();

        if (newName) editingCustomerObj.name = newName;
        if (newId)   editingCustomerObj.id   = newId;
        editingCustomerObj.city  = newCity;
        editingCustomerObj.state = newState;

        saveCustomerEditFor(editingCustomerObj.id, {
          name: editingCustomerObj.name,
          city: editingCustomerObj.city,
          state: editingCustomerObj.state
        });

        populateCustomers();
        const updatedCustomer = (window.customers || []).find((c) => c.id === customerSelect.value);
        if (updatedCustomer) {
          orderCustomerDisplay.textContent = updatedCustomer.name || "No customer selected";
        }

        closeEditCustomerModal();
      });

      // Customer profile
      if (customerProfileBtn) {
        customerProfileBtn.addEventListener("click", () => {
          const id = customerSelect.value;
          if (!id) {
            alert("Select a customer first.");
            return;
          }
          fillCustomerProfileModal(id);
        });
      }

      closeCustomerProfileBtn.addEventListener("click", (evt) => {
        evt.preventDefault();
        closeCustomerProfileModal();
      });

      saveCustomerProfileBtn.addEventListener("click", (evt) => {
        evt.preventDefault();
        saveCustomerProfileFromModal();
        alert("Customer profile saved on this device.");
      });

      // Add new product
      document.getElementById("addProductBtn").addEventListener("click", () => {
        productModalBackdrop.classList.remove("hidden");
        newProdNameInput.focus();
      });
      cancelProductBtn.addEventListener("click", () => {
        productModalBackdrop.classList.add("hidden");
        newProdNameInput.value = "";
        newProdSkuInput.value = "";
        newProdCategoryInput.value = "";
        newProdPackInput.value = "";
        newProdPriceInput.value = "";
      });
      saveProductBtn.addEventListener("click", () => {
        const name = newProdNameInput.value.trim();
        const sku  = newProdSkuInput.value.trim() || "SKU-" + String((window.products || []).length + 1000);
        const rawCategory = (newProdCategoryInput.value.trim() || "OTHER").toUpperCase();
        const category = normalizeCategory(rawCategory);
        const pack = newProdPackInput.value.trim();
        const price = parseFloat(newProdPriceInput.value) || 0;
        if (!name) {
          alert("Product name is required.");
          return;
        }
        const newProd = { sku, name, category, subcategory: "", packSize: pack, price };
        window.products.push(newProd);

        const base = [];
        try {
          const existing = localStorage.getItem("orderpadExtraProducts");
          if (existing) {
            const parsed = JSON.parse(existing);
            if (Array.isArray(parsed)) base.push(...parsed);
          }
        } catch {}
        base.push(newProd);
        saveExtraProducts(base);

        buildCategories();
        productModalBackdrop.classList.add("hidden");
        newProdNameInput.value = "";
        newProdSkuInput.value = "";
        newProdCategoryInput.value = "";
        newProdPackInput.value = "";
        newProdPriceInput.value = "";
      });
    });
  </script>

  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", function () {
        navigator.serviceWorker.register("/sw.js").catch(function (err) {
          console.log("Service worker registration failed:", err);
        });
      });
    }
  </script>
</body>
</html>
