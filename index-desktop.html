<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>218 Supply â€“ Order Pad (Desktop)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --header-start: #7a1b1b;
      --header-end:   #1f4d32;
      --accent-main:  var(--header-start);
      --accent-alt:   var(--header-end);
      --bg-app:       #0f172a;
      --card-bg:      #ffffff;
    }

    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: var(--bg-app);
      color: #111827;
    }

    /* HEADER â€“ app-style bar */
    header {
      background: linear-gradient(90deg, var(--header-start), var(--header-end));
      color: white;
      padding: 0.9rem 1.2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      position: sticky;
      top: 0;
      z-index: 20;
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .header-left img {
      height: 44px;
      width: auto;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.35);
      background: white;
    }
    header h1 {
      margin: 0;
      font-size: 1.2rem;
      line-height: 1.2;
    }
    header h1 span {
      display: block;
      font-size: 0.75rem;
      opacity: 0.9;
      font-weight: 500;
    }

    .login-box {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: nowrap;
      font-size: 0.8rem;
    }
    .header-settings-btn {
      margin-left: 6px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.95);
      background: rgba(0,0,0,0.18);
      color: #fff;
      width: 32px;
      height: 32px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .header-cart-btn {
      margin-left: 6px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.95);
      background: rgba(0,0,0,0.18);
      color: #fff;
      padding: 4px 10px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      cursor: pointer;
    }
    .header-signin-btn {
      padding: 6px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.95);
      background: rgba(0,0,0,0.18);
      color: #fff;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      letter-spacing: 0.02em;
    }
    .signed-in-label {
      font-size: 0.8rem;
      color: rgba(229, 231, 235, 0.96);
      font-weight: 500;
      max-width: 140px;
      text-align: right;
      line-height: 1.2;
      cursor: pointer;
    }

    /* APP CONTAINER â€“ phone-style column */
    main {
      max-width: 520px;
      margin: 0 auto;
      padding: 14px 14px 24px;
      min-height: calc(100vh - 64px);
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .card {
      background: var(--card-bg);
      border-radius: 14px;
      box-shadow: 0 4px 10px rgba(15,23,42,0.45);
      padding: 14px 16px;
    }
    .card h2 {
      margin-top: 0;
      font-size: 1rem;
    }

    .start-card {
      padding: 0;
    }
    .start-card-button {
      display: block;
      width: 100%;
      border: none;
      background: var(--accent-main);
      color: #fff;
      border-radius: 14px;
      padding: 1.6rem 1.2rem;
      font-size: 1.15rem;
      font-weight: 600;
    }
    .start-card h2 {
      font-size: 1.25rem;
      margin-bottom: 0.6rem;
    }
    .start-card p {
      margin: 0 0 1.4rem;
      color: #4b5563;
      font-size: 0.9rem;
    }

    label {
      display: block;
      font-size: 0.9rem;
      margin-bottom: 4px;
      font-weight: 600;
    }
    select,
    input[type="number"],
    input[type="text"],
    input[type="password"],
    input[type="email"],
    textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 0.9rem;
      background: #f9fafb;
    }

    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .row > div {
      flex: 1 1 160px;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 10px 16px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: transform 0.08s ease-out, box-shadow 0.08s ease-out, background-color 0.08s ease-out;
      font-weight: 600;
    }
    button:disabled {
      opacity: 0.55;
      cursor: not-allowed;
    }

    button:active {
      transform: translateY(1px);
      box-shadow: inset 0 2px 3px rgba(0,0,0,0.35);
      filter: brightness(0.94);
    }
    .btn-primary {
      background: var(--header-start);
      color: #ffffff;
      border: none;
      border-radius: 16px;
      padding: 0.85rem 1.1rem;
      font-weight: 800;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(15,23,42,0.18);
    }
    .btn-secondary {
      background: var(--header-end);
      color: #ffffff;
      border: none;
      border-radius: 16px;
      padding: 0.85rem 1.1rem;
      font-weight: 800;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(15,23,42,0.18);
    }
    .btn-link {
      background: transparent;
      color: var(--accent-alt);
      padding: 4px 0;
      border-radius: 0;
      font-weight: 500;
    }
    .btn-ghost {
      background: #e5e7eb;
      color: #111827;
    }
    .btn-sm {
      padding: 6px 12px;
      font-size: 0.8rem;
      border-radius: 999px;
    }

    .product-controls .btn-primary {
      width: 40px;
      height: 40px;
      padding: 0;
      border-radius: 10px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
    }

    .muted {
      color: #6b7280;
      font-size: 0.8rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 0.9rem;
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #e5e7eb;
    }
    th {
      text-align: left;
      background: #f9fafb;
    }
    .text-right { text-align: right; }

    .hidden { display: none; }

    .page-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
    }

    /* CATEGORY ACCORDION â€“ stacked cards like catalog */
    #addItemPage .category-grid {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 8px;
    }

    .accordion-card {
      background: #ffffff;
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 2px 8px rgba(15,23,42,0.08);
      overflow: hidden;
    }

    .accordion-header {
      display: flex;
      width: 100%;
      align-items: center;
      justify-content: space-between;
      background: #f9fafb;
      border: none;
      color: #111827;
      padding: 12px 14px;
      cursor: pointer;
      font-weight: 800;
      font-size: 0.98rem;
    }

    .accordion-header-main {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }

    .accordion-title {
      font-size: 0.95rem;
      font-weight: 600;
    }

    .accordion-meta {
      font-size: 0.82rem;
      color: #6b7280;
      font-weight: 600;
    }

    .accordion-chevron {
      font-size: 0.9rem;
      margin-left: 8px;
      transition: transform 0.2s ease;
    }

    .accordion-card.open .accordion-chevron {
      transform: rotate(180deg);
    }

    .accordion-body {
      display: none;
      padding: 10px 14px 14px;
      background: #ffffff;
      border-top: 1px solid #e5e7eb;
      max-height: none;
      overflow: visible;
    }

    .accordion-card.open .accordion-body {
      display: block;
    }

    /* When open, constrain the body and scroll inside */
      #addItemPage .accordion-card.open .accordion-body {
        display: block;
        max-height: 170px;       /* tuned for header padding */
        overflow-y: auto;
      }

      /* When closed, keep the card height stable */
      #addItemPage .accordion-card:not(.open) .accordion-body {
        display: block;
        max-height: 0;
        overflow: hidden;
        padding-top: 0;
        padding-bottom: 0;
        border-top: none;
      }
    }
/* When open, show the body but constrain it to the card */
      .accordion-card.open .accordion-body {
        display: block;
        max-height: 206px;       /* 280 - header area (approx) */
        overflow-y: auto;
      }

      /* When closed, keep body from affecting layout (card stays same height) */
      .accordion-card:not(.open) .accordion-body {
        display: block;          /* keep layout stable */
        max-height: 0;
        overflow: hidden;
        padding: 0;
        margin: 0;
        border: none;
      }
    }

        /* Subcategory chips â€“ thin pill row like catalog */
    .subcategory-grid {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      gap: 0.3rem;
      margin-bottom: 0.45rem;
      margin-top: 2px;
      align-items: center;
    }

    .subcat-chip {
      border-radius: 999px;
      padding: 0.38rem 0.8rem;
      font-size: 0.82rem;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      color: #111827;
      cursor: pointer;
      white-space: nowrap;
      flex: 0 0 auto;
    }

    .subcat-chip.active {
      border-color: rgba(122,27,27,0.35);
      background: rgba(122,27,27,0.08);
      color: #111827;
    }

.product-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      padding: 8px 0;
      border-bottom: 1px solid rgba(31,41,55,0.85);
    }
    .product-main { 
      flex: 1 1 auto; 
    }
    .product-name {
      font-size: 0.9rem;
      font-weight: 500;
      color: #e5e7eb;
    }
    .product-meta {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-top: 2px;
    }
    .product-controls {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: flex-end;
      gap: 6px;
      min-width: 110px;
    }
    
.product-controls input[type="number"] {
  height: 28px;
  min-width: 30px;
  width: auto;
  padding: 2px 6px;
  font-size: 0.8rem;
  text-align: center;
  border-radius: 8px;
  border: 1px solid rgba(148,163,184,0.9);
  background: rgba(15,23,42,0.98);
  color: #e5e7eb;
}

    .product-controls .btn-primary {
      min-width: 88px;
      padding-left: 12px;
      padding-right: 12px;
    }

    .big-option-btn {
      display: block;
      width: 90%;
      max-width: 420px;
      margin: 0 auto 14px;
      font-size: 1.15rem;
      font-weight: 700;
      padding: 1.6rem 1.2rem;
      border-radius: 16px;
      text-align: center;
    }

    .customer-lists-days {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 8px;
    }

    .customer-list-day-card {
      width: 100%;
      text-align: left;
      background: #f9fafb;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      padding: 10px 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .customer-list-day-card .day-name {
      font-size: 0.95rem;
      font-weight: 600;
    }

    .customer-list-day-card .day-meta {
      font-size: 0.8rem;
      color: #6b7280;
    }

    /* Start options layout (Select Customer / Customer Lists) */
    .start-options-card {
      max-width: 480px;
      margin: 2rem auto 0;
      padding: 18px 20px;
      border-radius: 18px;
      box-shadow: 0 2px 8px rgba(15,23,42,0.35);
    }
    .start-options-title {
      margin: 0 0 0.25rem;
      font-size: 1.1rem;
      font-weight: 600;
    }
    .start-options-subtitle {
      margin: 0 0 1.25rem;
      font-size: 0.9rem;
    }
    .start-options-buttons {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      align-items: stretch;
    }

    /* Desktop: keep card centered but left-align contents */
    @media (min-width: 768px) {
      #startOptionsCard {
        text-align: left;
      }
      #startOptionsCard .start-options-buttons {
        align-items: flex-start;
      }
      #startOptionsCard .big-option-btn {
        margin-left: 0;
        margin-right: 0;
      }
    }

    /* Desktop-only: multi-column order flow (keeps steps on one page) */
    @media (min-width: 1024px) {
      /* Keep the whole flow anchored to the left */
      main {
        display: flex;
        flex-direction: row;
        align-items: flex-start;
        justify-content: flex-start;
        gap: 16px;
        padding: 18px 16px 24px;
        max-width: none;
        overflow-x: hidden; /* Option B: fit viewport, no horizontal scroll */
      }

      /* Panels should be able to shrink to fit the viewport */
      #startCard,
      #startOptionsCard,
      #customerListsPage,
      #customerSelectPage,
      #addItemPage,
      #orderMain {
        margin: 0 !important;
        min-width: 0; /* critical so flex children can shrink */
      }

      /* Column sizing that flexes to fit */
      #startCard {
        flex: 0 1 clamp(200px, 16vw, 260px);
        text-align: left !important;
        background: none !important;
        box-shadow: none !important;
        padding: 0 !important;
      }
      #startCard .start-card-button {
        width: 100% !important;
        max-width: none !important;
        margin: 0 !important;
        padding: 1.35rem 1rem !important;
        font-size: 1.1rem !important;
        border-radius: 16px !important;
      }

      /* Step 2: Options or Lists (same slot) */
      #startOptionsCard,
      #customerListsPage {
        flex: 0 1 clamp(260px, 22vw, 360px);
        max-width: none;
      }
      #startOptionsCard.start-options-card {
        margin: 0 !important;
      }
      #startOptionsCard .start-options-title,
      #startOptionsCard .start-options-subtitle {
        text-align: left !important;
      }
      #startOptionsCard .big-option-btn {
        width: 100% !important;
        max-width: none !important;
        margin: 0 0 14px 0 !important;
        padding: 1.35rem 1rem !important;
        font-size: 1.05rem !important;
        border-radius: 16px !important;
      }

      /* Step 3: Customer selection */
      #customerSelectPage {
        flex: 0 1 clamp(280px, 24vw, 380px);
        max-width: none;
      }

      /* Step 4: Items (fills the remaining space) */
      #addItemPage {
        flex: 1 1 auto;
        min-width: 260px;
      }

      /* Step 5: Cart/Order */
      #orderMain {
        flex: 0 1 clamp(300px, 26vw, 460px);
        max-width: none;
      }

      /* Keep cards consistent */
      #startOptionsCard.card,
      #customerSelectPage.card,
      #addItemPage.card,
      #orderMain.card,
      #customerListsPage.card {
        border-radius: 18px;
        box-shadow: 0 2px 8px rgba(15,23,42,0.25);
      }
    }

      /* Never auto-center panels on desktop */
      #startCard,
      #startOptionsCard,
      #customerListsPage,
      #customerSelectPage,
      #addItemPage,
      #orderMain {
        margin: 0 !important;
      }

      /* Column 1: Start (left) */
      #startCard {
        flex: 0 0 260px;
        text-align: left !important;
        background: none !important;
        box-shadow: none !important;
        padding: 0 !important;
      }
      #startCard .start-card-button {
        width: 100% !important;
        max-width: none !important;
        margin: 0 !important;
        padding: 1.4rem 1rem !important;
        font-size: 1.15rem !important;
        border-radius: 16px !important;
      }

      /* Column 2: Options (next to Start) */
      #startOptionsCard {
        flex: 0 0 360px;
        max-width: 360px;
      }
      /* remove mobile centering on desktop */
      #startOptionsCard.start-options-card {
        margin: 0 !important;
      }
      #startOptionsCard .start-options-title,
      #startOptionsCard .start-options-subtitle {
        text-align: left !important;
      }
      #startOptionsCard .big-option-btn {
        width: 100% !important;
        max-width: none !important;
        margin: 0 0 14px 0 !important;
        padding: 1.4rem 1rem !important;
        font-size: 1.1rem !important;
        border-radius: 16px !important;
      }

      /* Column 2 alt: Customer Lists uses same slot */
      #customerListsPage {
        flex: 0 0 360px;
        max-width: 360px;
      }

      /* Column 3: Customer selection */
      #customerSelectPage {
        flex: 0 0 380px;
        max-width: 380px;
      }

      /* Column 4: Items */
      #addItemPage {
        flex: 1 1 520px;
        min-width: 460px;
      }

      /* Column 5: Cart/Order */
      #orderMain {
        flex: 0 0 440px;
        max-width: 560px;
      }

      /* Keep cards looking consistent in columns */
      #startOptionsCard.card,
      #customerSelectPage.card,
      #addItemPage.card,
      #orderMain.card,
      #customerListsPage.card {
        border-radius: 18px;
        box-shadow: 0 2px 8px rgba(15,23,42,0.25);
      }
    }

      /* Let panels sit side-by-side */
      #startCard,
      #startOptionsCard,
      #customerListsPage,
      #customerSelectPage,
      #addItemPage,
      #orderMain {
        margin-top: 0 !important;
      }

      /* Column 1: Start */
      #startCard {
        flex: 0 0 240px;
        text-align: left;
        margin-left: 0;
      }
      #startCard .start-card-button {
        width: 100%;
        max-width: none;
        padding: 1.25rem 1rem;
        font-size: 1.1rem;
        border-radius: 16px;
      }

      /* Column 2: Options (Select / Lists) */
      #startOptionsCard,
      #customerListsPage {
        flex: 0 0 320px;
        max-width: 320px;
      }
      .start-options-card {
        margin: 0;
      }
      #startOptionsCard .start-options-title,
      #startOptionsCard .start-options-subtitle {
        text-align: left;
      }
      #startOptionsCard .big-option-btn {
        width: 100%;
        max-width: none;
        margin: 0 0 14px 0;
        padding: 1.25rem 1rem;
        font-size: 1.05rem;
      }

      /* Column 3: Customer selection */
      #customerSelectPage {
        flex: 0 0 360px;
        max-width: 360px;
      }

      /* Column 4: Items */
      #addItemPage {
        flex: 1 1 520px;
        min-width: 420px;
      }

      /* Column 5: Cart/Order */
      #orderMain {
        flex: 0 0 420px;
        max-width: 520px;
      }

      /* Keep cards looking consistent in columns */
      #customerSelectPage.card,
      #addItemPage.card,
      #orderMain.card,
      #customerListsPage.card,
      #startOptionsCard.card {
        border-radius: 18px;
        box-shadow: 0 2px 8px rgba(15,23,42,0.25);
      }
    }

    
    /* Desktop: tighten the Items (Add Item) panel density */
    @media (min-width: 1024px) {
      #addItemPage .product-row {
        padding: 8px 10px;
      }
      #addItemPage .qty-input {
        width: 56px;
        padding: 6px 8px;
        font-size: 0.9rem;
      }
      #addItemPage .btn-add {
        padding: 0.55rem 0.9rem;
        font-size: 0.9rem;
        border-radius: 12px;
      }
    }

    
    /* Items panel readability */
    #addItemPage .product-row,
    #addItemPage .product-row * {
      color: #111827;
    }
    #addItemPage .muted,
    #addItemPage .help,
    #addItemPage .subtext {
      color: #6b7280;
    }

        /* CUSTOMER LIST PAGE */
    .customer-list {
      margin-top: 10px;
      max-height: 65vh;
      overflow-y: auto;
    }
    .customer-row {
      padding: 10px 12px;
      border-radius: 10px;
      background: #f9fafb;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      border: 1px solid #e5e7eb;
    }
    .customer-row:hover {
      background: #eef2ff;
      border-color: var(--accent-alt);
    }
    .customer-row-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .customer-row-name {
      font-size: 0.95rem;
      font-weight: 600;
    }
    .customer-row-id {
      font-size: 0.75rem;
      color: #6b7280;
    }
    .customer-row-city {
      font-size: 0.8rem;
      color: #4b5563;
      margin-left: 8px;
      white-space: nowrap;
    }

    /* MODALS â€“ full-screen dim like an app sheet */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.75);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .modal-backdrop.hidden {
      display: none;
    }
    .modal {
      background: white;
      border-radius: 16px;
      padding: 18px 16px 14px;
      width: 94%;
      max-width: 480px;
      box-shadow: 0 20px 40px rgba(15,23,42,0.5);
      max-height: 92vh;
      overflow-y: auto;
    }
    .modal h2 {
      margin-top: 0;
      font-size: 1rem;
      margin-bottom: 6px;
    }
    .modal p {
      margin-top: 0;
      font-size: 0.82rem;
      color: #6b7280;
    }
    .modal textarea {
      width: 100%;
      min-height: 220px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.8rem;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      resize: vertical;
      box-sizing: border-box;
    }
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 10px;
    }

    .clear-order-link {
      background: none;
      border: none;
      color: #b91c1c;
      font-size: 0.8rem;
      padding: 4px 6px;
      text-decoration: underline;
      cursor: pointer;
    }

    /* MOBILE TWEAKS */
    @media (max-width: 600px) {
      header h1 {
        font-size: 1rem;
      }
      main {
        padding: 12px 10px 20px;
      }
      .card {
        padding: 14px 14px;
      }
      .btn-sm {
        padding: 6px 10px;
      }
      .page-header-row {
        flex-direction: column;
        align-items: flex-start;
      }
      .page-header-row > *:last-child {
        align-self: stretch;
        display: flex;
        justify-content: flex-end;
        gap: 6px;
      }
    }

    /* DESKTOP â€“ relax the full-width buttons a bit */
    @media (min-width: 721px) {
      .start-card .btn-primary {
        width: 100%;
      }
      .card button.btn-primary,
      .card button.btn-secondary {
        width: auto;
      }
    }

    /* Remove card background for Start New Order */
    #startCard {
      background: none !important;
      box-shadow: none !important;
      padding: 0 !important;
      margin-top: 2rem;
      text-align: center;
    }

    #startCard .start-card-button {
      display: block;
      margin: 0 auto;
    }

    /* Make the button the actual card */
    .start-card-button {
      width: 90%;
      max-width: 420px;
      background: var(--accent-main);
      color: #fff;
      padding: 1.8rem 1rem;
      font-size: 1.4rem;
      font-weight: 700;
      border-radius: 16px;
      border: none;
    }

    /* Desktop adjustments */
    @media (min-width: 768px) {
      #startCard {
        margin-top: 3rem;
      }
      .start-card-button {
        width: 420px;
        padding: 2rem 1rem;
        font-size: 1.5rem;
      }
    }

    .order-main {
      position: relative;
    }
    .order-header-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 8px;
    }
    .order-header-label {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #6b7280;
      margin-bottom: 2px;
    }
    .order-header-customer {
      font-size: 1.1rem;
      font-weight: 600;
    }
    .order-note-row {
      margin-top: 8px;
    }
    .order-note-row label {
      display: block;
      margin-bottom: 4px;
    }
    .order-main {
      position: relative;
      padding-bottom: 90px;
    }

    .cart-box {
      background: #ffffff;
      border-radius: 14px;
      padding: 12px 12px 8px;
      margin-top: 12px;
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.35);
    }
    .cart-box-header {
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 6px;
    }
    .cart-box-body {
      border-radius: 10px;
      border: 1px dashed #d1d5db;
      min-height: 72px;
      padding: 8px;
      background: #f9fafb;
      overflow-x: auto;
      overflow-y: auto;
      max-height: 360px;
    }
    .cart-empty {
      font-size: 0.9rem;
      color: #6b7280;
    }
    .cart-box-body table {
      background: #ffffff;
    }
    .cart-box-body table th,
    .cart-box-body table td {
      font-size: 0.8rem;
    }

    .generate-section {
      margin-top: 18px;
    }

    .generate-btn {
      width: 100%;
    }

    #clearOrderBtn {
      flex: 0 0 auto;
    }

    .order-actions-row {
      margin-top: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .order-actions-row .clear-order-link {
      white-space: nowrap;
    }

    .order-add-fab {
      background: var(--accent-main);
      color: #ffffff;
      border-radius: 14px;
      padding: 1.05rem 1rem;
      font-size: 1.1rem;
      font-weight: 700;
      box-shadow: 0 12px 26px rgba(0, 0, 0, 0.45);
      border: none;
      cursor: pointer;
      display: inline-block;
      flex: 1;
    }
  
    /* Desktop-only: 5-column workflow layout (Start -> Options -> Customer -> Items -> Cart/PO) */
    @media (min-width: 1024px) {
      main {
        display: flex;
        flex-direction: row;
        align-items: flex-start;
        justify-content: flex-start;
        gap: 16px;
        padding: 18px 16px 24px;
        max-width: none;
        overflow-x: hidden; /* fit viewport, no horizontal scroll */
      }

      /* Allow columns to shrink */
      #startCard,
      #startOptionsCard,
      #customerListsPage,
      #customerSelectPage,
      #addItemPage,
      #orderMain {
        min-width: 0;
        margin: 0 !important;
      }

      /* Column 1: Start */
      #startCard {
        flex: 0 1 clamp(220px, 16vw, 280px);
        text-align: left !important;
        background: none !important;
        box-shadow: none !important;
        padding: 0 !important;
      }
      #startCard .start-card-button {
        width: 100% !important;
        max-width: none !important;
        margin: 0 !important;
      }

      /* Column 2: Options (or Customer Lists) */
      #startOptionsCard,
      #customerListsPage {
        flex: 0 1 clamp(260px, 20vw, 360px);
        max-width: none !important;
      }
      #startOptionsCard.start-options-card {
        margin: 0 !important;
      }
      #startOptionsCard .big-option-btn {
        width: 100% !important;
        max-width: none !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
      }

      /* Column 3: Customer */
      #customerSelectPage {
        flex: 0 1 clamp(280px, 22vw, 380px);
        max-width: none !important;
      }

      /* Column 4: Items (always-open browser) */
      #addItemPage {
        flex: 1 1 auto;
        min-width: 320px;
      }

      /* Column 5: Cart / Generate PO */
      #orderMain {
        flex: 0 1 clamp(320px, 24vw, 480px);
        max-width: none !important;
      }

      /* In desktop workflow, the item picker lives in column 4, so hide the big Add New Item button in column 5 */
      #goToAddItemBtn {
        display: none !important;
      }

      /* Slightly tighten headers in panels so more content fits */
      #addItemPage .page-header-row h2,
      #customerSelectPage .page-header-row h2 {
        font-size: 1.05rem;
      }
    }

    /* Desktop: allow full column expansion (no internal scroll trapping) */
    @media (min-width: 1024px) {
      #orderMain,
      #addItemPage,
      #customerSelectPage,
      #startOptionsCard,
      #customerListsPage {
        max-height: none !important;
        height: auto !important;
        overflow: visible !important;
      }

      /* Common inner wrappers that sometimes get scroll-locked */
      #orderMain .card-body,
      #orderMain .panel-body,
      #orderMain .scroll-area,
      #orderMain .cart-scroll,
      #addItemPage .card-body,
      #addItemPage .panel-body,
      #addItemPage .scroll-area,
      #addItemPage .items-scroll,
      #customerSelectPage .card-body,
      #customerSelectPage .panel-body,
      #customerSelectPage .scroll-area {
        max-height: none !important;
        height: auto !important;
        overflow: visible !important;
      }

      main {
        overflow-y: visible !important;
      }
    }

    /* Items (Add Item) focus mode */
    #addItemPage .hidden-by-focus { display: none !important; }
    #itemsAllCategoriesBtn { margin: 0.5rem 0 0.25rem; }

    /* Desktop bonus: tighter density in Items */
    @media (min-width: 1024px) {
      #addItemPage .product-row { padding: 6px 8px !important; }
      #addItemPage .qty-input { width: 52px !important; padding: 5px 7px !important; font-size: 0.88rem !important; }
      #addItemPage .btn-add, #addItemPage .add-btn { padding: 0.5rem 0.85rem !important; font-size: 0.88rem !important; border-radius: 12px !important; }
      #addItemPage .subcat-chip { padding: 0.3rem 0.65rem !important; font-size: 0.78rem !important; }
    }

    /* Desktop Items two-lane layout (Option 3) */
    .items-split { display: block; }
    .items-left-title { margin: 6px 0 8px; font-weight: 800; color: #6b7280; }
    .cat-row {
      width: 100%;
      text-align: left;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      border-radius: 12px;
      padding: 10px 10px;
      margin-bottom: 8px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      color: #111827;
      font-weight: 800;
    }
    .cat-row .cat-meta {
      font-size: 0.78rem;
      color: #6b7280;
      font-weight: 700;
      white-space: nowrap;
    }
    .cat-row.active {
      border-color: rgba(122, 27, 27, 0.45);
      background: rgba(122, 27, 27, 0.08);
    }

    @media (min-width: 1024px) {
      #addItemPage .items-split {
        display: flex;
        gap: 12px;
        align-items: flex-start;
      }
      #addItemPage .items-left {
        width: 210px;
        flex: 0 0 210px;
      }
      #addItemPage .items-right {
        flex: 1 1 auto;
        min-width: 0;
      }

      /* Bonus: tighter density in Items */
      #addItemPage .product-row { padding: 6px 8px; }
      #addItemPage .qty-input { width: 52px; padding: 5px 7px; font-size: 0.88rem; }
      #addItemPage .btn-add, #addItemPage .add-btn { padding: 0.5rem 0.85rem; font-size: 0.88rem; border-radius: 12px; }
      #addItemPage .subcat-chip { padding: 0.3rem 0.65rem; font-size: 0.78rem; }
    }


    /* Desktop: 4-column layout (Start + Options stacked) */
    @media (min-width: 1024px) {
      #colStart {
        flex: 0 1 clamp(240px, 18vw, 320px);
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      /* Start card itself should look like a simple rail (no huge padding) */
      #startCard {
        background: transparent !important;
        box-shadow: none !important;
        border: none !important;
        padding: 0 !important;
      }

      /* Keep Start button full width inside the rail */
      #startCard .start-card-button {
        width: 100% !important;
        max-width: none !important;
      }

      /* Start options + customer lists behave like panels under Start */
      #startOptionsCard,
      #customerListsPage {
        margin: 0 !important;
        max-width: none !important;
      }

      /* Main flow columns now: StartRail | Customer | Items | Cart */
      main {
        display: flex;
        flex-direction: row;
        align-items: flex-start;
        justify-content: flex-start;
        gap: 16px;
      }

      /* Make sure these are the only columns taking horizontal space */
      #customerSelectPage { flex: 0 1 clamp(280px, 22vw, 380px); }
      #addItemPage { flex: 1 1 auto; min-width: 420px; }
      #orderMain { flex: 0 1 clamp(320px, 26vw, 520px); }

      /* Prevent hidden panels from reserving space */
      #startOptionsCard.hidden,
      #customerListsPage.hidden,
      #customerSelectPage.hidden,
      #addItemPage.hidden,
      #orderMain.hidden {
        display: none !important;
      }
    }


    /* Add Item: compact category tabs (no item counts) */
    #addItemPage .accordion-header {
      padding: 8px 12px !important;
      font-size: 0.9rem !important;
      line-height: 1.2;
    }

    #addItemPage .accordion-card {
      margin-bottom: 6px;
    }


    /* Add Item: allow longer item descriptions */
    #addItemPage .product-name,
    #addItemPage .product-title {
      white-space: normal;
      line-height: 1.3;
    }

    #addItemPage .product-subtext,
    #addItemPage .product-desc {
      font-size: 0.8rem;
      color: #6b7280;
    }



    /* =========================================================
       Cohesion Pack v1 (Homogeneity): surfaces, controls, type, spacing, colors
       CSS-only: does not change layout structure or JS behavior.
       ========================================================= */

    :root {
      /* Brand anchors (already used in header) */
      --brand-red: var(--header-start);
      --brand-green: var(--header-end);

      /* Neutrals */
      --ui-bg: #0f172a;              /* app background (already) */
      --surface: #ffffff;            /* card surface */
      --surface-tint: #f8fafc;       /* subtle surface tint */
      --border: #e5e7eb;
      --border-strong: #d1d5db;
      --text: #111827;
      --muted: #6b7280;

      /* Shape + elevation */
      --radius: 18px;
      --radius-sm: 12px;
      --shadow: 0 10px 28px rgba(15, 23, 42, 0.16);
      --shadow-sm: 0 6px 18px rgba(15, 23, 42, 0.14);

      /* Spacing system (8/16/24) */
      --s-1: 8px;
      --s-2: 16px;
      --s-3: 24px;

      /* Control sizes */
      --control-h: 38px;
      --control-h-sm: 32px;
    }

    /* 1) SURFACES: same card language everywhere */
    .card {
      border-radius: var(--radius) !important;
      border: 1px solid var(--border) !important;
      box-shadow: var(--shadow) !important;
      background: var(--surface) !important;
    }

    /* Inner padding rhythm */
    .card {
      padding: var(--s-2) !important;
    }

    /* Any nested "mini cards" should be lighter */
    .card .card {
      box-shadow: var(--shadow-sm) !important;
      border-radius: var(--radius-sm) !important;
    }

    /* 2) CONTROLS: inputs, pills, small buttons look like siblings */
    input[type="text"],
    input[type="search"],
    input[type="email"],
    input[type="password"],
    input[type="number"],
    textarea,
    select {
      height: var(--control-h);
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: #fff;
      color: var(--text);
      padding: 0 12px;
      outline: none;
      box-shadow: none;
    }
    textarea {
      height: auto;
      padding: 10px 12px;
    }
    input:focus,
    textarea:focus,
    select:focus {
      border-color: var(--border-strong);
      box-shadow: 0 0 0 3px rgba(122, 27, 27, 0.18); /* subtle red focus */
    }

    /* Ghost / pill buttons unify */
    .btn-sm.btn-ghost,
    .pill {
      height: var(--control-h-sm);
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f3f4f6;
      color: var(--text);
      font-weight: 800;
    }
    .btn-sm.btn-ghost:hover,
    .pill:hover {
      background: #eef2f7;
      border-color: var(--border-strong);
    }

    /* Primary + secondary actions (use brand colors consistently) */
    .btn-primary,
    .start-card-button,
    .add-btn,
    button.add-btn,
    .btn-add {
      background: var(--brand-red) !important;
      color: #fff !important;
      border: none !important;
      border-radius: 16px !important;
      font-weight: 900 !important;
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.20) !important;
    }
    .btn-primary:hover,
    .start-card-button:hover,
    .add-btn:hover,
    .btn-add:hover {
      filter: brightness(1.02);
    }

    .btn-secondary {
      background: var(--brand-green) !important;
      color: #fff !important;
      border: none !important;
      border-radius: 16px !important;
      font-weight: 900 !important;
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.18) !important;
    }

    /* 3) TYPOGRAPHY: one hierarchy (no structural changes) */
    h2 {
      font-size: 1.05rem;
      font-weight: 950;
      letter-spacing: 0.1px;
      margin: 0 0 var(--s-1) 0;
      color: var(--text);
    }
    p,
    .muted,
    .help,
    .subtext {
      color: var(--muted);
    }

    /* Labels / small captions */
    label,
    .order-header-label,
    .small-label {
      font-size: 0.78rem;
      font-weight: 800;
      color: var(--muted);
      text-transform: none;
      letter-spacing: 0.2px;
    }

    /* 4) SPACING: enforce 8/16/24 rhythm on common stacks */
    main {
      gap: var(--s-3) !important;
      padding: var(--s-2) !important;
    }

    /* Common vertical stacks in panels */
    #startCard,
    #startOptionsCard,
    #customerSelectPage,
    #orderMain,
    #addItemPage,
    #customerListsPage {
      display: flex;
      flex-direction: column;
      gap: var(--s-1);
    }

    /* Tidy button groups */
    .panel-actions,
    .order-header-row,
    .order-actions,
    .top-actions {
      gap: var(--s-1) !important;
    }

    /* 5) COLOR USAGE: keep neutrals neutral; reserve red/green for actions */
    a, .link, .danger-link {
      color: var(--brand-red);
    }
    a:hover, .link:hover, .danger-link:hover {
      filter: brightness(0.95);
    }

    /* Make category pills & chips neutral by default */
    .subcat-chip,
    .category-pill,
    .chip {
      background: #fff;
      border: 1px solid var(--border);
      color: var(--text);
    }
    .subcat-chip.active,
    .category-pill.active,
    .chip.active {
      border-color: rgba(122, 27, 27, 0.45);
      box-shadow: 0 0 0 3px rgba(122, 27, 27, 0.10);
    }

    /* Keep internal scrollers and lists visually consistent */
    .list,
    .customer-list,
    .cart-list {
      border-radius: var(--radius-sm);
    }



    /* ===== UI Refinements: 1) Customer actions, 2) Qty stepper (A), 3) Categories lighter ===== */

    /* 1) Customer action buttons: make them read as tools, not labels */
    #orderMain .btn-sm.btn-ghost {
      height: 30px !important;
      padding: 0 10px !important;
      font-weight: 800 !important;
      font-size: 0.78rem !important;
      background: #f3f4f6 !important;
      border: 1px solid #e5e7eb !important;
      color: #111827 !important;
      box-shadow: none !important;
    }
    #orderMain .btn-sm.btn-ghost:hover {
      background: #eef2f7 !important;
      border-color: #d1d5db !important;
    }

    #orderMain .order-header-row {
      align-items: flex-start !important;
      gap: 10px !important;
    }
    #orderMain .order-header-label {
      margin-bottom: 4px;
    }
    #orderMain .order-header-customer,
    #orderMain #orderCustomerDisplay {
      font-weight: 900;
      font-size: 1.05rem;
      color: #111827;
      line-height: 1.15;
    }

    /* 3) Categories: lighter, smaller, no counts */
    #addItemPage .category-list button,
    #addItemPage .category-pill,
    #addItemPage .category-item {
      padding: 8px 10px !important;
      border-radius: 14px !important;
      border: 1px solid #e5e7eb !important;
      background: #ffffff !important;
      font-weight: 850 !important;
      font-size: 0.85rem !important;
      color: #111827 !important;
      box-shadow: none !important;
    }
    #addItemPage .category-list button:hover,
    #addItemPage .category-pill:hover,
    #addItemPage .category-item:hover {
      border-color: #d1d5db !important;
      background: #f9fafb !important;
    }
    #addItemPage .category-list button.active,
    #addItemPage .category-pill.active,
    #addItemPage .category-item.active,
    #addItemPage .category-list button[aria-selected="true"] {
      border-color: rgba(122, 27, 27, 0.55) !important;
      box-shadow: 0 0 0 3px rgba(122, 27, 27, 0.12) !important;
    }

    /* Reduce "Categories" label prominence */
    #addItemPage .categories-label,
    #addItemPage .categories-title {
      font-size: 0.78rem !important;
      color: #6b7280 !important;
      font-weight: 800 !important;
      margin: 6px 0 6px !important;
    }

    /* 2) Quantity stepper option A: inline - 1 + */
    .qty-stepper {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 6px;
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      background: #fff;
    }
    .qty-stepper button {
      height: 26px;
      min-width: 28px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      background: #f3f4f6;
      font-weight: 900;
      color: #111827;
      cursor: pointer;
      line-height: 1;
    }
    .qty-stepper button:hover {
      background: #eef2f7;
      border-color: #d1d5db;
    }
    .qty-stepper .qty-value {
      min-width: 18px;
      text-align: center;
      font-weight: 900;
      color: #111827;
    }

    /* Hide native number spinners if still present */
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }



    /* Quantity stepper (compact, centered) */
    .qty-stepper{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      padding:2px 6px;
      border:1px solid #e5e7eb;
      border-radius:999px;
      background:#fff;
      height:30px;
    }
    .qty-stepper button{
      height:24px;
      min-width:26px;
      padding:0;
      border-radius:999px;
      border:1px solid #e5e7eb;
      background:#f3f4f6;
      font-weight:900;
      font-size:0.95rem;
      color:#111827;
      cursor:pointer;
      line-height:1;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .qty-stepper .qty-value{
      min-width:14px;
      text-align:center;
      font-weight:900;
      font-size:0.95rem;
      color:#111827;
      line-height:1;
    }
    /* Center the stepper within product rows */
    .product-row .qty-stepper,
    .product-row-right .qty-stepper,
    .product-actions .qty-stepper{
      margin:0 auto;
    }


    /* Hide category item counts (e.g., "25 items") */
    .category-count,
    .cat-count,
    .items-count { display:none !important; }

    /* If counts are plain text in a span inside category buttons, hide that trailing span */
    .category-list button span:last-child,
    .category-pill span:last-child{
      display:none !important;
    }


/* Uniform category button width (match longest label automatically) */
.category-list {
  display: grid;
  grid-template-columns: max-content;
  row-gap: 8px;
}
.category-list button {
  width: max-content;
  white-space: nowrap;
}


/* ===== Tweaks: category button sizing + fixed Cart column width ===== */

/* Category buttons: shrink to content, and all match the widest label (Kitchen Essentials) */
.category-list{
  display: inline-grid !important;
  grid-template-columns: max-content !important; /* column becomes as wide as the longest label */
  row-gap: 8px;
  justify-items: stretch; /* buttons stretch to the column width */
}
.category-list button{
  width: 100% !important;        /* match the max-content column width */
  white-space: nowrap;
  padding: 7px 10px !important;  /* slightly tighter so Kitchen Essentials doesn't feel oversized */
}

/* Desktop: final column (Cart / Order panel) fixed width regardless of category */
@media (min-width: 1024px){
  #orderMain{
    flex: 0 0 420px !important;
    width: 420px !important;
    max-width: 420px !important;
  }
}

</style>

  <!-- PWA manifest and meta -->
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#7a1b1b" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
</head>

<body>
  <header>
    <div class="header-left">
      <img src="Logo.PNG" alt="218 Supply logo" />
      <h1>
        218 Supply
        <span>Order Pad</span>
      </h1>
    </div>
    <div class="login-box">
      <button id="signInBtn" class="header-signin-btn">Sign In</button>
      <span id="signedInLabel" class="signed-in-label" style="display:none;"></span>
    </div>
    <button id="cartHeaderBtn" class="header-cart-btn" type="button">ðŸ›’ (0)</button>
    <button id="settingsBtn" class="header-settings-btn" aria-label="Settings">âš™</button>
  </header>

  <main>
    <div class="card-stack" id="colStart">
  <div class="card start-card" id="startCard">
      <button class="btn-primary start-card-button" id="startOrderBtn">
        Start a New Order
      </button>
    

      <div class="card start-options-card hidden" id="startOptionsCard">
            <h2 class="start-options-title">Create a New Order</h2>
            <p class="start-options-subtitle muted">Choose how you want to start.</p>
            <div class="start-options-buttons">
              <button class="btn-primary big-option-btn" id="startSelectCustomerBtn">Select Customer</button>
              <button class="btn-secondary big-option-btn" id="startCustomerListsBtn">Customer Lists</button>
            </div>
          </div>

      <div id="customerListsPage" class="hidden card">
            <div class="page-header-row">
              <h2>Customer Lists</h2>
              <button class="btn-sm btn-ghost" id="backFromCustomerListsBtn">&larr; Back</button>
            </div>
            <p class="muted">Tap a day to see or edit that route list.</p>
            <div id="customerListsDays" class="customer-lists-days"></div>
            <div id="customerListGroupContainer" class="hidden">
              <div class="page-header-row" style="margin-top:12px;">
                <h3 id="customerGroupTitle" style="margin:0;font-size:0.95rem;">Monday List</h3>
                <button class="btn-sm btn-ghost" id="editCustomerGroupBtn">Edit List</button>
              </div>
              <div id="customerGroupList" class="customer-list" style="margin-top:8px;"></div>
            </div>
          </div>
</div>
</div>

    

    

    <!-- Customer selection page -->
    <div id="customerSelectPage" class="hidden card">
      <div class="page-header-row">
        <h2>Select Customer</h2>
        <button class="btn-sm btn-ghost" id="addCustomerFromListBtn">Add New Customer</button>
      </div>
      <input
        type="text"
        id="customerSearchInput"
        placeholder="Search customers..."
        aria-label="Search customers"
      />
      <div id="customerList" class="customer-list"></div>
    </div>

    <div id="orderMain" class="hidden card order-main">
      <div class="order-header-row">
        <div>
          <div class="order-header-label">Customer</div>
          <div class="order-header-customer" id="orderCustomerDisplay">
            No customer selected
          </div>
        </div>
        <button class="btn-sm btn-ghost" id="changeCustomerBtn">Change Customer</button>
        <button class="btn-sm btn-ghost" id="customerProfileBtn">Profile</button>
        <button class="btn-sm btn-ghost" id="editCustomerBtn">Edit Customer</button>
      </div>

      <div class="order-note-row">
        <label for="orderNote">Order notes</label>
        <input type="text" id="orderNote" placeholder="e.g. Leave at back door" />
      </div>

      <!-- Hidden select kept for internal logic -->
      <div style="display:none;">
        <label for="customerSelect">Customer</label>
        <select id="customerSelect">
          <option value="">-- Select customer --</option>
        </select>
      </div>

      <div class="cart-box">
        <div class="cart-box-header">Cart</div>
        <div class="cart-box-body">
          <div id="cartEmptyMsg" class="cart-empty">
            Cart is empty.
          </div>
          <div id="cartContainer" style="display:none; margin-top:0;">
            <table id="cartTable">
              <thead>
                <tr>
                  <th>Product</th>
                  <th class="text-right">Qty</th>
                  <th class="text-right">Price</th>
                  <th class="text-right">Line Total</th>
                  <th></th>
                </tr>
              </thead>
              <tbody></tbody>
              <tfoot>
                <tr>
                  <th colspan="3" class="text-right">Total</th>
                  <th class="text-right" id="orderTotalCell">$0.00</th>
                  <th></th>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>

      <div id="generateSection" class="generate-section hidden">
        <button class="btn-secondary generate-btn" id="generateSummaryBtn">
          Generate Purchase Order PDF
        </button>
      </div>

      <div class="order-actions-row">
        <button class="clear-order-link" id="clearOrderBtn">Clear Order</button>
        <button class="order-add-fab" id="goToAddItemBtn">Add New Item</button>
      </div>
    </div>

    <div id="addItemPage" class="hidden card">
      <div class="page-header-row">
        <h2>Add Item</h2>
<div style="display:flex; gap:6px;">
          <button class="btn-sm btn-ghost" id="addProductBtn">Add New Product</button>
          <button class="btn-sm btn-ghost" id="backToOrderBtn">&larr; Back to Order</button>
        </div>
      </div>
      <p class="muted">Pick a main category, then a subcategory, then choose a product and quantity.</p>
      <div class="row" style="margin-bottom:8px;">
        <div style="flex:1 1 100%;">
          <label for="productSearchInput" class="field-label">Search items</label>
          <input
            type="text"
            id="productSearchInput"
            placeholder="Search by SKU or name..."
          />
        </div>
      </div>
      <div class="items-split" id="itemsSplit">
        <div class="items-left">
          <div class="items-left-title muted" id="itemsLeftTitle">Categories</div>
          <div id="categoryGrid" class="category-grid"></div>
        </div>
        <div class="items-right">
          <div id="subcategoryGrid" class="subcategory-grid"></div>
          <div id="productList"></div>
        </div>
      </div>
    </div>
  </main>

  <!-- Sign-in modal -->
  <div id="loginModalBackdrop" class="modal-backdrop hidden">
    <div class="modal">
      <h2>Sign In</h2>
      <p>Sign in once on this device and it will remember you.</p>
      <label for="loginUsername">Username</label>
      <input type="text" id="loginUsername" />
      <label for="loginPassword">Password</label>
      <input type="password" id="loginPassword" />
      <div class="modal-actions">
        <button class="btn-ghost btn-sm" id="cancelLoginBtn">Cancel</button>
        <button class="btn-primary btn-sm" id="confirmLoginBtn">Sign In</button>
      </div>
    </div>
  </div>

  <!-- Settings modal -->
  <div id="settingsModalBackdrop" class="modal-backdrop hidden">
    <div class="modal">
      <h2>Settings</h2>
      <p>Update your email for purchase orders or change your password on this device.</p>
      <label for="settingsUsername">Username</label>
      <input type="text" id="settingsUsername" disabled />
      <label for="settingsEmail">Email for purchase orders</label>
      <input type="email" id="settingsEmail" placeholder="you@example.com" />
      <hr style="margin:12px 0;border:none;border-top:1px solid #e5e7eb;" />
      <h3 style="margin:0 0 6px;font-size:0.9rem;">Change password</h3>
      <p class="muted" style="margin-top:0;margin-bottom:6px;">Leave blank to keep your current password.</p>
      <label for="settingsCurrentPassword">Current password</label>
      <input type="password" id="settingsCurrentPassword" />
      <label for="settingsNewPassword">New password</label>
      <input type="password" id="settingsNewPassword" />
      <label for="settingsConfirmPassword">Confirm new password</label>
      <input type="password" id="settingsConfirmPassword" />
      <div class="modal-actions">
        <button class="btn-link btn-sm" id="signOutBtn" style="margin-right:auto;color:#b91c1c;">Sign out</button>
        <button class="btn-ghost btn-sm" id="cancelSettingsBtn">Cancel</button>
        <button class="btn-primary btn-sm" id="saveSettingsBtn">Save</button>
      </div>
    </div>
  </div>

  <!-- Purchase order preview -->
  <div id="poModalBackdrop" class="modal-backdrop hidden">
    <div class="modal">
      <h2>Purchase Order</h2>
      <p>Review this purchase order, then download a PDF or send it to <strong>sales@218supply.com</strong>.</p>
      <div id="poPreviewContainer" style="width:100%;height:260px;border:1px solid #d1d5db;border-radius:8px;overflow:hidden;background:#f9fafb;">
        <iframe id="poPreviewFrame" style="width:100%;height:100%;border:0;"></iframe>
      </div>
      <div class="modal-actions">
        <button class="btn-ghost btn-sm" id="closePoModalBtn">Close</button>
        <button class="btn-secondary btn-sm" id="downloadPoBtn">Download</button>
        <button class="btn-primary btn-sm" id="emailPoBtn">Send</button>
      </div>
    </div>
  </div>

  <!-- Add customer modal -->
  <div id="customerModalBackdrop" class="modal-backdrop hidden">
    <div class="modal">
      <h2>Add New Customer</h2>
      <p>New customers are saved on this device. Also add them later to your master CSV to keep them permanently.</p>
      <label for="newCustomerName">Customer Name</label>
      <input type="text" id="newCustomerName" />
      <label for="newCustomerId">Customer ID (optional)</label>
      <input type="text" id="newCustomerId" placeholder="e.g. CUST-0100" />
      <div class="modal-actions">
        <button class="btn-ghost btn-sm" id="cancelCustomerBtn">Cancel</button>
        <button class="btn-primary btn-sm" id="saveCustomerBtn">Save Customer</button>
      </div>
    </div>
  </div>

  <!-- Customer group modal -->
  <div id="customerGroupModalBackdrop" class="modal-backdrop hidden">
    <div class="modal">
      <h2 id="customerGroupModalTitle">Edit List</h2>
      <p class="muted">Tap to add or remove customers from this list.</p>
      <input
        type="text"
        id="customerGroupSearchInput"
        placeholder="Search customers..."
        aria-label="Search customers for this list"
      />
      <div id="customerGroupSelectList" class="customer-list"></div>
      <div class="modal-actions">
        <button class="btn-ghost btn-sm" id="cancelCustomerGroupBtn">Cancel</button>
        <button class="btn-primary btn-sm" id="saveCustomerGroupBtn">Save List</button>
      </div>
    </div>
  </div>

  <!-- Edit customer modal -->
  <div id="customerEditModalBackdrop" class="modal-backdrop hidden">
    <div class="modal">
      <h2>Edit Customer</h2>
      <p>Update this customer's details on this device.</p>
      <label for="editCustomerName">Customer Name</label>
      <input type="text" id="editCustomerName" />
      <label for="editCustomerId">Customer ID</label>
      <input type="text" id="editCustomerId" />
      <label for="editCustomerCity">City</label>
      <input type="text" id="editCustomerCity" />
      <label for="editCustomerState">State</label>
      <input type="text" id="editCustomerState" />
      <div class="modal-actions">
        <button class="btn-ghost btn-sm" id="cancelEditCustomerBtn">Cancel</button>
        <button class="btn-primary btn-sm" id="saveEditCustomerBtn">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- Customer profile modal -->
  <div id="customerProfileModalBackdrop" class="modal-backdrop hidden">
    <div class="modal">
      <h2>Customer Profile</h2>
      <p>View and update this customer's profile and see their order history on this device.</p>

      <div id="customerProfileSummary" class="muted" style="margin-bottom:8px;"></div>

      <h3 style="margin:8px 0 4px;font-size:0.9rem;">Contact & Details</h3>
      <label for="profileContactName">Contact Name</label>
      <input type="text" id="profileContactName" />

      <label for="profilePhone">Phone</label>
      <input type="text" id="profilePhone" />

      <label for="profileEmail">Email</label>
      <input type="email" id="profileEmail" />

      <label for="profileNotes">Notes</label>
      <textarea id="profileNotes" style="min-height:80px;"></textarea>

      <div class="row" style="margin-top:8px;">
        <div>
          <label for="profilePriceLevel">Price Level</label>
          <input type="text" id="profilePriceLevel" placeholder="e.g. Standard, Bar, VIP" />
        </div>
        <div style="display:flex;align-items:center;gap:6px;margin-top:22px;">
          <input type="checkbox" id="profileTaxExempt" style="width:auto;" />
          <label for="profileTaxExempt" style="margin:0;font-weight:500;">Tax Exempt</label>
        </div>
      </div>

      <h3 style="margin:10px 0 4px;font-size:0.9rem;">Address</h3>
      <label for="billingStreet">Street</label>
      <input type="text" id="billingStreet" />
      <div class="row">
        <div>
          <label for="billingCity">City</label>
          <input type="text" id="billingCity" />
        </div>
        <div>
          <label for="billingState">State</label>
          <input type="text" id="billingState" />
        </div>
        <div>
          <label for="billingZip">ZIP</label>
          <input type="text" id="billingZip" />
        </div>
      </div>

      <label for="profileLabels" style="margin-top:8px;">Labels (comma-separated)</label>
      <input type="text" id="profileLabels" placeholder="e.g. bar, downtown, late-night" />

      <h3 style="margin:10px 0 4px;font-size:0.9rem;">Order History</h3>
      <div id="customerProfileOrders" style="max-height:180px;overflow-y:auto;border:1px solid #e5e7eb;border-radius:8px;padding:6px 8px;background:#f9fafb;font-size:0.8rem;">
        <!-- filled by script -->
      </div>

      <div class="modal-actions">
        <button class="btn-ghost btn-sm" id="closeCustomerProfileBtn">Close</button>
        <button class="btn-primary btn-sm" id="saveCustomerProfileBtn">Save Profile</button>
      </div>
    </div>
  </div>

  <!-- Add product modal -->
  <div id="productModalBackdrop" class="modal-backdrop hidden">
    <div class="modal">
      <h2>Add New Product</h2>
      <p>New products are saved on this device. Also add them later to your products CSV.</p>
      <label for="newProdName">Product Name</label>
      <input type="text" id="newProdName" />
      <label for="newProdSku">SKU</label>
      <input type="text" id="newProdSku" />
      <label for="newProdCategory">Subcategory (e.g. Plates, Bowls, Napkins)</label>
      <input type="text" id="newProdCategory" />
      <label for="newProdPack">Pack Size (e.g. 96/CS)</label>
      <input type="text" id="newProdPack" />
      <label for="newProdPrice">Price (per case)</label>
      <input type="number" step="0.01" id="newProdPrice" />
      <div class="modal-actions">
        <button class="btn-ghost btn-sm" id="cancelProductBtn">Cancel</button>
        <button class="btn-primary btn-sm" id="saveProductBtn">Save Product</button>
      </div>
    </div>
  </div>

  <!-- libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="data.js"></script>
  <script src="products.generated.js"></script>
  <script src="customers.generated.js"></script>
<script>
  // Robustly remove category item counts like "25 items" wherever they appear in the Add Item UI.
  function stripItemCountsEverywhere() {
    // 1) Remove standalone nodes that are just "## items"
    document.querySelectorAll('span,div,small').forEach(el => {
      if (!el) return;
      const t = (el.textContent || '').trim();
      if (/^\d+\s*items$/i.test(t)) {
        el.style.display = 'none';
      }
    });

    // 2) Remove text nodes containing "## items" inside buttons (categories)
    document.querySelectorAll('button').forEach(btn => {
      if (!btn) return;
      // Only touch buttons that appear to be category buttons (contain "Categories" section nearby or have rounded pill styles)
      const raw = btn.textContent || '';
      if (!/\b\d+\s*items\b/i.test(raw)) return;

      btn.childNodes.forEach(node => {
        if (node.nodeType === Node.TEXT_NODE) {
          node.textContent = node.textContent.replace(/\s*\b\d+\s*items\b\s*/ig, ' ').replace(/\s+/g,' ').trim();
        }
      });

      // Also clean any remaining "## items" in descendants
      btn.querySelectorAll('*').forEach(ch => {
        if (ch.childNodes && ch.childNodes.length===1 && ch.childNodes[0].nodeType===Node.TEXT_NODE) {
          ch.textContent = ch.textContent.replace(/\s*\b\d+\s*items\b\s*/ig, ' ').replace(/\s+/g,' ').trim();
        }
      });
    });
  }

function isDesktopFlow(){ return window.matchMedia && window.matchMedia('(min-width: 1024px)').matches; }

    
function autoSizeQtyInput(input) {
  const len = input.value.length || 1;
  input.style.width = Math.max(28, len * 11) + "px";
}

document.addEventListener("DOMContentLoaded", () => {
      const startCard              = document.getElementById("startCard");
      const startOrderBtn          = document.getElementById("startOrderBtn");
      const startOptionsCard       = document.getElementById("startOptionsCard");
      const startSelectCustomerBtn = document.getElementById("startSelectCustomerBtn");
      const startCustomerListsBtn  = document.getElementById("startCustomerListsBtn");
      const orderMain              = document.getElementById("orderMain");
      const customerListsPage      = document.getElementById("customerListsPage");
      const customerListsDays      = document.getElementById("customerListsDays");
      const backFromCustomerListsBtn = document.getElementById("backFromCustomerListsBtn");
      const customerListGroupContainer = document.getElementById("customerListGroupContainer");
      const customerGroupTitle     = document.getElementById("customerGroupTitle");
      const customerGroupList      = document.getElementById("customerGroupList");
      const addItemPage            = document.getElementById("addItemPage");
const customerSelectPage     = document.getElementById("customerSelectPage");
      const customerList           = document.getElementById("customerList");
      const customerSearchInput    = document.getElementById("customerSearchInput");
      const addCustomerFromListBtn = document.getElementById("addCustomerFromListBtn");

      const customerSelect         = document.getElementById("customerSelect");
      const orderNoteInput         = document.getElementById("orderNote");
      const signInBtn              = document.getElementById("signInBtn");
      const signedInLabel          = document.getElementById("signedInLabel");
      const orderCustomerDisplay   = document.getElementById("orderCustomerDisplay");
      const changeCustomerBtn      = document.getElementById("changeCustomerBtn");
      const editCustomerBtn        = document.getElementById("editCustomerBtn");
      const customerProfileBtn     = document.getElementById("customerProfileBtn");
      const addItemBtn             = document.getElementById("goToAddItemBtn");
      const backToOrderBtn         = document.getElementById("backToOrderBtn");
      const categoryGrid           = document.getElementById("categoryGrid");
      const subcategoryGrid        = document.getElementById("subcategoryGrid");
      const productSearchInput     = document.getElementById("productSearchInput");
      const productList            = document.getElementById("productList");
      const productSearchRow       = productSearchInput ? productSearchInput.closest(".row") : null;
      const cartEmptyMsg           = document.getElementById("cartEmptyMsg");
      const cartContainer          = document.getElementById("cartContainer");
      const cartTableBody          = document.querySelector("#cartTable tbody");
      const orderTotalCell         = document.getElementById("orderTotalCell");
      const generateSection        = document.getElementById("generateSection");
      const generateSummaryBtn     = document.getElementById("generateSummaryBtn");
      const clearOrderBtn          = document.getElementById("clearOrderBtn");

      const loginModalBackdrop    = document.getElementById("loginModalBackdrop");
      const loginUsernameInput    = document.getElementById("loginUsername");
      const loginPasswordInput    = document.getElementById("loginPassword");
      const cancelLoginBtn        = document.getElementById("cancelLoginBtn");
      const confirmLoginBtn       = document.getElementById("confirmLoginBtn");

      const cartHeaderBtn           = document.getElementById("cartHeaderBtn");
      const settingsBtn              = document.getElementById("settingsBtn");
      const settingsModalBackdrop    = document.getElementById("settingsModalBackdrop");
      
      if (cartHeaderBtn) {
        cartHeaderBtn.addEventListener("click", () => {
          // Show main order view and scroll to cart
          orderMain.classList.remove("hidden");
          addItemPage.classList.add("hidden");
          const cartBox = document.getElementById("cartContainer");
          if (cartBox) {
            cartBox.scrollIntoView({ behavior: "smooth", block: "start" });
          }
        });
      }
      const settingsUsernameInput    = document.getElementById("settingsUsername");
      const settingsEmailInput       = document.getElementById("settingsEmail");
      const settingsCurrentPassword  = document.getElementById("settingsCurrentPassword");
      const settingsNewPassword      = document.getElementById("settingsNewPassword");
      const settingsConfirmPassword  = document.getElementById("settingsConfirmPassword");
      const cancelSettingsBtn        = document.getElementById("cancelSettingsBtn");
      const saveSettingsBtn          = document.getElementById("saveSettingsBtn");
      const signOutBtn               = document.getElementById("signOutBtn");

      const poModalBackdrop   = document.getElementById("poModalBackdrop");
      const poPreviewFrame    = document.getElementById("poPreviewFrame");
      const closePoModalBtn   = document.getElementById("closePoModalBtn");
      const downloadPoBtn     = document.getElementById("downloadPoBtn");
      const emailPoBtn        = document.getElementById("emailPoBtn");

      const customerModalBackdrop   = document.getElementById("customerModalBackdrop");
      const newCustomerNameInput    = document.getElementById("newCustomerName");
      const newCustomerIdInput      = document.getElementById("newCustomerId");
      const cancelCustomerBtn       = document.getElementById("cancelCustomerBtn");
      const saveCustomerBtn         = document.getElementById("saveCustomerBtn");

      const customerGroupModalBackdrop = document.getElementById("customerGroupModalBackdrop");
      const customerGroupModalTitle    = document.getElementById("customerGroupModalTitle");
      const customerGroupSearchInput   = document.getElementById("customerGroupSearchInput");
      const customerGroupSelectList    = document.getElementById("customerGroupSelectList");
      const cancelCustomerGroupBtn     = document.getElementById("cancelCustomerGroupBtn");
      const saveCustomerGroupBtn       = document.getElementById("saveCustomerGroupBtn");

      const customerEditModalBackdrop = document.getElementById("customerEditModalBackdrop");
      const editCustomerNameInput     = document.getElementById("editCustomerName");
      const editCustomerIdInput       = document.getElementById("editCustomerId");
      const editCustomerCityInput     = document.getElementById("editCustomerCity");
      const editCustomerStateInput    = document.getElementById("editCustomerState");
      const cancelEditCustomerBtn     = document.getElementById("cancelEditCustomerBtn");
      const saveEditCustomerBtn       = document.getElementById("saveEditCustomerBtn");

      const customerProfileModalBackdrop = document.getElementById("customerProfileModalBackdrop");
      const customerProfileSummary       = document.getElementById("customerProfileSummary");
      const profileContactNameInput      = document.getElementById("profileContactName");
      const profilePhoneInput            = document.getElementById("profilePhone");
      const profileEmailInput            = document.getElementById("profileEmail");
      const profileNotesInput            = document.getElementById("profileNotes");
      const profilePriceLevelInput       = document.getElementById("profilePriceLevel");
      const profileTaxExemptInput        = document.getElementById("profileTaxExempt");
      const billingStreetInput           = document.getElementById("billingStreet");
      const billingCityInput             = document.getElementById("billingCity");
      const billingStateInput            = document.getElementById("billingState");
      const billingZipInput              = document.getElementById("billingZip");
      const profileLabelsInput           = document.getElementById("profileLabels");
      const customerProfileOrdersEl      = document.getElementById("customerProfileOrders");
      const closeCustomerProfileBtn      = document.getElementById("closeCustomerProfileBtn");
      const saveCustomerProfileBtn       = document.getElementById("saveCustomerProfileBtn");

      const productModalBackdrop  = document.getElementById("productModalBackdrop");
      const newProdNameInput      = document.getElementById("newProdName");
      const newProdSkuInput       = document.getElementById("newProdSku");
      const newProdCategoryInput  = document.getElementById("newProdCategory");
      const newProdPackInput      = document.getElementById("newProdPack");
      const newProdPriceInput     = document.getElementById("newProdPrice");
      const cancelProductBtn      = document.getElementById("cancelProductBtn");
      const saveProductBtn        = document.getElementById("saveProductBtn");

      const addCustomerBtn = document.getElementById("addCustomerBtn"); // optional header button

      let currentUser = null;
      let currentUserProfile = null;
      let userProfiles = {};
      let cartItems = [];
      const CART_STORAGE_KEY = "orderpadCart_v1";

      function saveCartState() {
        try {
          const payload = {
            cartItems,
            customerId: customerSelect ? customerSelect.value || "" : "",
            orderNote: orderNoteInput ? orderNoteInput.value || "" : ""
          };
          localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(payload));
        } catch (e) {
          console.warn("Could not save cart state", e);
        }
      }

      function loadCartState() {
        try {
          const raw = localStorage.getItem(CART_STORAGE_KEY);
          if (!raw) return;
          const parsed = JSON.parse(raw);
          if (!parsed || typeof parsed !== "object") return;

          if (Array.isArray(parsed.cartItems)) {
            cartItems = parsed.cartItems
              .map(item => ({
                sku: (item.sku || "").toString(),
                name: item.name || "",
                packSize: item.packSize || "",
                price: Number(item.price || 0),
                qty: Number(item.qty || 0) || 1
              }))
              .filter(item => item.sku || item.name);
          }

          if (parsed.customerId && typeof customerSelect !== "undefined" && customerSelect) {
            customerSelect.value = parsed.customerId;
            const opt = customerSelect.options[customerSelect.selectedIndex];
            if (opt && typeof orderCustomerDisplay !== "undefined" && orderCustomerDisplay) {
              orderCustomerDisplay.textContent = opt.textContent || "No customer selected";
            }
            if (typeof addItemBtn !== "undefined" && addItemBtn) {
              addItemBtn.disabled = false;
            }
            if (typeof generateSummaryBtn !== "undefined" && generateSummaryBtn) {
              generateSummaryBtn.disabled = false;
            }
          }

          if (parsed.orderNote && typeof orderNoteInput !== "undefined" && orderNoteInput) {
            orderNoteInput.value = parsed.orderNote;
          }
        } catch (e) {
          console.warn("Could not load cart state", e);
        }
      }

      function clearCartState() {
        try {
          localStorage.removeItem(CART_STORAGE_KEY);
        } catch (e) {
          console.warn("Could not clear cart state", e);
        }
      }

      function addToCart(prod, qty) {
        if (!prod) return;
        const quantity = Math.max(1, parseInt(qty, 10) || 1);
        const sku = (prod.sku || "").trim();
        const name = getProductLabel(prod);
        const packSize = prod.packSize || "";
        const price = Number(prod.price || 0);

        // If SKU exists, merge by SKU; if SKU is blank, always create a new line item.
        let existingIndex = -1;
        if (sku) {
          existingIndex = cartItems.findIndex(item => item.sku === sku);
        }

        if (existingIndex >= 0) {
          cartItems[existingIndex].qty += quantity;
        } else {
          cartItems.push({
            sku,
            name,
            packSize,
            price,
            qty: quantity
          });
        }

        renderCart();
      }

      let customerProfiles = {};
      let editingCustomerObj = null;
      let currentProfileCustomerId = null;

      const CUSTOMER_GROUPS_KEY = "orderpadCustomerGroups_v1";
      let customerGroups = {
        Monday: [],
        Tuesday: [],
        Wednesday: [],
        Thursday: [],
        Friday: []
      };
      let activeGroupDay = null;

      function loadCustomerGroups() {
        customerGroups = {
          Monday: [],
          Tuesday: [],
          Wednesday: [],
          Thursday: [],
          Friday: []
        };
        try {
          const raw = localStorage.getItem(CUSTOMER_GROUPS_KEY);
          if (raw) {
            const parsed = JSON.parse(raw);
            if (parsed && typeof parsed === "object") {
              ["Monday","Tuesday","Wednesday","Thursday","Friday"].forEach(day => {
                if (Array.isArray(parsed[day])) {
                  customerGroups[day] = parsed[day].filter(id => typeof id === "string" && id);
                }
              });
            }
          }
        } catch (e) {
          console.warn("Could not load customer groups", e);
        }
      }

      function saveCustomerGroups() {
        try {
          localStorage.setItem(CUSTOMER_GROUPS_KEY, JSON.stringify(customerGroups));
        } catch (e) {
          console.warn("Could not save customer groups", e);
        }
      }

      function renderCustomerGroupsOverview() {
        if (!customerListsDays) return;
        customerListsDays.innerHTML = "";
        const days = ["Monday","Tuesday","Wednesday","Thursday","Friday"];
        const allCustomers = window.customers || [];

        days.forEach(day => {
          const ids = (customerGroups[day] || []).filter(Boolean);
          const count = ids.length;
          const button = document.createElement("button");
          button.type = "button";
          button.className = "customer-list-day-card";
          button.dataset.day = day;

          const nameEl = document.createElement("div");
          nameEl.className = "day-name";
          nameEl.textContent = day;

          const metaEl = document.createElement("div");
          metaEl.className = "day-meta";
          metaEl.textContent = count
            ? `${count} customer${count === 1 ? "" : "s"}`
            : "No customers yet";

          button.appendChild(nameEl);
          button.appendChild(metaEl);

          button.addEventListener("click", () => {
            openCustomerGroup(day);
          });

          customerListsDays.appendChild(button);
        });

        if (customerListGroupContainer) {
          customerListGroupContainer.classList.add("hidden");
        }
      }

      
      function openCustomerListsPage() {
        const desktopFlow = window.matchMedia && window.matchMedia("(min-width: 1024px)").matches;

        if (!desktopFlow) {
          startCard.classList.add("hidden");
        }

        startOptionsCard.classList.add("hidden");
        orderMain.classList.add("hidden");
        addItemPage.classList.add("hidden");
        customerSelectPage.classList.add("hidden");
        customerListsPage.classList.remove("hidden");
        renderCustomerGroupsOverview();
      }

      function openCustomerGroup(day) {
        activeGroupDay = day;
        if (!customerGroupTitle || !customerGroupList) return;
        customerGroupTitle.textContent = `${day} List`;
        renderCustomerGroupMembers(day);
        if (customerListGroupContainer) {
          customerListGroupContainer.classList.remove("hidden");
        }
      }

      function renderCustomerGroupMembers(day) {
        if (!customerGroupList) return;
        customerGroupList.innerHTML = "";
        const ids = (customerGroups[day] || []).filter(Boolean);
        if (!ids.length) {
          const empty = document.createElement("div");
          empty.className = "muted";
          empty.textContent = `No customers in the ${day} list yet. Tap "Edit List" to add some.`;
          customerGroupList.appendChild(empty);
          return;
        }
        const all = window.customers || [];
        ids.forEach(id => {
          const c = all.find(cust => cust.id === id);
          if (!c) return;
          const row = document.createElement("div");
          row.className = "customer-row";
          row.dataset.customerId = c.id;

          const main = document.createElement("div");
          main.className = "customer-row-main";

          const nameEl = document.createElement("div");
          nameEl.className = "customer-row-name";
          nameEl.textContent = c.name || c.id;
          main.appendChild(nameEl);

          const cityLabel =
            (c.city || "") +
            (c.state ? ((c.city ? ", " : "") + c.state) : "");

          if (cityLabel) {
            const cityEl = document.createElement("div");
            cityEl.className = "customer-row-city";
            cityEl.textContent = cityLabel;
            main.appendChild(cityEl);
          }

          row.appendChild(main);

          row.addEventListener("click", () => {
            selectCustomerAndGoToOrder(c.id);
          });

          customerGroupList.appendChild(row);
        });
      }

      function openCustomerGroupModal() {
        if (!activeGroupDay || !customerGroupModalBackdrop) return;
        customerGroupModalTitle.textContent = `Edit ${activeGroupDay} List`;
        customerGroupSearchInput.value = "";
        renderCustomerGroupSelectList();
        customerGroupModalBackdrop.classList.remove("hidden");
      }

      function closeCustomerGroupModal() {
        if (!customerGroupModalBackdrop) return;
        customerGroupModalBackdrop.classList.add("hidden");
      }

      function renderCustomerGroupSelectList() {
        if (!customerGroupSelectList) return;
        const search = (customerGroupSearchInput.value || "").toLowerCase();
        const all = window.customers || [];
        const inGroup = new Set((customerGroups[activeGroupDay] || []).filter(Boolean));
        customerGroupSelectList.innerHTML = "";

        const filtered = all.filter((c) => {
          const name = (c.name || "").toLowerCase();
          const id = (c.id || "").toLowerCase();
          const city = (c.city || "").toLowerCase();
          const state = (c.state || "").toLowerCase();
          return (
            !search ||
            name.includes(search) ||
            id.includes(search) ||
            city.includes(search) ||
            state.includes(search)
          );
        });

        if (!filtered.length) {
          const empty = document.createElement("div");
          empty.className = "muted";
          empty.textContent = "No customers found.";
          customerGroupSelectList.appendChild(empty);
          return;
        }

        filtered.forEach(c => {
          const row = document.createElement("div");
          row.className = "customer-row";
          row.dataset.customerId = c.id;

          const main = document.createElement("div");
          main.className = "customer-row-main";

          const nameEl = document.createElement("div");
          nameEl.className = "customer-row-name";
          nameEl.textContent = c.name || c.id;
          main.appendChild(nameEl);

          const cityLabel =
            (c.city || "") +
            (c.state ? ((c.city ? ", " : "") + c.state) : "");
          if (cityLabel) {
            const cityEl = document.createElement("div");
            cityEl.className = "customer-row-city";
            cityEl.textContent = cityLabel;
            main.appendChild(cityEl);
          }

          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.className = "customer-group-checkbox";
          checkbox.dataset.customerId = c.id;
          checkbox.checked = inGroup.has(c.id);
          checkbox.style.width = "auto";

          row.appendChild(main);
          row.appendChild(checkbox);

          row.addEventListener("click", (evt) => {
            if (evt.target === checkbox) return;
            checkbox.checked = !checkbox.checked;
          });

          customerGroupSelectList.appendChild(row);
        });
      }

      // ---- helpers ----
      function formatMoney(n) {
        return "$" + n.toFixed(2);
      }

      function loadUserProfiles() {
        try {
          const raw = localStorage.getItem("orderpadUserProfiles");
          if (raw) {
            const parsed = JSON.parse(raw);
            if (parsed && typeof parsed === "object") {
              userProfiles = parsed;
            }
          }
        } catch (e) {
          console.warn("Could not load user profiles", e);
          userProfiles = {};
        }
      }

      function saveUserProfiles() {
        try {
          localStorage.setItem("orderpadUserProfiles", JSON.stringify(userProfiles));
        } catch (e) {
          console.warn("Could not save user profiles", e);
        }
      }

      function loadCustomerProfiles() {
        try {
          const raw = localStorage.getItem("orderpadCustomerProfiles");
          if (raw) {
            const parsed = JSON.parse(raw);
            if (parsed && typeof parsed === "object") {
              customerProfiles = parsed;
            }
          }
        } catch (e) {
          console.warn("Could not load customer profiles", e);
          customerProfiles = {};
        }
      }

      function saveCustomerProfiles() {
        try {
          localStorage.setItem("orderpadCustomerProfiles", JSON.stringify(customerProfiles));
        } catch (e) {
          console.warn("Could not save customer profiles", e);
        }
      }

      function showSignedInState() {
        if (currentUser && currentUserProfile) {
          signInBtn.style.display = "none";
          signedInLabel.style.display = "inline";
          signedInLabel.textContent = `Signed in as ${currentUserProfile.username}`;
        } else {
          signInBtn.style.display = "inline-block";
          signedInLabel.style.display = "none";
          signedInLabel.textContent = "";
        }
      }

      function loadLocalData() {
        try {
          loadUserProfiles();
          loadCustomerProfiles();
          loadCustomerGroups();
          const storedUser = localStorage.getItem("orderpadUser") || localStorage.getItem("orderpadCurrentUser");
          if (storedUser) {
            currentUser = storedUser;
            currentUserProfile = userProfiles[storedUser] || { username: storedUser, email: "", password: "" };
            userProfiles[storedUser] = currentUserProfile;
          }
        } catch (e) {
          console.warn("LocalStorage not available", e);
          userProfiles = {};
        }

        showSignedInState();

        // load extra customers/products saved on this device
        try {
          const extraCust = localStorage.getItem("orderpadExtraCustomers");
          if (extraCust) {
            const parsed = JSON.parse(extraCust);
            if (Array.isArray(parsed)) window.customers.push(...parsed);
          }
        } catch {}

        try {
          const extraProd = localStorage.getItem("orderpadExtraProducts");
          if (extraProd) {
            const parsed = JSON.parse(extraProd);
            if (Array.isArray(parsed)) window.products.push(...parsed);
          }
        } catch {}

        // Seed CHIPS products (bag prices + one mixed case)
        window.products = window.products || [];
        const chipSeedProducts = [
          { sku: "CHP-FL-ORIG",  name: "Frito Original",                  category: "CHIPS", subcategory: "FRITO LAY", packSize: "64/cs â€¢ 2 oz",    price: 1.00 },
          { sku: "CHP-FL-CHILI", name: "Frito Chili Cheese",             category: "CHIPS", subcategory: "FRITO LAY", packSize: "64/cs â€¢ 2 oz",    price: 1.00 },
          { sku: "CHP-FL-HBBQ",  name: "Frito HBBQ Twist",               category: "CHIPS", subcategory: "FRITO LAY", packSize: "64/cs â€¢ 2 oz",    price: 1.00 },
          { sku: "CHP-FL-FUNY",  name: "Funyuns",                        category: "CHIPS", subcategory: "FRITO LAY", packSize: "64/cs â€¢ 1.75 oz", price: 1.00 },
          { sku: "CHP-FL-NDOR",  name: "Nacho Doritos",                  category: "CHIPS", subcategory: "FRITO LAY", packSize: "64/cs â€¢ 1.75 oz", price: 1.00 },
          { sku: "CHP-FL-CDOR",  name: "Cool Ranch Doritos",            category: "CHIPS", subcategory: "FRITO LAY", packSize: "64/cs â€¢ 1.75 oz", price: 1.00 },
          { sku: "CHP-FL-CHET",  name: "Cheetos",                        category: "CHIPS", subcategory: "FRITO LAY", packSize: "64/cs â€¢ 1.75 oz", price: 1.00 },
          { sku: "CHP-FL-PRET",  name: "Rold Gold Pretzels Tiny Twists", category: "CHIPS", subcategory: "FRITO LAY", packSize: "64/cs â€¢ 1.75 oz", price: 1.00 },
          { sku: "CHP-FL-RUFF",  name: "Ruffles Cheddar & Sour Cream",   category: "CHIPS", subcategory: "FRITO LAY", packSize: "64/cs â€¢ 1.75 oz", price: 1.00 },

          { sku: "CHP-OD-ORIG",  name: "Old Dutch Original Potato Chips", category: "CHIPS", subcategory: "OLD DUTCH", packSize: "25/cs â€¢ 2 oz",   price: 1.00 },
          { sku: "CHP-OD-SCNO",  name: "Old Dutch Sour Cream & Onion",    category: "CHIPS", subcategory: "OLD DUTCH", packSize: "25/cs â€¢ 2 oz",   price: 1.00 },
          { sku: "CHP-OD-BBQ",   name: "Old Dutch Barbeque",              category: "CHIPS", subcategory: "OLD DUTCH", packSize: "25/cs â€¢ 2 oz",   price: 1.00 },
          { sku: "CHP-OD-OAG",   name: "Old Dutch Onion & Garlic",        category: "CHIPS", subcategory: "OLD DUTCH", packSize: "25/cs â€¢ 2 oz",   price: 1.00 },
          { sku: "CHP-OD-DILL",  name: "Old Dutch Dill Pickle",           category: "CHIPS", subcategory: "OLD DUTCH", packSize: "25/cs â€¢ 2 oz",   price: 1.00 },

          { sku: "CHP-TGIF-BAC", name: "TGIF Cheddar Bacon Skins",        category: "CHIPS", subcategory: "INVENTURE", packSize: "55/cs",          price: 1.00 },
          { sku: "CHP-TGIF-SCCH",name: "TGIF Sour Cream & Cheddar Skins", category: "CHIPS", subcategory: "INVENTURE", packSize: "55/cs",          price: 1.00 },

          { sku: "CHP-CHEEZ-ORIG", name: "Cheez-It Original",             category: "CHIPS", subcategory: "GENERAL MILLS/KEEBLER", packSize: "60/cs â€¢ 1.75 oz", price: 1.00 },
          { sku: "CHP-CHEEZ-JACK", name: "Cheez-It Cheddar Jack",         category: "CHIPS", subcategory: "GENERAL MILLS/KEEBLER", packSize: "60/cs â€¢ 1.75 oz", price: 1.00 },

          { sku: "CHP-SAL-ROUND", name: "Salista's Tortilla Rounds",      category: "CHIPS", subcategory: "SALISTA'S", packSize: "50/cs â€¢ 1 oz",   price: 1.00 },
          { sku: "CHP-SAL-SPICY", name: "Spicy Salista's Tortilla Rounds",category: "CHIPS", subcategory: "SALISTA'S", packSize: "50/cs â€¢ 1 oz",   price: 1.00 },

          { sku: "CHP-EAR-125-CHED",  name: "Earl's Cheddar Cheese Popcorn ($1.25 SRP)", category: "CHIPS", subcategory: "EARL'S $1.25", packSize: "36/cs â€¢ ~1.75 oz", price: 0.83 },
          { sku: "CHP-EAR-125-CARM",  name: "Earl's Caramel Popcorn ($1.25 SRP)",        category: "CHIPS", subcategory: "EARL'S $1.25", packSize: "36/cs â€¢ ~1.75 oz", price: 0.83 },
          { sku: "CHP-EAR-125-PUFF",  name: "Earl's Cheese Puffs ($1.25 SRP)",           category: "CHIPS", subcategory: "EARL'S $1.25", packSize: "36/cs â€¢ ~1.75 oz", price: 0.83 },

          { sku: "CHP-EAR-159-CHED",  name: "Earl's Cheese Popcorn ($1.59 SRP)",         category: "CHIPS", subcategory: "EARL'S $1.59", packSize: "12/cs â€¢ 5.5 oz",  price: 1.06 },
          { sku: "CHP-EAR-159-CARM",  name: "Earl's Caramel Corn ($1.59 SRP)",           category: "CHIPS", subcategory: "EARL'S $1.59", packSize: "18/cs â€¢ 6 oz",    price: 1.06 },
          { sku: "CHP-EAR-159-TRIP",  name: "Earl's Triple Treat Popcorn ($1.59 SRP)",   category: "CHIPS", subcategory: "EARL'S $1.59", packSize: "24/cs",           price: 1.06 },

          { sku: "CHP-OD-219-BSPIN",  name: "Old Dutch Butter Spindle Pretzels ($2.19 SRP)", category: "CHIPS", subcategory: "OLD DUTCH $2.19", packSize: "25/cs â€¢ 4 oz", price: 1.55 },

          // Mixed case â€“ sold as a 30-bag case for $30
          { sku: "CHP-MIX-30CASE", name: "Mixed Chips Case â€“ 30 bags", category: "CHIPS", subcategory: "MIXED", packSize: "30 bags/case", price: 30.00 }
        ];

        chipSeedProducts.forEach(seed => {
          const exists = (window.products || []).some(p => p.sku === seed.sku);
          if (!exists) window.products.push(seed);
        });

        try {
          loadCustomerEditsAndApply();
        } catch (e) {
          console.warn("Unable to apply customer edits", e);
        }
      }

      function saveExtraCustomers(customers) {
        try {
          localStorage.setItem("orderpadExtraCustomers", JSON.stringify(customers));
        } catch {}
      }

      function saveExtraProducts(products) {
        try {
          localStorage.setItem("orderpadExtraProducts", JSON.stringify(products));
        } catch {}
      }

      const CUSTOMER_EDITS_KEY = "orderpadCustomerEdits";

      let customerEdits = {};

      function loadCustomerEditsAndApply() {
        customerEdits = {};
        try {
          const stored = localStorage.getItem(CUSTOMER_EDITS_KEY);
          if (stored) {
            const parsed = JSON.parse(stored);
            if (parsed && typeof parsed === "object") {
              customerEdits = parsed;
            }
          }
        } catch (e) {
          console.warn("Unable to load customer edits", e);
          customerEdits = {};
        }

        if (Array.isArray(window.customers)) {
          window.customers.forEach((c) => {
            const edit = customerEdits[c.id];
            if (edit) {
              if (edit.name)  c.name  = edit.name;
              if (edit.city)  c.city  = edit.city;
              if (edit.state) c.state = edit.state;
            }
          });
        }
      }

      function saveCustomerEditFor(id, data) {
        if (!id) return;
        if (!customerEdits || typeof customerEdits !== "object") {
          customerEdits = {};
        }
        const existing = customerEdits[id] || {};
        customerEdits[id] = Object.assign({}, existing, data || {});
        try {
          localStorage.setItem(CUSTOMER_EDITS_KEY, JSON.stringify(customerEdits));
        } catch (e) {
          console.warn("Unable to save customer edits", e);
        }
      }

      function getSortedCustomers() {
        return (window.customers || []).slice().sort((a, b) =>
          (a.name || "").localeCompare(b.name || "")
        );
      }

      function populateCustomers() {
        const sorted = getSortedCustomers();
        customerSelect.innerHTML = '<option value="">-- Select customer --</option>';
        for (const c of sorted) {
          const opt = document.createElement("option");
          opt.value = c.id;
          opt.textContent = c.name;
          customerSelect.appendChild(opt);
        }
      }

      function renderCustomerList() {
        const listEl = document.getElementById("customerList");
        if (!listEl) return;

        const search = (customerSearchInput.value || "").toLowerCase();
        const all = window.customers || [];
        listEl.innerHTML = "";

        const filtered = all.filter((c) => {
          const name = (c.name || "").toLowerCase();
          const id = (c.id || "").toLowerCase();
          const city = (c.city || "").toLowerCase();
          const state = (c.state || "").toLowerCase();
          return (
            !search ||
            name.includes(search) ||
            id.includes(search) ||
            city.includes(search) ||
            state.includes(search)
          );
        });

        if (!filtered.length) {
          const empty = document.createElement("div");
          empty.textContent = "No customers found.";
          empty.className = "muted";
          listEl.appendChild(empty);
          return;
        }

        filtered.forEach((c) => {
          const row = document.createElement("div");
          row.className = "customer-row";
          row.dataset.customerId = c.id;

          const main = document.createElement("div");
          main.className = "customer-row-main";

          const nameEl = document.createElement("div");
          nameEl.className = "customer-row-name";
          nameEl.textContent = c.name || c.id;

          main.appendChild(nameEl);
          row.appendChild(main);

          const cityLabel =
            (c && c.city ? c.city : "") +
            (c && c.state ? (c.city ? ", " : "") + c.state : "");

          if (cityLabel) {
            const cityEl = document.createElement("div");
            cityEl.className = "customer-row-city";
            cityEl.textContent = cityLabel;
            row.appendChild(cityEl);
          }

          row.addEventListener("click", () => {
            selectCustomerAndGoToOrder(c.id);
          });

          listEl.appendChild(row);
        });
      }

      function selectCustomerAndGoToOrder(customerId) {
        customerSelect.value = customerId || "";
        const hasCustomer = !!customerSelect.value;
        addItemBtn.disabled = !hasCustomer;
        generateSummaryBtn.disabled = !hasCustomer;

        // Update visible customer name
        if (orderCustomerDisplay && window.customers) {
          const found = (window.customers || []).find(c => c.id === customerId);
          orderCustomerDisplay.textContent = found && found.name ? found.name : "Customer selected";
        }

        const desktopFlow = window.matchMedia && window.matchMedia("(min-width: 1024px)").matches;

        if (desktopFlow) {
          // Desktop: keep earlier steps visible and reveal next panels
          customerSelectPage.classList.remove("hidden");
          addItemPage.classList.remove("hidden");
          orderMain.classList.remove("hidden");
          // Avoid focusing inputs (no surprise scroll/focus)
          return;
        }

        // Mobile: step flow
        customerSelectPage.classList.add("hidden");
        orderMain.classList.remove("hidden");
        // Avoid auto-focus to prevent mobile keyboard pop
      }
      const MAIN_CATEGORIES = [
        "Paper",
        "Janitorial",
        "Bar & Restaurant",
        "Snacks & Candy",
        "Beverages",
        "Office & Breakroom",
        "Kitchen Essentials",
        "Seasonal / Specialty"
      ];

      const SNACKS_SUBCATEGORIES = [
        "Chips",
        "Earls",
        "Candy",
        "Jerky",
        "Nuts",
        "Meat Sticks"
      ];

      let currentMainCategory = null;
      let currentSubcategory = null;
      let openCategoryCard = null;

      function inferMainCategoryFromLegacy(category, name) {
        const c = (category || "").toUpperCase().trim();
        const n = (name || "").toUpperCase();

        // Janitorial
        if (["CANLINER", "CAN LINER"].includes(c)) return "Janitorial";
        if (["CLEAN", "SOAP", "SANITIZER"].includes(c)) return "Janitorial";
        if (["GLOVE"].includes(c)) return "Janitorial";

        // Paper (towels, toilet paper, tissues, napkins)
        if (
          ["PAPER", "TISSUE", "NAPKIN", "TOWEL"].includes(c) ||
          /TOWEL/.test(n) ||
          /(BATH TISSUE|TOILET)/.test(n)
        ) {
          return "Paper";
        }

        // Bar & Restaurant (bar mixers, cherries, straws, etc.)
        if (["BAR", "STRAWS"].includes(c)) return "Bar & Restaurant";

        // Snacks & Candy (chips, candy, meat snacks, popcorn, nuts)
        if (["CHIPS", "CANDY", "SNACKS", "MEAT SNACKS"].includes(c)) return "Snacks & Candy";
        if (/(CHIPS|DORITOS|CHEETOS|FRITOS|RUFFLES)/.test(n)) return "Snacks & Candy";
        if (/(CANDY|GUM|M&M|REESE|SNICKERS|HERSHEY)/.test(n)) return "Snacks & Candy";
        if (/(JERKY|MEAT STICK|MEAT SNACK|PEPPERONI)/.test(n)) return "Snacks & Candy";
        if (/(POPCORN)/.test(n)) return "Snacks & Candy";
        if (/(NUTS|PEANUT|ALMOND|CASHEW|SEEDS)/.test(n)) return "Snacks & Candy";

        // Beverages & Breakroom beverages
        if (["BEVERAGE", "DRINK"].includes(c)) return "Beverages";
        if (
          /(SODA|COLA|ROOT BEER|MTN DEW|PEPSI|COKE|DR PEPPER|SPRITE|SIERRA MIST)/.test(n) ||
          /(ENERGY|MONSTER|RED BULL|NOS|ROCKSTAR)/.test(n) ||
          /(GATORADE|POWERADE)/.test(n) ||
          /(JUICE|LEMONADE|ICED TEA)/.test(n)
        ) {
          return "Beverages";
        }
        if (/(COFFEE|CREAMER)/.test(n)) return "Office & Breakroom";

        // Office & Breakroom (generic)
        if (["OFFICE", "BREAKROOM"].includes(c)) return "Office & Breakroom";

        // Kitchen Essentials (plates, bowls, cups, containers, trays, wraps, bags, cutlery)
        if (
          [
            "PLATE",
            "BOWL",
            "CUP",
            "SOUFFLE",
            "CONTAINER",
            "FOOD TRAY",
            "MEAT TRAY",
            "TAKEOUT",
            "CUTLERY",
            "BAG",
            "FILM",
            "FOIL",
            "FREEZER"
          ].includes(c)
        ) {
          return "Kitchen Essentials";
        }

        // Default: treat as Kitchen Essentials instead of throwing things into Seasonal by accident
        return "Kitchen Essentials";
      }

      function getMainCategory(prod) {
        const cat = (prod.category || "").trim();
        return cat || "Other";
      }

      function getSnacksSubcategory(prod) {
        const name = (prod.name || "").toUpperCase();
        const cat  = (prod.category || "").toUpperCase();
        const sub  = (prod.subcategory || "").toUpperCase();
        const sku  = (prod.sku || "").toUpperCase();
        const price = Number(prod.price || 0);

        // 1) $1 rule: any $1.00 Snacks & Candy item goes to Chips
        if (Math.abs(price - 1.0) < 0.0001) {
          return "Chips";
        }

        // 2) Earls â€“ brand-based
        if (/EARL'?S/.test(name) || sub.includes("EARL") || sku.startsWith("CHP-EAR-")) {
          return "Earls";
        }

        // 3) Jerky
        if (/JERKY/.test(name)) {
          return "Jerky";
        }

        // 4) Meat Sticks â€“ Old World + Kickass sticks, pepperoni, etc.
        if (/(MEAT STICK|SNACK STICK|MEAT SNACK|SAUSAGE STICK|PEPPERONI)/.test(name)) {
          return "Meat Sticks";
        }

        // 5) Nuts â€“ nuts, mixes, seeds
        if (/(NUTS?\b|PEANUT|ALMOND|CASHEW|PISTACHIO|TRAIL MIX|SUNFLOWER SEEDS?)/.test(name)) {
          return "Nuts";
        }

        // 6) Chips â€“ salty snacks not already classified
        if (
          cat === "CHIPS" ||
          /(CHIP\b|DORITOS|CHEETOS|FRITOS|RUFFLES|PRETZEL|SNACK MIX|CORN NUTS?)/.test(name)
        ) {
          return "Chips";
        }

        // 7) Candy â€“ everything else sweet
        if (
          /(CANDY|GUM|MINT|CHOCOLATE|SNICKERS|TWIX|MARS|HERSHEY|REESE|M&M|SKITTLES|STARBURST|KIT KAT)/.test(name) ||
          sub.includes("CANDY")
        ) {
          return "Candy";
        }

        // Fallback â€“ default to Candy for any leftover sweets
        return "Candy";
      }

function getSubcategory(prod) {
        const sub = (prod.subcategory || "").trim();
        return sub || "Other";
      }

      function getProductLabel(prod) {
        const sku = (prod.sku || "").trim();
        let baseName = (prod.name || "").trim();
        const legacyCat = (prod.category || "").toUpperCase().trim();

        // For Snacks & Candy, never show raw SKU as part of the label
        if (getMainCategory(prod) === "Snacks & Candy") {
          if (legacyCat === "MEAT SNACKS") {
            const price = Number(prod.price || 0);
            const brand = Math.abs(price - 18) < 0.01 ? "Old World Meats" : "Kickass";
            if (brand && baseName) return brand + " " + baseName;
          }
          return baseName;
        }

        let prefix = sku;
        if (legacyCat === "MEAT SNACKS") {
          const price = Number(prod.price || 0);
          const brand = Math.abs(price - 18) < 0.01 ? "Old World Meats" : "Kickass";
          prefix = brand;
        }

        if (prefix && baseName) return prefix + " " + baseName;
        if (prefix) return prefix;
        return baseName;
      }

      function buildCategories() {
        categoryGrid.innerHTML = "";
        subcategoryGrid.innerHTML = "";

        if (productSearchRow) {
          productSearchRow.style.display = "";
        }

        const catSet = new Set();
        const countsByCat = {};
        (window.products || []).forEach(p => {
          const cat = getMainCategory(p);
          catSet.add(cat);
          countsByCat[cat] = (countsByCat[cat] || 0) + 1;
        });

        const cats = MAIN_CATEGORIES.filter(c => catSet.has(c));
        if (!cats.length) {
          const p = document.createElement("p");
          p.className = "muted";
          p.textContent = "No categories yet.";
          categoryGrid.appendChild(p);
          return;
        }

        if (!currentMainCategory || !cats.includes(currentMainCategory)) {
          currentMainCategory = null;
        }

        
        // Desktop: two-lane Items layout (category list on left, products on right)
        if (isDesktopFlow()) {
          cats.forEach(cat => {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "cat-row";
            btn.dataset.category = cat;

            const left = document.createElement("span");
            left.textContent = cat;

            const right = document.createElement("span");
            right.className = "cat-meta";
            const count = countsByCat[cat] || 0;
            right.textContent = count ? `${count} item${count === 1 ? "" : "s"}` : "";

            btn.appendChild(left);
            btn.appendChild(right);

            btn.addEventListener("click", () => {
              currentMainCategory = cat;
              currentSubcategory = null;

              categoryGrid.querySelectorAll(".cat-row").forEach(b => b.classList.remove("active"));
              btn.classList.add("active");

              buildSubcategories();
              showProductsForCategory();
            });

            categoryGrid.appendChild(btn);
          });

          // Keep selection highlighted if already chosen
          if (currentMainCategory) {
            const active = categoryGrid.querySelector(`.cat-row[data-category="${currentMainCategory}"]`);
            if (active) active.classList.add("active");
          }

          buildSubcategories();
          showProductsForCategory();
          return;
        }

        // Mobile/tablet: accordion list
        cats.forEach(cat => {
          const card = document.createElement("div");
          card.className = "accordion-card";
          card.dataset.category = cat;

          const header = document.createElement("button");
          header.type = "button";
          header.className = "accordion-header";

          const headerMain = document.createElement("div");
          headerMain.className = "accordion-header-main";

          const titleEl = document.createElement("div");
          titleEl.className = "accordion-title";
          titleEl.textContent = cat;

          const metaEl = document.createElement("div");
          metaEl.className = "accordion-meta";
          const count = countsByCat[cat] || 0;
          metaEl.textContent = "Tap to view";

          headerMain.appendChild(titleEl);
          headerMain.appendChild(metaEl);

          const chev = document.createElement("div");
          chev.className = "accordion-chev";
          chev.textContent = "â–¾";

          header.appendChild(headerMain);
          header.appendChild(chev);

          const body = document.createElement("div");
          body.className = "accordion-body";

          header.addEventListener("click", () => {
            card.classList.toggle("open");
            currentMainCategory = cat;
            currentSubcategory = null;
            buildSubcategories();
            showProductsForCategory();
          });

          card.appendChild(header);
          card.appendChild(body);
          categoryGrid.appendChild(card);
        });

      }

function buildSubcategories() {
        subcategoryGrid.innerHTML = "";
        if (!currentMainCategory) return;

        const subsSet = new Set();
        (window.products || []).forEach(p => {
          if (getMainCategory(p) === currentMainCategory) {
            subsSet.add(getSubcategory(p));
          }
        });

        const subs = Array.from(subsSet).sort((a, b) => a.localeCompare(b));
        if (!subs.length) return;

        if (!currentSubcategory || !subs.includes(currentSubcategory)) {
          currentSubcategory = null;
        }

        subs.forEach(sub => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "subcat-chip" + (sub === currentSubcategory ? " active" : "");
          btn.textContent = sub;
          btn.addEventListener("click", () => {
            if (currentSubcategory === sub) {
              currentSubcategory = null;
              document
                .querySelectorAll("#subcategoryGrid .subcat-chip")
                .forEach(b => b.classList.remove("active"));
            } else {
              currentSubcategory = sub;
              document
                .querySelectorAll("#subcategoryGrid .subcat-chip")
                .forEach(b => b.classList.remove("active"));
              btn.classList.add("active");
            }
            showProductsForCategory();
          });
          subcategoryGrid.appendChild(btn);
        });
      }

function showProductsForCategory() {
        productList.innerHTML = "";
        const term = (productSearchInput && productSearchInput.value || "").trim().toLowerCase();
        const allProducts = window.products || [];

        if (!currentMainCategory) {
          const msg = document.createElement("p");
          msg.className = "muted";
          msg.textContent = "Pick a category to see products.";
          productList.appendChild(msg);
          return;
        }

        // Always respect the product's real category:
        //  - Search looks at ALL products
        //  - But results are only shown inside the category they actually belong to
        let filtered = allProducts.filter(p => {
          if (getMainCategory(p) !== currentMainCategory) return false;

          // Apply subcategory filter if one is selected
          if (currentSubcategory) {
            if (getSubcategory(p) !== currentSubcategory) return false;
          }

          if (!term) return true;

          const label = getProductLabel(p).toLowerCase();
          const meta  = (p.packSize || "").toLowerCase();
          const sku   = (p.sku || "").toLowerCase();

          return (
            label.includes(term) ||
            meta.includes(term) ||
            sku.includes(term)
          );
        });

        if (!filtered.length) {
          const p = document.createElement("p");
          p.className = "muted";
          p.textContent = "No products match this selection yet.";
          productList.appendChild(p);
          return;
        }

        filtered
          .sort((a, b) => getProductLabel(a).localeCompare(getProductLabel(b)))
          .forEach(prod => {
            const row = document.createElement("div");
            row.className = "product-row";

            const main = document.createElement("div");
            main.className = "product-main";

            const nameEl = document.createElement("div");
            nameEl.className = "product-name";
            nameEl.textContent = getProductLabel(prod);

            const metaEl = document.createElement("div");
            metaEl.className = "product-meta";
            if (getMainCategory(prod) === "Snacks & Candy") {
              const pack = prod.packSize || "";
              const priceStr = formatMoney(prod.price || 0);
              metaEl.textContent = pack ? `${pack} â€¢ ${priceStr}` : priceStr;
            } else {
              metaEl.textContent = `SKU ${prod.sku} â€¢ ${prod.packSize || ""} â€¢ ${formatMoney(
                prod.price || 0
              )}`;
            }

            // Start collapsed â€“ hide details until row is expanded
            metaEl.style.display = "none";

            main.appendChild(nameEl);
            main.appendChild(metaEl);

            // Toggle expanded details on tap of the left side
            main.addEventListener("click", () => {
              const expanded = row.classList.toggle("expanded");
              metaEl.style.display = expanded ? "block" : "none";
            });

            const controls = document.createElement("div");
            controls.className = "product-controls";

            const qtyInput = document.createElement("input");
            qtyInput.type = "number";
            qtyInput.min = "1";
            qtyInput.step = "1";
            qtyInput.value = "1";
            qtyInput.style.display = "none";

            // Qty stepper: â€“ 1 +
            const stepper = document.createElement("div");
            stepper.className = "qty-stepper";

            const minusBtn = document.createElement("button");
            minusBtn.type = "button";
            minusBtn.className = "qty-minus";
            minusBtn.textContent = "â€“";
            minusBtn.setAttribute("aria-label", "Decrease quantity");

            const valueEl = document.createElement("span");
            valueEl.className = "qty-value";
            valueEl.textContent = "1";

            const plusBtn = document.createElement("button");
            plusBtn.type = "button";
            plusBtn.className = "qty-plus";
            plusBtn.textContent = "+";
            plusBtn.setAttribute("aria-label", "Increase quantity");

            const syncQty = (next) => {
              const n = Math.max(1, Math.min(999, Number(next) || 1));
              qtyInput.value = String(n);
              valueEl.textContent = String(n);
            };

            minusBtn.addEventListener("click", () => syncQty(Number(qtyInput.value) - 1));
            plusBtn.addEventListener("click", () => syncQty(Number(qtyInput.value) + 1));

            stepper.appendChild(minusBtn);
            stepper.appendChild(valueEl);
            stepper.appendChild(plusBtn);

            // Keep qtyInput in DOM so existing add-to-cart logic keeps working
            controls.appendChild(qtyInput);
            controls.appendChild(stepper);


            const addBtn = document.createElement("button");
            addBtn.textContent = "Add";
            addBtn.className = "btn-sm btn-primary";
            addBtn.addEventListener("click", () => {
              const qty = parseInt(qtyInput.value, 10) || 1;
              addToCart(prod, qty);
            });

            controls.appendChild(addBtn);

            row.appendChild(main);
            row.appendChild(controls);

            productList.appendChild(row);
          });
      }

function renderCart() {
        const cartTableBody = document.querySelector("#cartTable tbody");
        const cartContainer = document.getElementById("cartContainer");
        const cartEmptyMsg = document.getElementById("cartEmptyMsg");
        const orderTotalCell = document.getElementById("orderTotalCell");
        const generateSection = document.getElementById("generateSection");

        const totalUnits = cartItems.reduce((sum, item) => sum + (item.qty || 0), 0);
        if (typeof cartHeaderBtn !== "undefined" && cartHeaderBtn) {
          cartHeaderBtn.textContent = `ðŸ›’ (${totalUnits})`;
        }

        cartTableBody.innerHTML = "";

        if (cartItems.length === 0) {
          cartContainer.style.display = "none";
          cartEmptyMsg.style.display = "block";
          orderTotalCell.textContent = "$0.00";
          generateSection.classList.add("hidden");
          return;
        }

        cartContainer.style.display = "block";
        cartEmptyMsg.style.display = "none";

        cartItems.forEach((item, index) => {
          const tr = document.createElement("tr");
          const tdProd = document.createElement("td");
          const tdQty = document.createElement("td");
          const tdPrice = document.createElement("td");
          const tdLine = document.createElement("td");
          const tdRemove = document.createElement("td");

          tdProd.textContent = `${item.sku} â€“ ${item.name}`;
          tdQty.textContent = item.qty;
          tdQty.className = "text-right";
          tdPrice.textContent = formatMoney(item.price);
          tdPrice.className = "text-right";

          const priceCents = Math.round((item.price || 0) * 100);
          const lineTotalCents = priceCents * item.qty;
          const lineTotal = lineTotalCents / 100;
          tdLine.textContent = formatMoney(lineTotal);
          tdLine.className = "text-right";

          const removeBtn = document.createElement("button");
          removeBtn.textContent = "Ã—";
          removeBtn.className = "btn-sm btn-ghost";
          removeBtn.addEventListener("click", () => {
            cartItems.splice(index, 1);
            renderCart();
          });
          tdRemove.appendChild(removeBtn);
          tdRemove.className = "text-right";

          tr.appendChild(tdProd);
          tr.appendChild(tdQty);
          tr.appendChild(tdPrice);
          tr.appendChild(tdLine);
          tr.appendChild(tdRemove);

          cartTableBody.appendChild(tr);
        });

        const totals = computeTotals();
        orderTotalCell.textContent = formatMoney(totals.subtotal);
        generateSection.classList.remove("hidden");
        saveCartState();
      }

      function clearOrder() {
        if (!cartItems.length && !customerSelect.value && !orderNoteInput.value) return;
        if (!confirm("Clear this order?")) return;
        cartItems = [];
        renderCart();
        customerSelect.value = "";
        orderCustomerDisplay.textContent = "No customer selected";
        orderNoteInput.value = "";
        addItemBtn.disabled = true;
        generateSummaryBtn.disabled = true;
        clearCartState();
      }

      function computeTotals() {
        let subtotalCents = 0;

        cartItems.forEach((item) => {
          const priceCents = Math.round((item.price || 0) * 100);
          const lineTotalCents = priceCents * item.qty;
          subtotalCents += lineTotalCents;
        });

        const taxRate = 0.07375;
        const taxCents = Math.round(subtotalCents * taxRate);
        const grandCents = subtotalCents + taxCents;

        return {
          subtotal: subtotalCents / 100,
          taxAmount: taxCents / 100,
          grandTotal: grandCents / 100
        };
      }

      function buildPoText() {
        const customerId = customerSelect.value || "";
        const customerObj = (window.customers || []).find(c => c.id === customerId);
        const customerName = customerObj?.name || "";
        const note = orderNoteInput.value || "";
        const now = new Date();
        const dateStr = now.toISOString().slice(0, 10);

        const salespersonName = currentUser || "Not signed in";
        const salespersonEmail = (currentUserProfile && currentUserProfile.email) || "Not set";

        const headerLines = [
          "218 SUPPLY â€“ PURCHASE ORDER",
          "----------------------------------------",
          "Date: " + dateStr,
          "Salesperson: " + salespersonName,
          "Salesperson Email: " + salespersonEmail,
          "Customer: " + (customerName || "N/A") + (customerId ? " (" + customerId + ")" : ""),
          note ? "Notes: " + note : "",
          ""
        ].filter(Boolean);

        const itemLines = cartItems.map((item, idx) => {
          const unitPrice = formatMoney(item.price || 0);
          const lineTotal = formatMoney((item.price || 0) * (item.qty || 0));
          const lines = [
            (idx + 1) + ") " + (item.name || ""),
            "   SKU: " + (item.sku || "")
          ];
          if (item.packSize) {
            lines.push("   Pack: " + item.packSize);
          }
          lines.push("   Qty: " + (item.qty || 0));
          lines.push("   Unit: " + unitPrice);
          lines.push("   Line Total: " + lineTotal);
          return lines.join("\n");
        });

        const totals = computeTotals();

        const footer = [
          "",
          "SUBTOTAL: " + formatMoney(totals.subtotal),
          "SALES TAX (7.375%): " + formatMoney(totals.taxAmount),
          "TOTAL (with tax): " + formatMoney(totals.grandTotal),
          "",
          "Thanks for your business!",
          "218 Supply"
        ];

        return headerLines.concat(itemLines).concat(footer).join("\n");
      }

      function createPdfDoc() {
        if (!window.jspdf || !window.jspdf.jsPDF) return;
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: "pt", format: "letter" });

        const pageWidth  = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const margin     = 36;
        const headerH    = 72;

        // Top header bar: smooth red â†’ green gradient to match app header
        const steps = 40;
        for (let i = 0; i < steps; i++) {
          const t = i / (steps - 1);
          const r = Math.round(122 + (31 - 122) * t); // #7a1b1b -> #1f4d32
          const g = Math.round(27  + (77 - 27)  * t);
          const b = Math.round(27  + (50 - 27)  * t);
          const x = (pageWidth / steps) * i;
          doc.setFillColor(r, g, b);
          doc.rect(x, 0, pageWidth / steps + 1, headerH, "F");
        }

        // Header text
        doc.setTextColor(255, 255, 255);
        doc.setFont("helvetica", "bold");
        doc.setFontSize(18);
        doc.text("218 SUPPLY", margin, 28);
        doc.setFont("helvetica", "normal");
        doc.setFontSize(11);
        doc.text("Purchase Order", margin, 46);

        // Order info
        doc.setTextColor(0, 0, 0);
        doc.setFont("helvetica", "normal");
        doc.setFontSize(11);

        let y = headerH + 28;

        const customerId = customerSelect.value || "";
        const customerObj = (window.customers || []).find(c => c.id === customerId);
        const customerName = customerObj?.name || "";
        const note = orderNoteInput.value || "";
        const now = new Date();
        const dateStr = now.toISOString().slice(0, 10);
        const salesperson = currentUser || "Not signed in";
        const salespersonEmail = currentUserProfile && currentUserProfile.email ? currentUserProfile.email : "";

        const infoLines = [
          `Date: ${dateStr}`,
          `Customer: ${customerName || "N/A"}${customerId ? " (" + customerId + ")" : ""}`,
          `Salesperson: ${salesperson}`,
        ];
        if (salespersonEmail) {
          infoLines.push(`Salesperson Email: ${salespersonEmail}`);
        }
        if (note) {
          infoLines.push("Notes: " + note);
        }

        infoLines.forEach(line => {
          doc.text(line, margin, y);
          y += 16;
        });

        y += 4;

        // Table headers
        const colWidths = {
          sku:   80,
          name:  pageWidth - margin * 2 - 80 - 50 - 70 - 70 - 10,
          qty:   50,
          price: 70,
          total: 70
        };

        doc.setFont("helvetica", "bold");
        doc.text("SKU",   margin, y);
        doc.text("Product", margin + colWidths.sku, y);
        doc.text("Qty",   margin + colWidths.sku + colWidths.name + 4, y);
        doc.text("Price", margin + colWidths.sku + colWidths.name + colWidths.qty + 4, y);
        doc.text("Line Total", margin + colWidths.sku + colWidths.name + colWidths.qty + colWidths.price + 4, y);

        y += 8;
        doc.setDrawColor(200);
        doc.line(margin, y, pageWidth - margin, y);
        y += 14;
        doc.setFont("helvetica", "normal");

        let subtotal = 0;
        const lineHeightBase = 14;

        cartItems.forEach(item => {
          if (y > pageHeight - 72) {
            doc.addPage();
            y = margin;
          }

          const lineTotal = item.price * item.qty;
          subtotal += lineTotal;

          const nameText = item.name + (item.packSize ? " (" + item.packSize + ")" : "");
          const wrappedName = doc.splitTextToSize(nameText, colWidths.name);

          const rowHeight = lineHeightBase * wrappedName.length;

          let x = margin;

          doc.text(String(item.sku), x, y);
          x += colWidths.sku;

          doc.text(wrappedName, x, y);

          x = margin + colWidths.sku + colWidths.name + 4;
          doc.text(String(item.qty), x, y);

          x += colWidths.qty;
          doc.text(formatMoney(item.price), x, y);

          x += colWidths.price;
          doc.text(formatMoney(lineTotal), x, y);

          y += rowHeight;
        });

        // Totals
        const taxRate = 0.07375;
        const taxAmount = subtotal * taxRate;
        const grandTotal = subtotal + taxAmount;

        y += 10;
        if (y > pageHeight - 72) {
          doc.addPage();
          y = margin;
        }

        const labelX = pageWidth - margin - 140;
        const amountX = pageWidth - margin;

        doc.setFont("helvetica", "bold");
        doc.text("Subtotal:", labelX, y, { align: "right" });
        doc.text(formatMoney(subtotal), amountX, y, { align: "right" });
        y += 16;

        doc.text("Sales Tax (7.375%):", labelX, y, { align: "right" });
        doc.text(formatMoney(taxAmount), amountX, y, { align: "right" });
        y += 16;

        doc.text("Total:", labelX, y, { align: "right" });
        doc.text(formatMoney(grandTotal), amountX, y, { align: "right" });

        y += 28;
        doc.setFont("helvetica", "normal");
        doc.setFontSize(9);
        doc.text("Thank you for your business â€“ 218 Supply", margin, y);

        const filename = `PO-${customerId || "NO-CUSTOMER"}-${dateStr}.pdf`;
        return { doc, filename };
      }

      function getOrCreateCustomerProfile(customerId) {
        if (!customerId) return null;
        if (!customerProfiles || typeof customerProfiles !== "object") {
          customerProfiles = {};
        }
        if (!customerProfiles[customerId]) {
          const baseCust = (window.customers || []).find(c => c.id === customerId) || {};
          customerProfiles[customerId] = {
            id: customerId,
            customerName: baseCust.name || "",
            contactName: "",
            phone: "",
            email: "",
            notes: "",
            taxExempt: false,
            priceLevel: "",
            billingStreet: "",
            billingCity: "",
            billingState: "",
            billingZip: "",
            labels: "",
            orders: []
          };
        }
        return customerProfiles[customerId];
      }

      function computeProfileStats(profile) {
        if (!profile || !Array.isArray(profile.orders)) {
          return {
            lastOrderDate: null,
            totalThisYear: 0
          };
        }
        let lastOrderDate = null;
        let totalThisYear = 0;
        const currentYear = String(new Date().getFullYear());

        profile.orders.forEach(o => {
          if (o.date && (!lastOrderDate || o.date > lastOrderDate)) {
            lastOrderDate = o.date;
          }
          if (o.date && o.date.startsWith(currentYear) && typeof o.total === "number") {
            totalThisYear += o.total;
          }
        });

        return { lastOrderDate, totalThisYear };
      }

      function renderCustomerProfileOrders(profile) {
        customerProfileOrdersEl.innerHTML = "";
        if (!profile || !Array.isArray(profile.orders) || !profile.orders.length) {
          const empty = document.createElement("div");
          empty.className = "muted";
          empty.textContent = "No orders saved for this customer on this device yet.";
          customerProfileOrdersEl.appendChild(empty);
          return;
        }

        const list = document.createElement("div");

        profile.orders
          .slice()
          .sort((a, b) => (a.date || "").localeCompare(b.date || ""))
          .forEach((order) => {
            const row = document.createElement("div");
            row.style.padding = "4px 0";
            row.style.borderBottom = "1px solid #e5e7eb";

            const line1 = document.createElement("div");
            line1.style.fontWeight = "600";
            const dateLabel = order.date || "Unknown date";
            const itemsCount = Array.isArray(order.items) ? order.items.length : 0;
            const totalStr = typeof order.total === "number" ? formatMoney(order.total) : "$0.00";
            line1.textContent = `${dateLabel} â€“ Tap to view â€“ ${totalStr}`;

            const line2 = document.createElement("div");
            line2.className = "muted";
            const note = order.note ? `Notes: ${order.note}` : "";
            line2.textContent = note;

            row.appendChild(line1);
            if (note) {
              row.appendChild(line2);
            }
            list.appendChild(row);
          });

        customerProfileOrdersEl.appendChild(list);
      }

      function fillCustomerProfileModal(customerId) {
        const customer = (window.customers || []).find(c => c.id === customerId);
        const profile = getOrCreateCustomerProfile(customerId);
        currentProfileCustomerId = customerId;

        profile.customerName = (customer && customer.name) || profile.customerName || "";

        // Autofill city/state from customer if empty in profile
        if (customer) {
          if (!profile.billingCity && customer.city) {
            profile.billingCity = customer.city;
          }
          if (!profile.billingState && customer.state) {
            profile.billingState = customer.state;
          }
        }

        const stats = computeProfileStats(profile);
        const summaryParts = [];
        summaryParts.push(`Customer ID: ${customerId}`);
        if (customer && (customer.city || customer.state)) {
          const loc = (customer.city || "") + (customer.state ? (customer.city ? ", " : "") + customer.state : "");
          if (loc) summaryParts.push(`Location: ${loc}`);
        }
        if (stats.lastOrderDate) {
          summaryParts.push(`Last order: ${stats.lastOrderDate}`);
        } else {
          summaryParts.push("Last order: none yet");
        }
        summaryParts.push(`Total this year: ${formatMoney(stats.totalThisYear)}`);
        customerProfileSummary.textContent = summaryParts.join(" â€¢ ");

        profileContactNameInput.value = profile.contactName || "";
        profilePhoneInput.value       = profile.phone || "";
        profileEmailInput.value       = profile.email || "";
        profileNotesInput.value       = profile.notes || "";
        profilePriceLevelInput.value  = profile.priceLevel || "";
        profileTaxExemptInput.checked = !!profile.taxExempt;

        billingStreetInput.value = profile.billingStreet || "";
        billingCityInput.value   = profile.billingCity || "";
        billingStateInput.value  = profile.billingState || "";
        billingZipInput.value    = profile.billingZip || "";

        profileLabelsInput.value = profile.labels || "";

        renderCustomerProfileOrders(profile);

        customerProfileModalBackdrop.classList.remove("hidden");
      }

      function saveCustomerProfileFromModal() {
        if (!currentProfileCustomerId) return;
        const profile = getOrCreateCustomerProfile(currentProfileCustomerId);
        if (!profile) return;

        profile.contactName   = profileContactNameInput.value.trim();
        profile.phone         = profilePhoneInput.value.trim();
        profile.email         = profileEmailInput.value.trim();
        profile.notes         = profileNotesInput.value.trim();
        profile.priceLevel    = profilePriceLevelInput.value.trim();
        profile.taxExempt     = !!profileTaxExemptInput.checked;

        profile.billingStreet = billingStreetInput.value.trim();
        profile.billingCity   = billingCityInput.value.trim();
        profile.billingState  = billingStateInput.value.trim();
        profile.billingZip    = billingZipInput.value.trim();

        profile.labels        = profileLabelsInput.value.trim();

        saveCustomerProfiles();

        const customer = (window.customers || []).find(c => c.id === currentProfileCustomerId);
        const stats = computeProfileStats(profile);
        const summaryParts = [];
        summaryParts.push(`Customer ID: ${currentProfileCustomerId}`);
        if (customer && (customer.city || customer.state)) {
          const loc = (customer.city || "") + (customer.state ? (customer.city ? ", " : "") + customer.state : "");
          if (loc) summaryParts.push(`Location: ${loc}`);
        }
        if (stats.lastOrderDate) {
          summaryParts.push(`Last order: ${stats.lastOrderDate}`);
        } else {
          summaryParts.push("Last order: none yet");
        }
        summaryParts.push(`Total this year: ${formatMoney(stats.totalThisYear)}`);
        customerProfileSummary.textContent = summaryParts.join(" â€¢ ");
      }

      function closeCustomerProfileModal() {
        currentProfileCustomerId = null;
        customerProfileModalBackdrop.classList.add("hidden");
      }

      function saveOrderToCustomerProfile() {
        const customerId = customerSelect.value || "";
        if (!customerId) return;
        const profile = getOrCreateCustomerProfile(customerId);
        if (!profile) return;

        const now = new Date();
        const dateStr = now.toISOString().slice(0, 10);
        const totals = computeTotals();
        const orderNote = orderNoteInput.value || "";

        const itemsSnapshot = cartItems.map(item => ({
          sku: item.sku,
          name: item.name,
          packSize: item.packSize,
          price: item.price,
          qty: item.qty
        }));

        const customerObj = (window.customers || []).find(c => c.id === customerId);
        if (customerObj && customerObj.name) {
          profile.customerName = customerObj.name;
        }

        if (!Array.isArray(profile.orders)) profile.orders = [];
        profile.orders.push({
          date: dateStr,
          note: orderNote,
          items: itemsSnapshot,
          subtotal: totals.subtotal,
          taxAmount: totals.taxAmount,
          total: totals.grandTotal
        });

        saveCustomerProfiles();
      }

      let lastPoText = "";
      function showPoModal(poText) {
        lastPoText = poText || buildPoText();
        const result = createPdfDoc();
        if (!result) return;
        const { doc } = result;
        const dataUrl = doc.output("dataurlstring");
        if (poPreviewFrame) {
          poPreviewFrame.src = dataUrl;
        }
        poModalBackdrop.classList.remove("hidden");
      }

      function hidePoModal() {
        poModalBackdrop.classList.add("hidden");
      }

      function openCustomerModal() {
        customerModalBackdrop.classList.remove("hidden");
        newCustomerNameInput.focus();
      }

      // ---- event wiring ----

      loadLocalData();
      populateCustomers();
      buildCategories();
      if (productSearchInput) {
        productSearchInput.addEventListener("input", () => {
          showProductsForCategory();
        });
      }
      loadCartState();
      renderCart();
      renderCustomerList();
      renderCustomerGroupsOverview();

      addItemBtn.disabled = true;
      generateSummaryBtn.disabled = true;

      customerSelect.addEventListener("change", () => {
        const hasCustomer = !!customerSelect.value;
        addItemBtn.disabled = !hasCustomer;
        generateSummaryBtn.disabled = !hasCustomer;
      });

      // sign in
      signInBtn.addEventListener("click", () => {
        loginModalBackdrop.classList.remove("hidden");
        loginUsernameInput.focus();
      });
      cancelLoginBtn.addEventListener("click", () => {
        loginModalBackdrop.classList.add("hidden");
        loginUsernameInput.value = "";
        loginPasswordInput.value = "";
      });
      confirmLoginBtn.addEventListener("click", () => {
        const username = loginUsernameInput.value.trim();
        const password = loginPasswordInput.value;
        if (!username) {
          alert("Enter a username.");
          return;
        }

        if (!userProfiles) {
          userProfiles = {};
        }
        let profile = userProfiles[username];

        if (profile && profile.password) {
          if (profile.password !== password) {
            alert("Incorrect password for this user.");
            return;
          }
        } else {
          profile = profile || { username, email: "", password: "" };
          profile.password = password || "";
          userProfiles[username] = profile;
          saveUserProfiles();
        }

        currentUser = username;
        currentUserProfile = profile;
        try {
          localStorage.setItem("orderpadUser", username);
          localStorage.setItem("orderpadCurrentUser", username);
        } catch {}

        loginModalBackdrop.classList.add("hidden");
        loginUsernameInput.value = "";
        loginPasswordInput.value = "";
        showSignedInState();
      });

      // settings
      settingsBtn.addEventListener("click", () => {
        if (!currentUser) {
          alert("Sign in first to open settings.");
          return;
        }
        if (!currentUserProfile) {
          currentUserProfile = { username: currentUser, email: "", password: "" };
          userProfiles[currentUser] = currentUserProfile;
        }
        settingsUsernameInput.value = currentUserProfile.username || currentUser;
        settingsEmailInput.value = currentUserProfile.email || "";
        settingsCurrentPassword.value = "";
        settingsNewPassword.value = "";
        settingsConfirmPassword.value = "";
        settingsModalBackdrop.classList.remove("hidden");
      });

      function closeSettingsModal() {
        settingsModalBackdrop.classList.add("hidden");
      }

      cancelSettingsBtn.addEventListener("click", closeSettingsModal);

      saveSettingsBtn.addEventListener("click", () => {
        if (!currentUser) {
          alert("Sign in first.");
          return;
        }
        const profile = currentUserProfile || { username: currentUser, email: "", password: "" };

        const newEmail = settingsEmailInput.value.trim();
        profile.email = newEmail;

        const curPass = settingsCurrentPassword.value;
        const newPass = settingsNewPassword.value;
        const confPass = settingsConfirmPassword.value;

        if (curPass || newPass || confPass) {
          if (profile.password && curPass !== profile.password) {
            alert("Current password is incorrect.");
            return;
          }
          if (newPass !== confPass) {
            alert("New passwords do not match.");
            return;
          }
          profile.password = newPass;
        }

        userProfiles[currentUser] = profile;
        currentUserProfile = profile;
        saveUserProfiles();
        closeSettingsModal();
        showSignedInState();
        alert("Settings saved on this device.");
      });

      signOutBtn.addEventListener("click", () => {
        if (!currentUser) {
          closeSettingsModal();
          return;
        }
        if (!confirm("Sign out on this device?")) return;
        currentUser = null;
        currentUserProfile = null;
        try {
          localStorage.removeItem("orderpadUser");
          localStorage.removeItem("orderpadCurrentUser");
        } catch {}
        settingsEmailInput.value = "";
        closeSettingsModal();
        showSignedInState();
      });

      // start new order
      
      // start new order
      startOrderBtn.addEventListener("click", () => {
        if (!currentUser) {
          loginModalBackdrop.classList.remove("hidden");
          loginUsernameInput.focus();
          return;
        }

        const desktopFlow = window.matchMedia && window.matchMedia("(min-width: 1024px)").matches;

        // Desktop: keep the Start button visible (no "page change"), just reveal next step
        if (desktopFlow) {
          startOptionsCard.classList.remove("hidden");
          // keep other panels hidden until needed
          customerListsPage.classList.add("hidden");
          customerSelectPage.classList.add("hidden");
          addItemPage.classList.add("hidden");
          orderMain.classList.add("hidden");
          return;
        }

        // Mobile: keep existing "step" flow
        startCard.classList.add("hidden");
        orderMain.classList.add("hidden");
        addItemPage.classList.add("hidden");
        customerSelectPage.classList.add("hidden");
        customerListsPage.classList.add("hidden");
        startOptionsCard.classList.remove("hidden");
      });

      if (startSelectCustomerBtn) {
        startSelectCustomerBtn.addEventListener("click", () => {
          const desktopFlow = window.matchMedia && window.matchMedia("(min-width: 1024px)").matches;

          // Always show customer selection list
          customerSelectPage.classList.remove("hidden");
          customerSearchInput.value = "";
          renderCustomerList();

          if (desktopFlow) {
            // Desktop: keep options visible; don't hide the start button
            customerListsPage.classList.add("hidden");
            return;
          }

          // Mobile: step flow
          startOptionsCard.classList.add("hidden");
          customerListsPage.classList.add("hidden");
          orderMain.classList.add("hidden");
          addItemPage.classList.add("hidden");
        });
      }

      
      if (startCustomerListsBtn) {
        startCustomerListsBtn.addEventListener("click", () => {
          // Show Customer Lists in the same "options" column
          openCustomerListsPage();
        });
      }

      if (backFromCustomerListsBtn) {
        backFromCustomerListsBtn.addEventListener("click", () => {
          customerListsPage.classList.add("hidden");
          if (customerListGroupContainer) {
            customerListGroupContainer.classList.add("hidden");
          }
          startOptionsCard.classList.remove("hidden");
        });
      }

      if (editCustomerGroupBtn) {
        editCustomerGroupBtn.addEventListener("click", () => {
          openCustomerGroupModal();
        });
      }

      if (customerGroupSearchInput) {
        customerGroupSearchInput.addEventListener("input", () => {
          renderCustomerGroupSelectList();
        });
      }

      if (cancelCustomerGroupBtn) {
        cancelCustomerGroupBtn.addEventListener("click", () => {
          closeCustomerGroupModal();
        });
      }

      if (saveCustomerGroupBtn) {
        saveCustomerGroupBtn.addEventListener("click", () => {
          if (!activeGroupDay) {
            closeCustomerGroupModal();
            return;
          }
          const checkboxes = customerGroupSelectList.querySelectorAll(".customer-group-checkbox");
          const selectedIds = [];
          checkboxes.forEach(cb => {
            if (cb.checked && cb.dataset.customerId) {
              selectedIds.push(cb.dataset.customerId);
            }
          });
          customerGroups[activeGroupDay] = selectedIds;
          saveCustomerGroups();
          closeCustomerGroupModal();
          renderCustomerGroupsOverview();
          openCustomerGroup(activeGroupDay);
        });
      }

      // change customer
      if (changeCustomerBtn) {
        changeCustomerBtn.addEventListener("click", () => {
          if (!currentUser) {
            loginModalBackdrop.classList.remove("hidden");
            loginUsernameInput.focus();
            return;
          }
          orderMain.classList.add("hidden");
          addItemPage.classList.add("hidden");
          customerSelectPage.classList.remove("hidden");
          customerSearchInput.value = "";
          renderCustomerList();
          // no auto-focus; avoid popping mobile keyboard

        });
      }

      customerSearchInput.addEventListener("input", () => {
        renderCustomerList();
      });

      // add item page
      addItemBtn.addEventListener("click", () => {
        if (!customerSelect.value) {
          alert("Select a customer first.");
          return;
        }
        orderMain.classList.add("hidden");
        addItemPage.classList.remove("hidden");
        // Do not auto-open any category; let the user choose which one to expand.
      });

      backToOrderBtn.addEventListener("click", () => {
        addItemPage.classList.add("hidden");
        orderMain.classList.remove("hidden");
      });

      clearOrderBtn.addEventListener("click", clearOrder);

      generateSummaryBtn.addEventListener("click", () => {
        if (!customerSelect.value) {
          alert("Select a customer first.");
          return;
        }
        if (!cartItems.length) {
          alert("Add at least one item to the order.");
          return;
        }
        saveOrderToCustomerProfile();
        const poText = buildPoText();
        showPoModal(poText);
      });

      closePoModalBtn.addEventListener("click", hidePoModal);

      downloadPoBtn.addEventListener("click", () => {
        const result = createPdfDoc();
        if (!result) return;
        const { doc, filename } = result;
        doc.save(filename);
        clearCartState();
      });

      emailPoBtn.addEventListener("click", () => {
        const subject = encodeURIComponent("New Purchase Order from 218 Supply Order Pad");
        const body = encodeURIComponent(lastPoText || buildPoText());
        window.location.href = "mailto:sales@218supply.com?subject=" + subject + "&body=" + body;
      });

      // Add new customer
      addCustomerFromListBtn.addEventListener("click", openCustomerModal);
      if (addCustomerBtn) {
        addCustomerBtn.addEventListener("click", openCustomerModal);
      }

      cancelCustomerBtn.addEventListener("click", () => {
        customerModalBackdrop.classList.add("hidden");
        newCustomerNameInput.value = "";
        newCustomerIdInput.value = "";
      });

      saveCustomerBtn.addEventListener("click", () => {
        const name = newCustomerNameInput.value.trim();
        const id   = newCustomerIdInput.value.trim() || "CUST-" + String((window.customers || []).length + 1000);
        if (!name) {
          alert("Customer name is required.");
          return;
        }
        const newCust = { id, name };
        window.customers.push(newCust);

        const base = [];
        try {
          const existing = localStorage.getItem("orderpadExtraCustomers");
          if (existing) {
            const parsed = JSON.parse(existing);
            if (Array.isArray(parsed)) base.push(...parsed);
          }
        } catch {}
        base.push(newCust);
        saveExtraCustomers(base);

        populateCustomers();
        renderCustomerList();

        customerSelect.value = id;
        customerModalBackdrop.classList.add("hidden");
        newCustomerNameInput.value = "";
        newCustomerIdInput.value = "";

        selectCustomerAndGoToOrder(id);
      });

      // Edit customer
      function openEditCustomerModal(customer) {
        if (!customer) return;
        editingCustomerObj = customer;
        editCustomerNameInput.value = customer.name || "";
        editCustomerIdInput.value = customer.id || "";
        editCustomerCityInput.value = customer.city || "";
        editCustomerStateInput.value = customer.state || "";
        customerEditModalBackdrop.classList.remove("hidden");
        editCustomerNameInput.focus();
      }

      function closeEditCustomerModal() {
        editingCustomerObj = null;
        customerEditModalBackdrop.classList.add("hidden");
      }

      if (editCustomerBtn) {
        editCustomerBtn.addEventListener("click", () => {
          const id = customerSelect.value;
          if (!id) return;
          const customer = (window.customers || []).find((c) => c.id === id);
          if (customer) {
            openEditCustomerModal(customer);
          }
        });
      }

      cancelEditCustomerBtn.addEventListener("click", (evt) => {
        evt.preventDefault();
        closeEditCustomerModal();
      });

      saveEditCustomerBtn.addEventListener("click", (evt) => {
        evt.preventDefault();
        if (!editingCustomerObj) {
          closeEditCustomerModal();
          return;
        }
        const newName  = editCustomerNameInput.value.trim();
        const newId    = editCustomerIdInput.value.trim();
        const newCity  = editCustomerCityInput.value.trim();
        const newState = editCustomerStateInput.value.trim();

        if (newName) editingCustomerObj.name = newName;
        if (newId)   editingCustomerObj.id   = newId;
        editingCustomerObj.city  = newCity;
        editingCustomerObj.state = newState;

        saveCustomerEditFor(editingCustomerObj.id, {
          name: editingCustomerObj.name,
          city: editingCustomerObj.city,
          state: editingCustomerObj.state
        });

        populateCustomers();
        const updatedCustomer = (window.customers || []).find((c) => c.id === customerSelect.value);
        if (updatedCustomer) {
          orderCustomerDisplay.textContent = updatedCustomer.name || "No customer selected";
        }

        closeEditCustomerModal();
      });

      // Customer profile
      if (customerProfileBtn) {
        customerProfileBtn.addEventListener("click", () => {
          const id = customerSelect.value;
          if (!id) {
            alert("Select a customer first.");
            return;
          }
          fillCustomerProfileModal(id);
        });
      }

      closeCustomerProfileBtn.addEventListener("click", (evt) => {
        evt.preventDefault();
        closeCustomerProfileModal();
      });

      saveCustomerProfileBtn.addEventListener("click", (evt) => {
        evt.preventDefault();
        saveCustomerProfileFromModal();
        alert("Customer profile saved on this device.");
      });

      // Add new product
      document.getElementById("addProductBtn").addEventListener("click", () => {
        productModalBackdrop.classList.remove("hidden");
        newProdNameInput.focus();
      });
      cancelProductBtn.addEventListener("click", () => {
        productModalBackdrop.classList.add("hidden");
        newProdNameInput.value = "";
        newProdSkuInput.value = "";
        newProdCategoryInput.value = "";
        newProdPackInput.value = "";
        newProdPriceInput.value = "";
      });
      saveProductBtn.addEventListener("click", () => {
        const name = newProdNameInput.value.trim();
                const sku  = newProdSkuInput.value.trim() || "SKU-" + String((window.products || []).length + 1000);
        const pack = newProdPackInput.value.trim();
        const price = parseFloat(newProdPriceInput.value) || 0;
        if (!name) {
          alert("Product name is required.");
          return;
        }
        const mainCategory = currentMainCategory || inferMainCategoryFromLegacy("", name);
        const subcategory = newProdCategoryInput.value.trim();
        const newProd = { sku, name, category: mainCategory, subcategory, packSize: pack, price };
        window.products.push(newProd);

        const base = [];
        try {
          const existing = localStorage.getItem("orderpadExtraProducts");
          if (existing) {
            const parsed = JSON.parse(existing);
            if (Array.isArray(parsed)) base.push(...parsed);
          }
        } catch {}
        base.push(newProd);
        saveExtraProducts(base);

        buildCategories();
        productModalBackdrop.classList.add("hidden");
        newProdNameInput.value = "";
        newProdSkuInput.value = "";
        newProdCategoryInput.value = "";
        newProdPackInput.value = "";
        newProdPriceInput.value = "";
      });
    });
  </script>

  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", function () {
        navigator.serviceWorker.register("/sw.js").catch(function (err) {
          console.log("Service worker registration failed:", err);
        });
      });
    }
  

  // Keep counts removed even if the UI re-renders categories/products
  document.addEventListener('DOMContentLoaded', () => {
    stripItemCountsEverywhere();
    const mo = new MutationObserver(() => stripItemCountsEverywhere());
    mo.observe(document.body, {subtree:true, childList:true, characterData:true});
  });

</script>
</body>
</html>
